"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _memoizeOne = _interopRequireDefault(require("memoize-one"));

var _react = _interopRequireDefault(require("react"));

var browser = _interopRequireWildcard(require("./browser"));

var _best = _interopRequireDefault(require("./best"));

var _Context = _interopRequireDefault(require("./Context"));

var _ScrollSpy = _interopRequireDefault(require("./ScrollSpy"));

var _ScrollTo = _interopRequireDefault(require("./ScrollTo"));

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = Object.defineProperty && Object.getOwnPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : {}; if (desc.get || desc.set) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } } newObj.default = obj; return newObj; } }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _typeof(obj) { if (typeof Symbol === "function" && typeof Symbol.iterator === "symbol") { _typeof = function _typeof(obj) { return typeof obj; }; } else { _typeof = function _typeof(obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; }; } return _typeof(obj); }

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(source, true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(source).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } }

function _createClass(Constructor, protoProps, staticProps) { if (protoProps) _defineProperties(Constructor.prototype, protoProps); if (staticProps) _defineProperties(Constructor, staticProps); return Constructor; }

function _possibleConstructorReturn(self, call) { if (call && (_typeof(call) === "object" || typeof call === "function")) { return call; } return _assertThisInitialized(self); }

function _getPrototypeOf(o) { _getPrototypeOf = Object.setPrototypeOf ? Object.getPrototypeOf : function _getPrototypeOf(o) { return o.__proto__ || Object.getPrototypeOf(o); }; return _getPrototypeOf(o); }

function _assertThisInitialized(self) { if (self === void 0) { throw new ReferenceError("this hasn't been initialised - super() hasn't been called"); } return self; }

function _inherits(subClass, superClass) { if (typeof superClass !== "function" && superClass !== null) { throw new TypeError("Super expression must either be null or a function"); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, writable: true, configurable: true } }); if (superClass) _setPrototypeOf(subClass, superClass); }

function _setPrototypeOf(o, p) { _setPrototypeOf = Object.setPrototypeOf || function _setPrototypeOf(o, p) { o.__proto__ = p; return o; }; return _setPrototypeOf(o, p); }

function getView(dir) {
  var _ref = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {},
      scrollable = _ref.current;

  var _ref2 = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : {},
      itemContainer = _ref2.current;

  var scrollingTo = arguments.length > 3 ? arguments[3] : undefined;
  var rtl = dir === 'rtl';

  if (itemContainer && scrollable) {
    var scrollLeft = scrollingTo || scrollable.scrollLeft;
    var trueScrollLeft = rtl ? browser.chrome ? scrollLeft - (scrollable.scrollWidth - scrollable.offsetWidth) : browser.edgeUWP || browser.internetExplorer ? -scrollLeft : scrollLeft : scrollLeft;
    var items = itemContainer.children; // This will enumerate <li> inside <FilmStrip>

    var scrollCenter = trueScrollLeft + scrollable.offsetWidth / 2;
    var index = (0, _best.default)([].slice.call(items), function (item) {
      var offsetCenter = item.offsetLeft + item.offsetWidth / 2;
      return 1 / Math.abs(scrollCenter - offsetCenter);
    });

    if (~index) {
      var item = items[index];
      var offsetCenter = item.offsetLeft + item.offsetWidth / 2;
      var indexFraction = index + (scrollCenter - offsetCenter) / item.offsetWidth * (rtl ? -1 : 1); // We "fix" indexFraction if the viewport is at the start/end of the content
      // This is to simplify code that use Math.round(indexFraction) to find the scrollable index
      // if (scrollLeft === 0) {
      //   indexFraction = 0;
      // } else if (scrollLeft >= scrollable.scrollWidth - scrollable.offsetWidth) {
      //   indexFraction = items.length - 1;
      // } else if (indexFraction % 1 > .99 || indexFraction % 1 < .01) {
      //   indexFraction = Math.round(indexFraction);
      // }

      if (indexFraction % 1 > .99 || indexFraction % 1 < .01) {
        indexFraction = Math.round(indexFraction);
      }

      var selectedIndex;

      if (Math.abs(trueScrollLeft) < 1) {
        selectedIndex = 0;
      } else if (rtl ? trueScrollLeft <= scrollable.offsetWidth - scrollable.scrollWidth : trueScrollLeft >= scrollable.scrollWidth - scrollable.offsetWidth) {
        selectedIndex = items.length - 1;
      } else {
        selectedIndex = Math.round(indexFraction);
      }

      return {
        index: selectedIndex,
        indexFraction: indexFraction
      };
    }
  }
}

function getScrollLeft(dir) {
  var _ref3 = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {},
      scrollable = _ref3.current;

  var _ref4 = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : {},
      itemContainer = _ref4.current;

  var index = arguments.length > 3 ? arguments[3] : undefined;
  var rtl = dir === 'rtl';

  if (itemContainer && scrollable) {
    var items = itemContainer.children; // This will enumerate <li> inside <FilmStrip>

    var item = items[Math.max(0, Math.min(items.length - 1, index))];

    if (item) {
      if (scrollable.offsetWidth === scrollable.scrollWidth) {
        return 0;
      }

      var result = item.offsetLeft + (item.offsetWidth - scrollable.offsetWidth) / 2;

      if (rtl) {
        result = Math.min(result, 0);
        result = Math.max(result, scrollable.offsetWidth - scrollable.scrollWidth);
      } else {
        result = Math.max(result, 0);
        result = Math.min(result, scrollable.scrollWidth - scrollable.offsetWidth);
      }

      if (rtl) {
        if (browser.chrome) {
          result += scrollable.scrollWidth - scrollable.offsetWidth;
        } else if (browser.edgeUWP || browser.internetExplorer) {
          result = -result;
        }
      }

      return result;
    }
  }
}

var FilmComposer =
/*#__PURE__*/
function (_React$Component) {
  _inherits(FilmComposer, _React$Component);

  function FilmComposer(props) {
    var _this;

    _classCallCheck(this, FilmComposer);

    _this = _possibleConstructorReturn(this, _getPrototypeOf(FilmComposer).call(this, props));
    _this.handleScroll = _this.handleScroll.bind(_assertThisInitialized(_this));
    _this.handleScrollToEnd = _this.handleScrollToEnd.bind(_assertThisInitialized(_this));
    _this.itemContainerRef = _react.default.createRef();
    _this.scrollableRef = _react.default.createRef();
    _this.mergeContext = (0, _memoizeOne.default)(function (state, dir) {
      var numItems = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : 0;
      return _objectSpread({}, state, {
        dir: dir,
        numItems: numItems
      });
    });
    _this.state = {
      context: {
        itemContainerRef: _this.itemContainerRef,
        scrollableRef: _this.scrollableRef,
        scrollBarPercentage: '0%',
        scrollBarWidth: '0%',
        scrolling: false,
        scrollTo: function scrollTo(_scrollTo) {
          _this.setState(function (state) {
            var view = getView(_this.props.dir, _this.scrollableRef, _this.itemContainerRef, state.scrollLeft);

            if (view) {
              var index = view.index,
                  indexFraction = view.indexFraction;

              var targetIndex = _scrollTo({
                index: index,
                indexFraction: indexFraction
              });

              if (typeof targetIndex === 'number') {
                return {
                  scrollLeft: getScrollLeft(_this.props.dir, _this.scrollableRef, _this.itemContainerRef, targetIndex)
                };
              }
            }
          });
        },
        scrollOneLeft: function scrollOneLeft() {
          if (_this.props.dir === 'rtl') {
            _this.state.context.scrollTo(function (_ref5) {
              var indexFraction = _ref5.indexFraction;
              return Math.floor(indexFraction) + 1;
            });
          } else {
            _this.state.context.scrollTo(function (_ref6) {
              var indexFraction = _ref6.indexFraction;
              return Math.ceil(indexFraction) - 1;
            });
          }
        },
        scrollOneRight: function scrollOneRight() {
          if (_this.props.dir === 'rtl') {
            _this.state.context.scrollTo(function (_ref7) {
              var indexFraction = _ref7.indexFraction;
              return Math.ceil(indexFraction) - 1;
            });
          } else {
            _this.state.context.scrollTo(function (_ref8) {
              var indexFraction = _ref8.indexFraction;
              return Math.floor(indexFraction) + 1;
            });
          }
        }
      },
      scrollLeft: null
    };
    return _this;
  }

  _createClass(FilmComposer, [{
    key: "componentWillUnmount",
    value: function componentWillUnmount() {
      clearTimeout(this.scrollTimeout);
    }
  }, {
    key: "handleScroll",
    value: function handleScroll(_ref9) {
      var _this2 = this;

      var scrollBarPercentage = _ref9.fraction,
          initial = _ref9.initial,
          scrollBarWidth = _ref9.width;
      this.setState(function (_ref10) {
        var context = _ref10.context,
            scrollLeft = _ref10.scrollLeft;
        var view = getView(_this2.props.dir, _this2.scrollableRef, _this2.itemContainerRef, scrollLeft);

        if (view) {
          var index = view.index,
              indexFraction = view.indexFraction;
          return {
            context: _objectSpread({}, context, {
              index: index,
              indexFraction: indexFraction,
              scrolling: !initial,
              scrollBarPercentage: scrollBarPercentage,
              scrollBarWidth: scrollBarWidth
            })
          };
        }
      });

      if (!initial) {
        clearTimeout(this.scrollTimeout);
        this.scrollTimeout = setTimeout(function () {
          _this2.setState(function (_ref11) {
            var context = _ref11.context;
            return {
              context: _objectSpread({}, context, {
                scrolling: false
              })
            };
          });
        }, 500);
      }
    }
  }, {
    key: "handleScrollToEnd",
    value: function handleScrollToEnd() {
      this.setState(function () {
        return {
          scrollLeft: null
        };
      });
    }
  }, {
    key: "render",
    value: function render() {
      var _this$props = this.props,
          children = _this$props.children,
          dir = _this$props.dir,
          numItems = _this$props.numItems,
          scrollableRef = this.scrollableRef,
          _this$state = this.state,
          context = _this$state.context,
          scrollLeft = _this$state.scrollLeft;
      return _react.default.createElement(_Context.default.Provider, {
        value: this.mergeContext(context, dir, numItems)
      }, children, _react.default.createElement(_ScrollSpy.default, {
        onScroll: this.handleScroll,
        targetRef: scrollableRef
      }), typeof scrollLeft === 'number' && _react.default.createElement(_ScrollTo.default, {
        onEnd: this.handleScrollToEnd,
        scrollLeft: scrollLeft,
        targetRef: scrollableRef
      }));
    }
  }]);

  return FilmComposer;
}(_react.default.Component);

exports.default = FilmComposer;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9Db21wb3Nlci5qcyJdLCJuYW1lcyI6WyJnZXRWaWV3IiwiZGlyIiwic2Nyb2xsYWJsZSIsImN1cnJlbnQiLCJpdGVtQ29udGFpbmVyIiwic2Nyb2xsaW5nVG8iLCJydGwiLCJzY3JvbGxMZWZ0IiwidHJ1ZVNjcm9sbExlZnQiLCJicm93c2VyIiwiY2hyb21lIiwic2Nyb2xsV2lkdGgiLCJvZmZzZXRXaWR0aCIsImVkZ2VVV1AiLCJpbnRlcm5ldEV4cGxvcmVyIiwiaXRlbXMiLCJjaGlsZHJlbiIsInNjcm9sbENlbnRlciIsImluZGV4Iiwic2xpY2UiLCJjYWxsIiwiaXRlbSIsIm9mZnNldENlbnRlciIsIm9mZnNldExlZnQiLCJNYXRoIiwiYWJzIiwiaW5kZXhGcmFjdGlvbiIsInJvdW5kIiwic2VsZWN0ZWRJbmRleCIsImxlbmd0aCIsImdldFNjcm9sbExlZnQiLCJtYXgiLCJtaW4iLCJyZXN1bHQiLCJGaWxtQ29tcG9zZXIiLCJwcm9wcyIsImhhbmRsZVNjcm9sbCIsImJpbmQiLCJoYW5kbGVTY3JvbGxUb0VuZCIsIml0ZW1Db250YWluZXJSZWYiLCJSZWFjdCIsImNyZWF0ZVJlZiIsInNjcm9sbGFibGVSZWYiLCJtZXJnZUNvbnRleHQiLCJzdGF0ZSIsIm51bUl0ZW1zIiwiY29udGV4dCIsInNjcm9sbEJhclBlcmNlbnRhZ2UiLCJzY3JvbGxCYXJXaWR0aCIsInNjcm9sbGluZyIsInNjcm9sbFRvIiwic2V0U3RhdGUiLCJ2aWV3IiwidGFyZ2V0SW5kZXgiLCJzY3JvbGxPbmVMZWZ0IiwiZmxvb3IiLCJjZWlsIiwic2Nyb2xsT25lUmlnaHQiLCJjbGVhclRpbWVvdXQiLCJzY3JvbGxUaW1lb3V0IiwiZnJhY3Rpb24iLCJpbml0aWFsIiwid2lkdGgiLCJzZXRUaW1lb3V0IiwiQ29tcG9uZW50Il0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7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LFVBS0g0QyxRQUxHLGVBS0hBLFFBTEc7QUFBQSxVQU9MSCxhQVBLLEdBWUgsSUFaRyxDQU9MQSxhQVBLO0FBQUEsd0JBWUgsSUFaRyxDQVFMRSxLQVJLO0FBQUEsVUFTSEUsT0FURyxlQVNIQSxPQVRHO0FBQUEsVUFVSHZDLFVBVkcsZUFVSEEsVUFWRztBQWNQLGFBQ0UsNkJBQUMsZ0JBQUQsQ0FBUyxRQUFUO0FBQWtCLFFBQUEsS0FBSyxFQUFHLEtBQUtvQyxZQUFMLENBQWtCRyxPQUFsQixFQUEyQjdDLEdBQTNCLEVBQWdDNEMsUUFBaEM7QUFBMUIsU0FDSTdCLFFBREosRUFFRSw2QkFBQyxrQkFBRDtBQUNFLFFBQUEsUUFBUSxFQUFHLEtBQUtvQixZQURsQjtBQUVFLFFBQUEsU0FBUyxFQUFHTTtBQUZkLFFBRkYsRUFPSSxPQUFPbkMsVUFBUCxLQUFzQixRQUF0QixJQUVFLDZCQUFDLGlCQUFEO0FBQ0UsUUFBQSxLQUFLLEVBQUcsS0FBSytCLGlCQURmO0FBRUUsUUFBQSxVQUFVLEVBQUcvQixVQUZmO0FBR0UsUUFBQSxTQUFTLEVBQUdtQztBQUhkLFFBVE4sQ0FERjtBQWtCRDs7OztFQXRJdUNGLGVBQU13QixTIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IG1lbW9pemUgZnJvbSAnbWVtb2l6ZS1vbmUnO1xuaW1wb3J0IFJlYWN0IGZyb20gJ3JlYWN0JztcblxuaW1wb3J0ICogYXMgYnJvd3NlciBmcm9tICcuL2Jyb3dzZXInO1xuaW1wb3J0IGJlc3QgZnJvbSAnLi9iZXN0JztcbmltcG9ydCBDb250ZXh0IGZyb20gJy4vQ29udGV4dCc7XG5pbXBvcnQgU2Nyb2xsU3B5IGZyb20gJy4vU2Nyb2xsU3B5JztcbmltcG9ydCBTY3JvbGxUbyBmcm9tICcuL1Njcm9sbFRvJztcblxuZnVuY3Rpb24gZ2V0VmlldyhcbiAgZGlyLFxuICB7IGN1cnJlbnQ6IHNjcm9sbGFibGUgfSA9IHt9LFxuICB7IGN1cnJlbnQ6IGl0ZW1Db250YWluZXIgfSA9IHt9LFxuICBzY3JvbGxpbmdUb1xuKSB7XG4gIGNvbnN0IHJ0bCA9IGRpciA9PT0gJ3J0bCc7XG5cbiAgaWYgKGl0ZW1Db250YWluZXIgJiYgc2Nyb2xsYWJsZSkge1xuICAgIGNvbnN0IHNjcm9sbExlZnQgPSBzY3JvbGxpbmdUbyB8fCBzY3JvbGxhYmxlLnNjcm9sbExlZnQ7XG4gICAgY29uc3QgdHJ1ZVNjcm9sbExlZnQgPVxuICAgICAgcnRsID9cbiAgICAgICAgYnJvd3Nlci5jaHJvbWUgP1xuICAgICAgICAgIHNjcm9sbExlZnQgLSAoc2Nyb2xsYWJsZS5zY3JvbGxXaWR0aCAtIHNjcm9sbGFibGUub2Zmc2V0V2lkdGgpXG4gICAgICAgIDogYnJvd3Nlci5lZGdlVVdQIHx8IGJyb3dzZXIuaW50ZXJuZXRFeHBsb3JlciA/XG4gICAgICAgICAgLXNjcm9sbExlZnRcbiAgICAgICAgOlxuICAgICAgICAgIHNjcm9sbExlZnRcbiAgICAgIDpcbiAgICAgICAgc2Nyb2xsTGVmdDtcbiAgICBjb25zdCBpdGVtcyA9IGl0ZW1Db250YWluZXIuY2hpbGRyZW47IC8vIFRoaXMgd2lsbCBlbnVtZXJhdGUgPGxpPiBpbnNpZGUgPEZpbG1TdHJpcD5cbiAgICBjb25zdCBzY3JvbGxDZW50ZXIgPSB0cnVlU2Nyb2xsTGVmdCArIHNjcm9sbGFibGUub2Zmc2V0V2lkdGggLyAyO1xuICAgIGNvbnN0IGluZGV4ID0gYmVzdChbXS5zbGljZS5jYWxsKGl0ZW1zKSwgaXRlbSA9PiB7XG4gICAgICBjb25zdCBvZmZzZXRDZW50ZXIgPSBpdGVtLm9mZnNldExlZnQgKyBpdGVtLm9mZnNldFdpZHRoIC8gMjtcblxuICAgICAgcmV0dXJuIDEgLyBNYXRoLmFicyhzY3JvbGxDZW50ZXIgLSBvZmZzZXRDZW50ZXIpO1xuICAgIH0pO1xuXG4gICAgaWYgKH5pbmRleCkge1xuICAgICAgY29uc3QgaXRlbSA9IGl0ZW1zW2luZGV4XTtcblxuICAgICAgY29uc3Qgb2Zmc2V0Q2VudGVyID0gaXRlbS5vZmZzZXRMZWZ0ICsgaXRlbS5vZmZzZXRXaWR0aCAvIDI7XG4gICAgICBsZXQgaW5kZXhGcmFjdGlvbiA9IGluZGV4ICsgKHNjcm9sbENlbnRlciAtIG9mZnNldENlbnRlcikgLyBpdGVtLm9mZnNldFdpZHRoICogKHJ0bCA/IC0xIDogMSk7XG5cbiAgICAgIC8vIFdlIFwiZml4XCIgaW5kZXhGcmFjdGlvbiBpZiB0aGUgdmlld3BvcnQgaXMgYXQgdGhlIHN0YXJ0L2VuZCBvZiB0aGUgY29udGVudFxuICAgICAgLy8gVGhpcyBpcyB0byBzaW1wbGlmeSBjb2RlIHRoYXQgdXNlIE1hdGgucm91bmQoaW5kZXhGcmFjdGlvbikgdG8gZmluZCB0aGUgc2Nyb2xsYWJsZSBpbmRleFxuICAgICAgLy8gaWYgKHNjcm9sbExlZnQgPT09IDApIHtcbiAgICAgIC8vICAgaW5kZXhGcmFjdGlvbiA9IDA7XG4gICAgICAvLyB9IGVsc2UgaWYgKHNjcm9sbExlZnQgPj0gc2Nyb2xsYWJsZS5zY3JvbGxXaWR0aCAtIHNjcm9sbGFibGUub2Zmc2V0V2lkdGgpIHtcbiAgICAgIC8vICAgaW5kZXhGcmFjdGlvbiA9IGl0ZW1zLmxlbmd0aCAtIDE7XG4gICAgICAvLyB9IGVsc2UgaWYgKGluZGV4RnJhY3Rpb24gJSAxID4gLjk5IHx8IGluZGV4RnJhY3Rpb24gJSAxIDwgLjAxKSB7XG4gICAgICAvLyAgIGluZGV4RnJhY3Rpb24gPSBNYXRoLnJvdW5kKGluZGV4RnJhY3Rpb24pO1xuICAgICAgLy8gfVxuXG4gICAgICBpZiAoaW5kZXhGcmFjdGlvbiAlIDEgPiAuOTkgfHwgaW5kZXhGcmFjdGlvbiAlIDEgPCAuMDEpIHtcbiAgICAgICAgaW5kZXhGcmFjdGlvbiA9IE1hdGgucm91bmQoaW5kZXhGcmFjdGlvbik7XG4gICAgICB9XG5cbiAgICAgIGxldCBzZWxlY3RlZEluZGV4O1xuXG4gICAgICBpZiAoTWF0aC5hYnModHJ1ZVNjcm9sbExlZnQpIDwgMSkge1xuICAgICAgICBzZWxlY3RlZEluZGV4ID0gMDtcbiAgICAgIH0gZWxzZSBpZiAoXG4gICAgICAgIHJ0bCA/XG4gICAgICAgICAgdHJ1ZVNjcm9sbExlZnQgPD0gc2Nyb2xsYWJsZS5vZmZzZXRXaWR0aCAtIHNjcm9sbGFibGUuc2Nyb2xsV2lkdGhcbiAgICAgICAgOlxuICAgICAgICAgIHRydWVTY3JvbGxMZWZ0ID49IHNjcm9sbGFibGUuc2Nyb2xsV2lkdGggLSBzY3JvbGxhYmxlLm9mZnNldFdpZHRoXG4gICAgICApIHtcbiAgICAgICAgc2VsZWN0ZWRJbmRleCA9IGl0ZW1zLmxlbmd0aCAtIDE7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBzZWxlY3RlZEluZGV4ID0gTWF0aC5yb3VuZChpbmRleEZyYWN0aW9uKTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgaW5kZXg6IHNlbGVjdGVkSW5kZXgsXG4gICAgICAgIGluZGV4RnJhY3Rpb25cbiAgICAgIH07XG4gICAgfVxuICB9XG59XG5cbmZ1bmN0aW9uIGdldFNjcm9sbExlZnQoXG4gIGRpcixcbiAgeyBjdXJyZW50OiBzY3JvbGxhYmxlIH0gPSB7fSxcbiAgeyBjdXJyZW50OiBpdGVtQ29udGFpbmVyIH0gPSB7fSxcbiAgaW5kZXhcbikge1xuICBjb25zdCBydGwgPSBkaXIgPT09ICdydGwnO1xuXG4gIGlmIChpdGVtQ29udGFpbmVyICYmIHNjcm9sbGFibGUpIHtcbiAgICBjb25zdCBpdGVtcyA9IGl0ZW1Db250YWluZXIuY2hpbGRyZW47IC8vIFRoaXMgd2lsbCBlbnVtZXJhdGUgPGxpPiBpbnNpZGUgPEZpbG1TdHJpcD5cbiAgICBjb25zdCBpdGVtID0gaXRlbXNbTWF0aC5tYXgoMCwgTWF0aC5taW4oaXRlbXMubGVuZ3RoIC0gMSwgaW5kZXgpKV07XG5cbiAgICBpZiAoaXRlbSkge1xuICAgICAgaWYgKHNjcm9sbGFibGUub2Zmc2V0V2lkdGggPT09IHNjcm9sbGFibGUuc2Nyb2xsV2lkdGgpIHtcbiAgICAgICAgcmV0dXJuIDA7XG4gICAgICB9XG5cbiAgICAgIGxldCByZXN1bHQgPSBpdGVtLm9mZnNldExlZnQgKyAoaXRlbS5vZmZzZXRXaWR0aCAtIHNjcm9sbGFibGUub2Zmc2V0V2lkdGgpIC8gMjtcblxuICAgICAgaWYgKHJ0bCkge1xuICAgICAgICByZXN1bHQgPSBNYXRoLm1pbihyZXN1bHQsIDApO1xuICAgICAgICByZXN1bHQgPSBNYXRoLm1heChyZXN1bHQsIHNjcm9sbGFibGUub2Zmc2V0V2lkdGggLSBzY3JvbGxhYmxlLnNjcm9sbFdpZHRoKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJlc3VsdCA9IE1hdGgubWF4KHJlc3VsdCwgMCk7XG4gICAgICAgIHJlc3VsdCA9IE1hdGgubWluKHJlc3VsdCwgc2Nyb2xsYWJsZS5zY3JvbGxXaWR0aCAtIHNjcm9sbGFibGUub2Zmc2V0V2lkdGgpO1xuICAgICAgfVxuXG4gICAgICBpZiAocnRsKSB7XG4gICAgICAgIGlmIChicm93c2VyLmNocm9tZSkge1xuICAgICAgICAgIHJlc3VsdCArPSBzY3JvbGxhYmxlLnNjcm9sbFdpZHRoIC0gc2Nyb2xsYWJsZS5vZmZzZXRXaWR0aDtcbiAgICAgICAgfSBlbHNlIGlmIChicm93c2VyLmVkZ2VVV1AgfHwgYnJvd3Nlci5pbnRlcm5ldEV4cGxvcmVyKSB7XG4gICAgICAgICAgcmVzdWx0ID0gLXJlc3VsdDtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgRmlsbUNvbXBvc2VyIGV4dGVuZHMgUmVhY3QuQ29tcG9uZW50IHtcbiAgY29uc3RydWN0b3IocHJvcHMpIHtcbiAgICBzdXBlcihwcm9wcyk7XG5cbiAgICB0aGlzLmhhbmRsZVNjcm9sbCA9IHRoaXMuaGFuZGxlU2Nyb2xsLmJpbmQodGhpcyk7XG4gICAgdGhpcy5oYW5kbGVTY3JvbGxUb0VuZCA9IHRoaXMuaGFuZGxlU2Nyb2xsVG9FbmQuYmluZCh0aGlzKTtcblxuICAgIHRoaXMuaXRlbUNvbnRhaW5lclJlZiA9IFJlYWN0LmNyZWF0ZVJlZigpO1xuICAgIHRoaXMuc2Nyb2xsYWJsZVJlZiA9IFJlYWN0LmNyZWF0ZVJlZigpO1xuXG4gICAgdGhpcy5tZXJnZUNvbnRleHQgPSBtZW1vaXplKChzdGF0ZSwgZGlyLCBudW1JdGVtcyA9IDApID0+ICh7XG4gICAgICAuLi5zdGF0ZSxcbiAgICAgIGRpcixcbiAgICAgIG51bUl0ZW1zXG4gICAgfSkpO1xuXG4gICAgdGhpcy5zdGF0ZSA9IHtcbiAgICAgIGNvbnRleHQ6IHtcbiAgICAgICAgaXRlbUNvbnRhaW5lclJlZjogdGhpcy5pdGVtQ29udGFpbmVyUmVmLFxuICAgICAgICBzY3JvbGxhYmxlUmVmOiB0aGlzLnNjcm9sbGFibGVSZWYsXG4gICAgICAgIHNjcm9sbEJhclBlcmNlbnRhZ2U6ICcwJScsXG4gICAgICAgIHNjcm9sbEJhcldpZHRoOiAnMCUnLFxuICAgICAgICBzY3JvbGxpbmc6IGZhbHNlLFxuICAgICAgICBzY3JvbGxUbzogc2Nyb2xsVG8gPT4ge1xuICAgICAgICAgIHRoaXMuc2V0U3RhdGUoc3RhdGUgPT4ge1xuICAgICAgICAgICAgY29uc3QgdmlldyA9IGdldFZpZXcodGhpcy5wcm9wcy5kaXIsIHRoaXMuc2Nyb2xsYWJsZVJlZiwgdGhpcy5pdGVtQ29udGFpbmVyUmVmLCBzdGF0ZS5zY3JvbGxMZWZ0KTtcblxuICAgICAgICAgICAgaWYgKHZpZXcpIHtcbiAgICAgICAgICAgICAgY29uc3QgeyBpbmRleCwgaW5kZXhGcmFjdGlvbiB9ID0gdmlldztcbiAgICAgICAgICAgICAgY29uc3QgdGFyZ2V0SW5kZXggPSBzY3JvbGxUbyh7IGluZGV4LCBpbmRleEZyYWN0aW9uIH0pO1xuXG4gICAgICAgICAgICAgIGlmICh0eXBlb2YgdGFyZ2V0SW5kZXggPT09ICdudW1iZXInKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHsgc2Nyb2xsTGVmdDogZ2V0U2Nyb2xsTGVmdCh0aGlzLnByb3BzLmRpciwgdGhpcy5zY3JvbGxhYmxlUmVmLCB0aGlzLml0ZW1Db250YWluZXJSZWYsIHRhcmdldEluZGV4KSB9O1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSk7XG4gICAgICAgIH0sXG4gICAgICAgIHNjcm9sbE9uZUxlZnQ6ICgpID0+IHtcbiAgICAgICAgICBpZiAodGhpcy5wcm9wcy5kaXIgPT09ICdydGwnKSB7XG4gICAgICAgICAgICB0aGlzLnN0YXRlLmNvbnRleHQuc2Nyb2xsVG8oKHsgaW5kZXhGcmFjdGlvbiB9KSA9PiBNYXRoLmZsb29yKGluZGV4RnJhY3Rpb24pICsgMSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuc3RhdGUuY29udGV4dC5zY3JvbGxUbygoeyBpbmRleEZyYWN0aW9uIH0pID0+IE1hdGguY2VpbChpbmRleEZyYWN0aW9uKSAtIDEpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgICAgc2Nyb2xsT25lUmlnaHQ6ICgpID0+IHtcbiAgICAgICAgICBpZiAodGhpcy5wcm9wcy5kaXIgPT09ICdydGwnKSB7XG4gICAgICAgICAgICB0aGlzLnN0YXRlLmNvbnRleHQuc2Nyb2xsVG8oKHsgaW5kZXhGcmFjdGlvbiB9KSA9PiBNYXRoLmNlaWwoaW5kZXhGcmFjdGlvbikgLSAxKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5zdGF0ZS5jb250ZXh0LnNjcm9sbFRvKCh7IGluZGV4RnJhY3Rpb24gfSkgPT4gTWF0aC5mbG9vcihpbmRleEZyYWN0aW9uKSArIDEpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSxcbiAgICAgIHNjcm9sbExlZnQ6IG51bGxcbiAgICB9O1xuICB9XG5cbiAgY29tcG9uZW50V2lsbFVubW91bnQoKSB7XG4gICAgY2xlYXJUaW1lb3V0KHRoaXMuc2Nyb2xsVGltZW91dCk7XG4gIH1cblxuICBoYW5kbGVTY3JvbGwoe1xuICAgIGZyYWN0aW9uOiBzY3JvbGxCYXJQZXJjZW50YWdlLFxuICAgIGluaXRpYWwsXG4gICAgd2lkdGg6IHNjcm9sbEJhcldpZHRoXG4gIH0pIHtcbiAgICB0aGlzLnNldFN0YXRlKCh7IGNvbnRleHQsIHNjcm9sbExlZnQgfSkgPT4ge1xuICAgICAgY29uc3QgdmlldyA9IGdldFZpZXcodGhpcy5wcm9wcy5kaXIsIHRoaXMuc2Nyb2xsYWJsZVJlZiwgdGhpcy5pdGVtQ29udGFpbmVyUmVmLCBzY3JvbGxMZWZ0KTtcblxuICAgICAgaWYgKHZpZXcpIHtcbiAgICAgICAgY29uc3QgeyBpbmRleCwgaW5kZXhGcmFjdGlvbiB9ID0gdmlldztcblxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIGNvbnRleHQ6IHtcbiAgICAgICAgICAgIC4uLmNvbnRleHQsXG4gICAgICAgICAgICBpbmRleCxcbiAgICAgICAgICAgIGluZGV4RnJhY3Rpb24sXG4gICAgICAgICAgICBzY3JvbGxpbmc6ICFpbml0aWFsLFxuICAgICAgICAgICAgc2Nyb2xsQmFyUGVyY2VudGFnZSxcbiAgICAgICAgICAgIHNjcm9sbEJhcldpZHRoXG4gICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgaWYgKCFpbml0aWFsKSB7XG4gICAgICBjbGVhclRpbWVvdXQodGhpcy5zY3JvbGxUaW1lb3V0KTtcblxuICAgICAgdGhpcy5zY3JvbGxUaW1lb3V0ID0gc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgIHRoaXMuc2V0U3RhdGUoKHsgY29udGV4dCB9KSA9PiAoe1xuICAgICAgICAgIGNvbnRleHQ6IHtcbiAgICAgICAgICAgIC4uLmNvbnRleHQsXG4gICAgICAgICAgICBzY3JvbGxpbmc6IGZhbHNlXG4gICAgICAgICAgfVxuICAgICAgICB9KSk7XG4gICAgICB9LCA1MDApO1xuICAgIH1cbiAgfVxuXG4gIGhhbmRsZVNjcm9sbFRvRW5kKCkge1xuICAgIHRoaXMuc2V0U3RhdGUoKCkgPT4gKHsgc2Nyb2xsTGVmdDogbnVsbCB9KSk7XG4gIH1cblxuICByZW5kZXIoKSB7XG4gICAgY29uc3Qge1xuICAgICAgcHJvcHM6IHtcbiAgICAgICAgY2hpbGRyZW4sXG4gICAgICAgIGRpcixcbiAgICAgICAgbnVtSXRlbXNcbiAgICAgIH0sXG4gICAgICBzY3JvbGxhYmxlUmVmLFxuICAgICAgc3RhdGU6IHtcbiAgICAgICAgY29udGV4dCxcbiAgICAgICAgc2Nyb2xsTGVmdFxuICAgICAgfVxuICAgIH0gPSB0aGlzO1xuXG4gICAgcmV0dXJuIChcbiAgICAgIDxDb250ZXh0LlByb3ZpZGVyIHZhbHVlPXsgdGhpcy5tZXJnZUNvbnRleHQoY29udGV4dCwgZGlyLCBudW1JdGVtcykgfT5cbiAgICAgICAgeyBjaGlsZHJlbiB9XG4gICAgICAgIDxTY3JvbGxTcHlcbiAgICAgICAgICBvblNjcm9sbD17IHRoaXMuaGFuZGxlU2Nyb2xsIH1cbiAgICAgICAgICB0YXJnZXRSZWY9eyBzY3JvbGxhYmxlUmVmIH1cbiAgICAgICAgLz5cbiAgICAgICAge1xuICAgICAgICAgIHR5cGVvZiBzY3JvbGxMZWZ0ID09PSAnbnVtYmVyJ1xuICAgICAgICAgICYmXG4gICAgICAgICAgICA8U2Nyb2xsVG9cbiAgICAgICAgICAgICAgb25FbmQ9eyB0aGlzLmhhbmRsZVNjcm9sbFRvRW5kIH1cbiAgICAgICAgICAgICAgc2Nyb2xsTGVmdD17IHNjcm9sbExlZnQgfVxuICAgICAgICAgICAgICB0YXJnZXRSZWY9eyBzY3JvbGxhYmxlUmVmIH1cbiAgICAgICAgICAgIC8+XG4gICAgICAgIH1cbiAgICAgIDwvQ29udGV4dC5Qcm92aWRlcj5cbiAgICApO1xuICB9XG59Il19