"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = create;

var _regenerator = _interopRequireDefault(require("@babel/runtime/regenerator"));

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _AudioConfig = require("microsoft-cognitiveservices-speech-sdk/distrib/lib/src/sdk/Audio/AudioConfig");

var _microsoftCognitiveservicesSpeechSdk = require("microsoft-cognitiveservices-speech-sdk");

var _createWebSpeechPonyfillFactory = _interopRequireDefault(require("./createWebSpeechPonyfillFactory"));

var _DirectLineSpeech = _interopRequireDefault(require("./DirectLineSpeech"));

var _patchDialogServiceConnectorInline = _interopRequireDefault(require("./patchDialogServiceConnectorInline"));

var _refreshDirectLineToken = _interopRequireDefault(require("./utils/refreshDirectLineToken"));

var _resolveFunctionOrReturnValue = _interopRequireDefault(require("./resolveFunctionOrReturnValue"));

/* eslint complexity: ["error", 33] */
var DIRECT_LINE_TOKEN_RENEWAL_INTERVAL = 900000; // 15 minutes

var TOKEN_RENEWAL_INTERVAL = 120000;

function create(_x) {
  return _create.apply(this, arguments);
}

function _create() {
  _create = (0, _asyncToGenerator2.default)( /*#__PURE__*/_regenerator.default.mark(function _callee3(_ref) {
    var audioConfig, audioContext, audioInputDeviceId, enableInternalHTTPSupport, enableTelemetry, fetchCredentials, speechRecognitionEndpointId, _ref$speechRecognitio, speechRecognitionLanguage, speechSynthesisDeploymentId, speechSynthesisOutputFormat, textNormalization, userID, username, _yield$resolveFunctio, authorizationToken, directLineToken, region, subscriptionKey, config, dialogServiceConnector, interval, _interval, directLine, webSpeechPonyfillFactory;

    return _regenerator.default.wrap(function _callee3$(_context3) {
      while (1) {
        switch (_context3.prev = _context3.next) {
          case 0:
            audioConfig = _ref.audioConfig, audioContext = _ref.audioContext, audioInputDeviceId = _ref.audioInputDeviceId, enableInternalHTTPSupport = _ref.enableInternalHTTPSupport, enableTelemetry = _ref.enableTelemetry, fetchCredentials = _ref.fetchCredentials, speechRecognitionEndpointId = _ref.speechRecognitionEndpointId, _ref$speechRecognitio = _ref.speechRecognitionLanguage, speechRecognitionLanguage = _ref$speechRecognitio === void 0 ? typeof window !== 'undefined' && typeof window.navigator !== 'undefined' && window.navigator.language || 'en-US' : _ref$speechRecognitio, speechSynthesisDeploymentId = _ref.speechSynthesisDeploymentId, speechSynthesisOutputFormat = _ref.speechSynthesisOutputFormat, textNormalization = _ref.textNormalization, userID = _ref.userID, username = _ref.username;

            if (fetchCredentials) {
              _context3.next = 3;
              break;
            }

            throw new Error('"fetchCredentials" must be specified.');

          case 3:
            _context3.next = 5;
            return (0, _resolveFunctionOrReturnValue.default)(fetchCredentials);

          case 5:
            _yield$resolveFunctio = _context3.sent;
            authorizationToken = _yield$resolveFunctio.authorizationToken;
            directLineToken = _yield$resolveFunctio.directLineToken;
            region = _yield$resolveFunctio.region;
            subscriptionKey = _yield$resolveFunctio.subscriptionKey;

            if (!(!authorizationToken && !subscriptionKey || authorizationToken && subscriptionKey || authorizationToken && typeof authorizationToken !== 'string' || subscriptionKey && typeof subscriptionKey !== 'string' || enableInternalHTTPSupport && !directLineToken)) {
              _context3.next = 12;
              break;
            }

            throw new Error('"fetchCredentials" must return either "authorizationToken" or "subscriptionKey" as a non-empty string only. If enableInternalHTTPSupport is set to true, then it should also return a non-empty "directLineToken"');

          case 12:
            if (typeof enableTelemetry !== 'undefined') {
              console.warn('botframework-directlinespeech: Telemetry options are not yet supported. Please refer to Cognitive Services documentation for details.');
            }

            if (!(!region || typeof region !== 'string')) {
              _context3.next = 15;
              break;
            }

            throw new Error('"fetchCredentials" must return "region" as a non-empty string.');

          case 15:
            if (audioConfig && audioInputDeviceId) {
              console.warn('botframework-directlinespeech-sdk: Only "audioConfig" or "audioInputDeviceId" can be specified, but not both; ignoring "audioInputDeviceId".');
            } else if (!audioConfig) {
              if (audioInputDeviceId) {
                audioConfig = _AudioConfig.AudioConfig.fromMicrophoneInput(audioInputDeviceId);
              } else {
                audioConfig = _AudioConfig.AudioConfig.fromDefaultMicrophoneInput();
              }
            }

            if (speechRecognitionEndpointId) {
              console.warn('botframework-directlinespeech: Custom Speech is currently not supported; ignoring "speechRecognitionEndpointId".');
            }

            if (speechSynthesisDeploymentId) {
              console.warn('botframework-directlinespeech: Custom Voice is currently not supported; ignoring "speechSynthesisDeploymentId".');
            }

            if (speechSynthesisOutputFormat) {
              console.warn('botframework-directlinespeech: Synthesis output format is currently not supported; ignoring "speechSynthesisOutputFormat".');
            }

            if (textNormalization) {
              console.warn('botframework-directlinespeech: Text normalization is currently not supported; ignoring "textNormalization".');
            }

            if (userID || username) {
              console.warn('botframework-directlinespeech: Custom "userId" and "username" are currently not supported and are ignored.');
            }

            if (authorizationToken) {
              config = _microsoftCognitiveservicesSpeechSdk.BotFrameworkConfig.fromAuthorizationToken(authorizationToken, region);
            } else {
              config = _microsoftCognitiveservicesSpeechSdk.BotFrameworkConfig.fromSubscription(subscriptionKey, region);
            } // If internal HTTP support is enabled, switch the endpoint to Direct Line on Direct Line Speech service.


            if (enableInternalHTTPSupport) {
              config.setProperty(_microsoftCognitiveservicesSpeechSdk.PropertyId.SpeechServiceConnection_Endpoint, "wss://".concat(encodeURI(region), ".convai.speech.microsoft.com/directline/api/v1"));
              config.setProperty(_microsoftCognitiveservicesSpeechSdk.PropertyId.Conversation_ApplicationId, directLineToken);
            } // Supported options can be found in DialogConnectorFactory.js.
            // Set the language used for recognition.


            config.setProperty(_microsoftCognitiveservicesSpeechSdk.PropertyId.SpeechServiceConnection_RecoLanguage, speechRecognitionLanguage); // The following code sets the output format.
            // As advised by the Speech team, this API may be subject to future changes.
            // We are not enabling output format option because it does not send detailed output format to the bot, rendering this option useless.
            // config.setProperty(PropertyId.SpeechServiceResponse_OutputFormatOption, OutputFormat[OutputFormat.Detailed]);
            // Set the user ID for starting the conversation.

            userID && config.setProperty(_microsoftCognitiveservicesSpeechSdk.PropertyId.Conversation_From_Id, userID); // Set Custom Speech and Custom Voice.
            // The following code is copied from C#, and it is not working yet.
            // https://github.com/Azure-Samples/Cognitive-Services-Direct-Line-Speech-Client/blob/master/DLSpeechClient/MainWindow.xaml.cs
            // speechRecognitionEndpointId && config.setServiceProperty('cid', speechRecognitionEndpointId, ServicePropertyChannel.UriQueryParameter);
            // speechSynthesisDeploymentId && config.setProperty(PropertyId.conversation_Custom_Voice_Deployment_Ids, speechSynthesisDeploymentId);

            dialogServiceConnector = (0, _patchDialogServiceConnectorInline.default)(new _microsoftCognitiveservicesSpeechSdk.DialogServiceConnector(config, audioConfig));
            dialogServiceConnector.connect(); // Renew token per interval.

            if (authorizationToken) {
              interval = setInterval( /*#__PURE__*/(0, _asyncToGenerator2.default)( /*#__PURE__*/_regenerator.default.mark(function _callee() {
                var _yield$resolveFunctio2, authorizationToken, nextRegion;

                return _regenerator.default.wrap(function _callee$(_context) {
                  while (1) {
                    switch (_context.prev = _context.next) {
                      case 0:
                        // #2660 If the connector has been disposed, we should stop renewing the token.
                        // TODO: We should use a public implementation if Speech SDK has one related to "privIsDisposed".
                        if (dialogServiceConnector.privIsDisposed) {
                          clearInterval(interval);
                        }

                        _context.next = 3;
                        return (0, _resolveFunctionOrReturnValue.default)(fetchCredentials);

                      case 3:
                        _yield$resolveFunctio2 = _context.sent;
                        authorizationToken = _yield$resolveFunctio2.authorizationToken;
                        nextRegion = _yield$resolveFunctio2.region;

                        if (authorizationToken) {
                          _context.next = 8;
                          break;
                        }

                        return _context.abrupt("return", console.warn('botframework-directlinespeech-sdk: Renew token failed because "fetchCredentials" call returned no authorization token.'));

                      case 8:
                        if (!(region !== nextRegion)) {
                          _context.next = 10;
                          break;
                        }

                        return _context.abrupt("return", console.warn('botframework-directlinespeech-sdk: Region change is not supported for renewed token. Authorization token is not renewed.'));

                      case 10:
                        dialogServiceConnector.authorizationToken = authorizationToken; // eslint-disable-line require-atomic-updates

                      case 11:
                      case "end":
                        return _context.stop();
                    }
                  }
                }, _callee);
              })), TOKEN_RENEWAL_INTERVAL);
            } // Renew token per interval.


            if (enableInternalHTTPSupport) {
              _interval = setInterval( /*#__PURE__*/(0, _asyncToGenerator2.default)( /*#__PURE__*/_regenerator.default.mark(function _callee2() {
                var refreshedDirectLineToken;
                return _regenerator.default.wrap(function _callee2$(_context2) {
                  while (1) {
                    switch (_context2.prev = _context2.next) {
                      case 0:
                        // #2660 If the connector has been disposed, we should stop renewing the token.
                        // TODO: We should use a public implementation if Speech SDK has one related to "privIsDisposed".
                        if (dialogServiceConnector.privIsDisposed) {
                          clearInterval(_interval);
                        }

                        _context2.next = 3;
                        return (0, _refreshDirectLineToken.default)(directLineToken);

                      case 3:
                        refreshedDirectLineToken = _context2.sent;

                        if (refreshedDirectLineToken) {
                          _context2.next = 6;
                          break;
                        }

                        return _context2.abrupt("return", console.warn('botframework-directlinespeech-sdk: Renew token failed because call to refresh token Direct Line API did not return a new token.'));

                      case 6:
                        config.setProperty(_microsoftCognitiveservicesSpeechSdk.PropertyId.Conversation_ApplicationId, refreshedDirectLineToken);
                        dialogServiceConnector.properties.setProperty(_microsoftCognitiveservicesSpeechSdk.PropertyId.Conversation_ApplicationId, refreshedDirectLineToken);
                        dialogServiceConnector.connect();

                      case 9:
                      case "end":
                        return _context2.stop();
                    }
                  }
                }, _callee2);
              })), DIRECT_LINE_TOKEN_RENEWAL_INTERVAL);
            }

            directLine = new _DirectLineSpeech.default({
              dialogServiceConnector: dialogServiceConnector
            });
            webSpeechPonyfillFactory = (0, _createWebSpeechPonyfillFactory.default)({
              audioContext: audioContext,
              enableTelemetry: enableTelemetry,
              recognizer: dialogServiceConnector,
              textNormalization: textNormalization
            });
            return _context3.abrupt("return", {
              directLine: directLine,
              webSpeechPonyfillFactory: webSpeechPonyfillFactory
            });

          case 32:
          case "end":
            return _context3.stop();
        }
      }
    }, _callee3);
  }));
  return _create.apply(this, arguments);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9jcmVhdGVBZGFwdGVycy5qcyJdLCJuYW1lcyI6WyJESVJFQ1RfTElORV9UT0tFTl9SRU5FV0FMX0lOVEVSVkFMIiwiVE9LRU5fUkVORVdBTF9JTlRFUlZBTCIsImNyZWF0ZSIsImF1ZGlvQ29uZmlnIiwiYXVkaW9Db250ZXh0IiwiYXVkaW9JbnB1dERldmljZUlkIiwiZW5hYmxlSW50ZXJuYWxIVFRQU3VwcG9ydCIsImVuYWJsZVRlbGVtZXRyeSIsImZldGNoQ3JlZGVudGlhbHMiLCJzcGVlY2hSZWNvZ25pdGlvbkVuZHBvaW50SWQiLCJzcGVlY2hSZWNvZ25pdGlvbkxhbmd1YWdlIiwid2luZG93IiwibmF2aWdhdG9yIiwibGFuZ3VhZ2UiLCJzcGVlY2hTeW50aGVzaXNEZXBsb3ltZW50SWQiLCJzcGVlY2hTeW50aGVzaXNPdXRwdXRGb3JtYXQiLCJ0ZXh0Tm9ybWFsaXphdGlvbiIsInVzZXJJRCIsInVzZXJuYW1lIiwiRXJyb3IiLCJhdXRob3JpemF0aW9uVG9rZW4iLCJkaXJlY3RMaW5lVG9rZW4iLCJyZWdpb24iLCJzdWJzY3JpcHRpb25LZXkiLCJjb25zb2xlIiwid2FybiIsIkF1ZGlvQ29uZmlnIiwiZnJvbU1pY3JvcGhvbmVJbnB1dCIsImZyb21EZWZhdWx0TWljcm9waG9uZUlucHV0IiwiY29uZmlnIiwiQm90RnJhbWV3b3JrQ29uZmlnIiwiZnJvbUF1dGhvcml6YXRpb25Ub2tlbiIsImZyb21TdWJzY3JpcHRpb24iLCJzZXRQcm9wZXJ0eSIsIlByb3BlcnR5SWQiLCJTcGVlY2hTZXJ2aWNlQ29ubmVjdGlvbl9FbmRwb2ludCIsImVuY29kZVVSSSIsIkNvbnZlcnNhdGlvbl9BcHBsaWNhdGlvbklkIiwiU3BlZWNoU2VydmljZUNvbm5lY3Rpb25fUmVjb0xhbmd1YWdlIiwiQ29udmVyc2F0aW9uX0Zyb21fSWQiLCJkaWFsb2dTZXJ2aWNlQ29ubmVjdG9yIiwiRGlhbG9nU2VydmljZUNvbm5lY3RvciIsImNvbm5lY3QiLCJpbnRlcnZhbCIsInNldEludGVydmFsIiwicHJpdklzRGlzcG9zZWQiLCJjbGVhckludGVydmFsIiwibmV4dFJlZ2lvbiIsInJlZnJlc2hlZERpcmVjdExpbmVUb2tlbiIsInByb3BlcnRpZXMiLCJkaXJlY3RMaW5lIiwiRGlyZWN0TGluZVNwZWVjaCIsIndlYlNwZWVjaFBvbnlmaWxsRmFjdG9yeSIsInJlY29nbml6ZXIiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7QUFFQTs7QUFDQTs7QUFFQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFUQTtBQVdBLElBQU1BLGtDQUFrQyxHQUFHLE1BQTNDLEMsQ0FBbUQ7O0FBQ25ELElBQU1DLHNCQUFzQixHQUFHLE1BQS9COztTQUU4QkMsTTs7Ozs7b0ZBQWY7QUFBQTs7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUNiQyxZQUFBQSxXQURhLFFBQ2JBLFdBRGEsRUFFYkMsWUFGYSxRQUViQSxZQUZhLEVBR2JDLGtCQUhhLFFBR2JBLGtCQUhhLEVBSWJDLHlCQUphLFFBSWJBLHlCQUphLEVBS2JDLGVBTGEsUUFLYkEsZUFMYSxFQU1iQyxnQkFOYSxRQU1iQSxnQkFOYSxFQU9iQywyQkFQYSxRQU9iQSwyQkFQYSwrQkFRYkMseUJBUmEsRUFRYkEseUJBUmEsc0NBUWdCLE9BQU9DLE1BQVAsS0FBa0IsV0FBbEIsSUFDM0IsT0FBT0EsTUFBTSxDQUFDQyxTQUFkLEtBQTRCLFdBREQsSUFFM0JELE1BQU0sQ0FBQ0MsU0FBUCxDQUFpQkMsUUFGUyxJQUcxQixPQVhXLDBCQVliQywyQkFaYSxRQVliQSwyQkFaYSxFQWFiQywyQkFiYSxRQWFiQSwyQkFiYSxFQWNiQyxpQkFkYSxRQWNiQSxpQkFkYSxFQWViQyxNQWZhLFFBZWJBLE1BZmEsRUFnQmJDLFFBaEJhLFFBZ0JiQSxRQWhCYTs7QUFBQSxnQkFrQlJWLGdCQWxCUTtBQUFBO0FBQUE7QUFBQTs7QUFBQSxrQkFtQkwsSUFBSVcsS0FBSixDQUFVLHVDQUFWLENBbkJLOztBQUFBO0FBQUE7QUFBQSxtQkFzQmtFLDJDQUM3RVgs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Oi8vLyIsInNvdXJjZXNDb250ZW50IjpbIi8qIGVzbGludCBjb21wbGV4aXR5OiBbXCJlcnJvclwiLCAzM10gKi9cblxuaW1wb3J0IHsgQXVkaW9Db25maWcgfSBmcm9tICdtaWNyb3NvZnQtY29nbml0aXZlc2VydmljZXMtc3BlZWNoLXNkay9kaXN0cmliL2xpYi9zcmMvc2RrL0F1ZGlvL0F1ZGlvQ29uZmlnJztcbmltcG9ydCB7IEJvdEZyYW1ld29ya0NvbmZpZywgRGlhbG9nU2VydmljZUNvbm5lY3RvciwgUHJvcGVydHlJZCB9IGZyb20gJ21pY3Jvc29mdC1jb2duaXRpdmVzZXJ2aWNlcy1zcGVlY2gtc2RrJztcblxuaW1wb3J0IGNyZWF0ZVdlYlNwZWVjaFBvbnlmaWxsRmFjdG9yeSBmcm9tICcuL2NyZWF0ZVdlYlNwZWVjaFBvbnlmaWxsRmFjdG9yeSc7XG5pbXBvcnQgRGlyZWN0TGluZVNwZWVjaCBmcm9tICcuL0RpcmVjdExpbmVTcGVlY2gnO1xuaW1wb3J0IHBhdGNoRGlhbG9nU2VydmljZUNvbm5lY3RvcklubGluZSBmcm9tICcuL3BhdGNoRGlhbG9nU2VydmljZUNvbm5lY3RvcklubGluZSc7XG5pbXBvcnQgcmVmcmVzaERpcmVjdExpbmVUb2tlbiBmcm9tICcuL3V0aWxzL3JlZnJlc2hEaXJlY3RMaW5lVG9rZW4nO1xuaW1wb3J0IHJlc29sdmVGdW5jdGlvbk9yUmV0dXJuVmFsdWUgZnJvbSAnLi9yZXNvbHZlRnVuY3Rpb25PclJldHVyblZhbHVlJztcblxuY29uc3QgRElSRUNUX0xJTkVfVE9LRU5fUkVORVdBTF9JTlRFUlZBTCA9IDkwMDAwMDsgLy8gMTUgbWludXRlc1xuY29uc3QgVE9LRU5fUkVORVdBTF9JTlRFUlZBTCA9IDEyMDAwMDtcblxuZXhwb3J0IGRlZmF1bHQgYXN5bmMgZnVuY3Rpb24gY3JlYXRlKHtcbiAgYXVkaW9Db25maWcsXG4gIGF1ZGlvQ29udGV4dCxcbiAgYXVkaW9JbnB1dERldmljZUlkLFxuICBlbmFibGVJbnRlcm5hbEhUVFBTdXBwb3J0LFxuICBlbmFibGVUZWxlbWV0cnksXG4gIGZldGNoQ3JlZGVudGlhbHMsXG4gIHNwZWVjaFJlY29nbml0aW9uRW5kcG9pbnRJZCxcbiAgc3BlZWNoUmVjb2duaXRpb25MYW5ndWFnZSA9ICh0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJyAmJlxuICAgIHR5cGVvZiB3aW5kb3cubmF2aWdhdG9yICE9PSAndW5kZWZpbmVkJyAmJlxuICAgIHdpbmRvdy5uYXZpZ2F0b3IubGFuZ3VhZ2UpIHx8XG4gICAgJ2VuLVVTJyxcbiAgc3BlZWNoU3ludGhlc2lzRGVwbG95bWVudElkLFxuICBzcGVlY2hTeW50aGVzaXNPdXRwdXRGb3JtYXQsXG4gIHRleHROb3JtYWxpemF0aW9uLFxuICB1c2VySUQsXG4gIHVzZXJuYW1lXG59KSB7XG4gIGlmICghZmV0Y2hDcmVkZW50aWFscykge1xuICAgIHRocm93IG5ldyBFcnJvcignXCJmZXRjaENyZWRlbnRpYWxzXCIgbXVzdCBiZSBzcGVjaWZpZWQuJyk7XG4gIH1cblxuICBjb25zdCB7IGF1dGhvcml6YXRpb25Ub2tlbiwgZGlyZWN0TGluZVRva2VuLCByZWdpb24sIHN1YnNjcmlwdGlvbktleSB9ID0gYXdhaXQgcmVzb2x2ZUZ1bmN0aW9uT3JSZXR1cm5WYWx1ZShcbiAgICBmZXRjaENyZWRlbnRpYWxzXG4gICk7XG5cbiAgaWYgKFxuICAgICghYXV0aG9yaXphdGlvblRva2VuICYmICFzdWJzY3JpcHRpb25LZXkpIHx8XG4gICAgKGF1dGhvcml6YXRpb25Ub2tlbiAmJiBzdWJzY3JpcHRpb25LZXkpIHx8XG4gICAgKGF1dGhvcml6YXRpb25Ub2tlbiAmJiB0eXBlb2YgYXV0aG9yaXphdGlvblRva2VuICE9PSAnc3RyaW5nJykgfHxcbiAgICAoc3Vic2NyaXB0aW9uS2V5ICYmIHR5cGVvZiBzdWJzY3JpcHRpb25LZXkgIT09ICdzdHJpbmcnKSB8fFxuICAgIChlbmFibGVJbnRlcm5hbEhUVFBTdXBwb3J0ICYmICFkaXJlY3RMaW5lVG9rZW4pXG4gICkge1xuICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICdcImZldGNoQ3JlZGVudGlhbHNcIiBtdXN0IHJldHVybiBlaXRoZXIgXCJhdXRob3JpemF0aW9uVG9rZW5cIiBvciBcInN1YnNjcmlwdGlvbktleVwiIGFzIGEgbm9uLWVtcHR5IHN0cmluZyBvbmx5LiBJZiBlbmFibGVJbnRlcm5hbEhUVFBTdXBwb3J0IGlzIHNldCB0byB0cnVlLCB0aGVuIGl0IHNob3VsZCBhbHNvIHJldHVybiBhIG5vbi1lbXB0eSBcImRpcmVjdExpbmVUb2tlblwiJ1xuICAgICk7XG4gIH1cblxuICBpZiAodHlwZW9mIGVuYWJsZVRlbGVtZXRyeSAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICBjb25zb2xlLndhcm4oXG4gICAgICAnYm90ZnJhbWV3b3JrLWRpcmVjdGxpbmVzcGVlY2g6IFRlbGVtZXRyeSBvcHRpb25zIGFyZSBub3QgeWV0IHN1cHBvcnRlZC4gUGxlYXNlIHJlZmVyIHRvIENvZ25pdGl2ZSBTZXJ2aWNlcyBkb2N1bWVudGF0aW9uIGZvciBkZXRhaWxzLidcbiAgICApO1xuICB9XG5cbiAgaWYgKCFyZWdpb24gfHwgdHlwZW9mIHJlZ2lvbiAhPT0gJ3N0cmluZycpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ1wiZmV0Y2hDcmVkZW50aWFsc1wiIG11c3QgcmV0dXJuIFwicmVnaW9uXCIgYXMgYSBub24tZW1wdHkgc3RyaW5nLicpO1xuICB9XG5cbiAgaWYgKGF1ZGlvQ29uZmlnICYmIGF1ZGlvSW5wdXREZXZpY2VJZCkge1xuICAgIGNvbnNvbGUud2FybihcbiAgICAgICdib3RmcmFtZXdvcmstZGlyZWN0bGluZXNwZWVjaC1zZGs6IE9ubHkgXCJhdWRpb0NvbmZpZ1wiIG9yIFwiYXVkaW9JbnB1dERldmljZUlkXCIgY2FuIGJlIHNwZWNpZmllZCwgYnV0IG5vdCBib3RoOyBpZ25vcmluZyBcImF1ZGlvSW5wdXREZXZpY2VJZFwiLidcbiAgICApO1xuICB9IGVsc2UgaWYgKCFhdWRpb0NvbmZpZykge1xuICAgIGlmIChhdWRpb0lucHV0RGV2aWNlSWQpIHtcbiAgICAgIGF1ZGlvQ29uZmlnID0gQXVkaW9Db25maWcuZnJvbU1pY3JvcGhvbmVJbnB1dChhdWRpb0lucHV0RGV2aWNlSWQpO1xuICAgIH0gZWxzZSB7XG4gICAgICBhdWRpb0NvbmZpZyA9IEF1ZGlvQ29uZmlnLmZyb21EZWZhdWx0TWljcm9waG9uZUlucHV0KCk7XG4gICAgfVxuICB9XG5cbiAgaWYgKHNwZWVjaFJlY29nbml0aW9uRW5kcG9pbnRJZCkge1xuICAgIGNvbnNvbGUud2FybihcbiAgICAgICdib3RmcmFtZXdvcmstZGlyZWN0bGluZXNwZWVjaDogQ3VzdG9tIFNwZWVjaCBpcyBjdXJyZW50bHkgbm90IHN1cHBvcnRlZDsgaWdub3JpbmcgXCJzcGVlY2hSZWNvZ25pdGlvbkVuZHBvaW50SWRcIi4nXG4gICAgKTtcbiAgfVxuXG4gIGlmIChzcGVlY2hTeW50aGVzaXNEZXBsb3ltZW50SWQpIHtcbiAgICBjb25zb2xlLndhcm4oXG4gICAgICAnYm90ZnJhbWV3b3JrLWRpcmVjdGxpbmVzcGVlY2g6IEN1c3RvbSBWb2ljZSBpcyBjdXJyZW50bHkgbm90IHN1cHBvcnRlZDsgaWdub3JpbmcgXCJzcGVlY2hTeW50aGVzaXNEZXBsb3ltZW50SWRcIi4nXG4gICAgKTtcbiAgfVxuXG4gIGlmIChzcGVlY2hTeW50aGVzaXNPdXRwdXRGb3JtYXQpIHtcbiAgICBjb25zb2xlLndhcm4oXG4gICAgICAnYm90ZnJhbWV3b3JrLWRpcmVjdGxpbmVzcGVlY2g6IFN5bnRoZXNpcyBvdXRwdXQgZm9ybWF0IGlzIGN1cnJlbnRseSBub3Qgc3VwcG9ydGVkOyBpZ25vcmluZyBcInNwZWVjaFN5bnRoZXNpc091dHB1dEZvcm1hdFwiLidcbiAgICApO1xuICB9XG5cbiAgaWYgKHRleHROb3JtYWxpemF0aW9uKSB7XG4gICAgY29uc29sZS53YXJuKFxuICAgICAgJ2JvdGZyYW1ld29yay1kaXJlY3RsaW5lc3BlZWNoOiBUZXh0IG5vcm1hbGl6YXRpb24gaXMgY3VycmVudGx5IG5vdCBzdXBwb3J0ZWQ7IGlnbm9yaW5nIFwidGV4dE5vcm1hbGl6YXRpb25cIi4nXG4gICAgKTtcbiAgfVxuXG4gIGlmICh1c2VySUQgfHwgdXNlcm5hbWUpIHtcbiAgICBjb25zb2xlLndhcm4oXG4gICAgICAnYm90ZnJhbWV3b3JrLWRpcmVjdGxpbmVzcGVlY2g6IEN1c3RvbSBcInVzZXJJZFwiIGFuZCBcInVzZXJuYW1lXCIgYXJlIGN1cnJlbnRseSBub3Qgc3VwcG9ydGVkIGFuZCBhcmUgaWdub3JlZC4nXG4gICAgKTtcbiAgfVxuXG4gIGxldCBjb25maWc7XG5cbiAgaWYgKGF1dGhvcml6YXRpb25Ub2tlbikge1xuICAgIGNvbmZpZyA9IEJvdEZyYW1ld29ya0NvbmZpZy5mcm9tQXV0aG9yaXphdGlvblRva2VuKGF1dGhvcml6YXRpb25Ub2tlbiwgcmVnaW9uKTtcbiAgfSBlbHNlIHtcbiAgICBjb25maWcgPSBCb3RGcmFtZXdvcmtDb25maWcuZnJvbVN1YnNjcmlwdGlvbihzdWJzY3JpcHRpb25LZXksIHJlZ2lvbik7XG4gIH1cblxuICAvLyBJZiBpbnRlcm5hbCBIVFRQIHN1cHBvcnQgaXMgZW5hYmxlZCwgc3dpdGNoIHRoZSBlbmRwb2ludCB0byBEaXJlY3QgTGluZSBvbiBEaXJlY3QgTGluZSBTcGVlY2ggc2VydmljZS5cbiAgaWYgKGVuYWJsZUludGVybmFsSFRUUFN1cHBvcnQpIHtcbiAgICBjb25maWcuc2V0UHJvcGVydHkoXG4gICAgICBQcm9wZXJ0eUlkLlNwZWVjaFNlcnZpY2VDb25uZWN0aW9uX0VuZHBvaW50LFxuICAgICAgYHdzczovLyR7ZW5jb2RlVVJJKHJlZ2lvbil9LmNvbnZhaS5zcGVlY2gubWljcm9zb2Z0LmNvbS9kaXJlY3RsaW5lL2FwaS92MWBcbiAgICApO1xuXG4gICAgY29uZmlnLnNldFByb3BlcnR5KFByb3BlcnR5SWQuQ29udmVyc2F0aW9uX0FwcGxpY2F0aW9uSWQsIGRpcmVjdExpbmVUb2tlbik7XG4gIH1cblxuICAvLyBTdXBwb3J0ZWQgb3B0aW9ucyBjYW4gYmUgZm91bmQgaW4gRGlhbG9nQ29ubmVjdG9yRmFjdG9yeS5qcy5cblxuICAvLyBTZXQgdGhlIGxhbmd1YWdlIHVzZWQgZm9yIHJlY29nbml0aW9uLlxuICBjb25maWcuc2V0UHJvcGVydHkoUHJvcGVydHlJZC5TcGVlY2hTZXJ2aWNlQ29ubmVjdGlvbl9SZWNvTGFuZ3VhZ2UsIHNwZWVjaFJlY29nbml0aW9uTGFuZ3VhZ2UpO1xuXG4gIC8vIFRoZSBmb2xsb3dpbmcgY29kZSBzZXRzIHRoZSBvdXRwdXQgZm9ybWF0LlxuICAvLyBBcyBhZHZpc2VkIGJ5IHRoZSBTcGVlY2ggdGVhbSwgdGhpcyBBUEkgbWF5IGJlIHN1YmplY3QgdG8gZnV0dXJlIGNoYW5nZXMuXG4gIC8vIFdlIGFyZSBub3QgZW5hYmxpbmcgb3V0cHV0IGZvcm1hdCBvcHRpb24gYmVjYXVzZSBpdCBkb2VzIG5vdCBzZW5kIGRldGFpbGVkIG91dHB1dCBmb3JtYXQgdG8gdGhlIGJvdCwgcmVuZGVyaW5nIHRoaXMgb3B0aW9uIHVzZWxlc3MuXG4gIC8vIGNvbmZpZy5zZXRQcm9wZXJ0eShQcm9wZXJ0eUlkLlNwZWVjaFNlcnZpY2VSZXNwb25zZV9PdXRwdXRGb3JtYXRPcHRpb24sIE91dHB1dEZvcm1hdFtPdXRwdXRGb3JtYXQuRGV0YWlsZWRdKTtcblxuICAvLyBTZXQgdGhlIHVzZXIgSUQgZm9yIHN0YXJ0aW5nIHRoZSBjb252ZXJzYXRpb24uXG4gIHVzZXJJRCAmJiBjb25maWcuc2V0UHJvcGVydHkoUHJvcGVydHlJZC5Db252ZXJzYXRpb25fRnJvbV9JZCwgdXNlcklEKTtcblxuICAvLyBTZXQgQ3VzdG9tIFNwZWVjaCBhbmQgQ3VzdG9tIFZvaWNlLlxuICAvLyBUaGUgZm9sbG93aW5nIGNvZGUgaXMgY29waWVkIGZyb20gQyMsIGFuZCBpdCBpcyBub3Qgd29ya2luZyB5ZXQuXG4gIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9BenVyZS1TYW1wbGVzL0NvZ25pdGl2ZS1TZXJ2aWNlcy1EaXJlY3QtTGluZS1TcGVlY2gtQ2xpZW50L2Jsb2IvbWFzdGVyL0RMU3BlZWNoQ2xpZW50L01haW5XaW5kb3cueGFtbC5jc1xuICAvLyBzcGVlY2hSZWNvZ25pdGlvbkVuZHBvaW50SWQgJiYgY29uZmlnLnNldFNlcnZpY2VQcm9wZXJ0eSgnY2lkJywgc3BlZWNoUmVjb2duaXRpb25FbmRwb2ludElkLCBTZXJ2aWNlUHJvcGVydHlDaGFubmVsLlVyaVF1ZXJ5UGFyYW1ldGVyKTtcbiAgLy8gc3BlZWNoU3ludGhlc2lzRGVwbG95bWVudElkICYmIGNvbmZpZy5zZXRQcm9wZXJ0eShQcm9wZXJ0eUlkLmNvbnZlcnNhdGlvbl9DdXN0b21fVm9pY2VfRGVwbG95bWVudF9JZHMsIHNwZWVjaFN5bnRoZXNpc0RlcGxveW1lbnRJZCk7XG5cbiAgY29uc3QgZGlhbG9nU2VydmljZUNvbm5lY3RvciA9IHBhdGNoRGlhbG9nU2VydmljZUNvbm5lY3RvcklubGluZShuZXcgRGlhbG9nU2VydmljZUNvbm5lY3Rvcihjb25maWcsIGF1ZGlvQ29uZmlnKSk7XG5cbiAgZGlhbG9nU2VydmljZUNvbm5lY3Rvci5jb25uZWN0KCk7XG5cbiAgLy8gUmVuZXcgdG9rZW4gcGVyIGludGVydmFsLlxuICBpZiAoYXV0aG9yaXphdGlvblRva2VuKSB7XG4gICAgY29uc3QgaW50ZXJ2YWwgPSBzZXRJbnRlcnZhbChhc3luYyAoKSA9PiB7XG4gICAgICAvLyAjMjY2MCBJZiB0aGUgY29ubmVjdG9yIGhhcyBiZWVuIGRpc3Bvc2VkLCB3ZSBzaG91bGQgc3RvcCByZW5ld2luZyB0aGUgdG9rZW4uXG5cbiAgICAgIC8vIFRPRE86IFdlIHNob3VsZCB1c2UgYSBwdWJsaWMgaW1wbGVtZW50YXRpb24gaWYgU3BlZWNoIFNESyBoYXMgb25lIHJlbGF0ZWQgdG8gXCJwcml2SXNEaXNwb3NlZFwiLlxuICAgICAgaWYgKGRpYWxvZ1NlcnZpY2VDb25uZWN0b3IucHJpdklzRGlzcG9zZWQpIHtcbiAgICAgICAgY2xlYXJJbnRlcnZhbChpbnRlcnZhbCk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHsgYXV0aG9yaXphdGlvblRva2VuLCByZWdpb246IG5leHRSZWdpb24gfSA9IGF3YWl0IHJlc29sdmVGdW5jdGlvbk9yUmV0dXJuVmFsdWUoZmV0Y2hDcmVkZW50aWFscyk7XG5cbiAgICAgIGlmICghYXV0aG9yaXphdGlvblRva2VuKSB7XG4gICAgICAgIHJldHVybiBjb25zb2xlLndhcm4oXG4gICAgICAgICAgJ2JvdGZyYW1ld29yay1kaXJlY3RsaW5lc3BlZWNoLXNkazogUmVuZXcgdG9rZW4gZmFpbGVkIGJlY2F1c2UgXCJmZXRjaENyZWRlbnRpYWxzXCIgY2FsbCByZXR1cm5lZCBubyBhdXRob3JpemF0aW9uIHRva2VuLidcbiAgICAgICAgKTtcbiAgICAgIH1cblxuICAgICAgaWYgKHJlZ2lvbiAhPT0gbmV4dFJlZ2lvbikge1xuICAgICAgICByZXR1cm4gY29uc29sZS53YXJuKFxuICAgICAgICAgICdib3RmcmFtZXdvcmstZGlyZWN0bGluZXNwZWVjaC1zZGs6IFJlZ2lvbiBjaGFuZ2UgaXMgbm90IHN1cHBvcnRlZCBmb3IgcmVuZXdlZCB0b2tlbi4gQXV0aG9yaXphdGlvbiB0b2tlbiBpcyBub3QgcmVuZXdlZC4nXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIGRpYWxvZ1NlcnZpY2VDb25uZWN0b3IuYXV0aG9yaXphdGlvblRva2VuID0gYXV0aG9yaXphdGlvblRva2VuOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIHJlcXVpcmUtYXRvbWljLXVwZGF0ZXNcbiAgICB9LCBUT0tFTl9SRU5FV0FMX0lOVEVSVkFMKTtcbiAgfVxuXG4gIC8vIFJlbmV3IHRva2VuIHBlciBpbnRlcnZhbC5cbiAgaWYgKGVuYWJsZUludGVybmFsSFRUUFN1cHBvcnQpIHtcbiAgICBjb25zdCBpbnRlcnZhbCA9IHNldEludGVydmFsKGFzeW5jICgpID0+IHtcbiAgICAgIC8vICMyNjYwIElmIHRoZSBjb25uZWN0b3IgaGFzIGJlZW4gZGlzcG9zZWQsIHdlIHNob3VsZCBzdG9wIHJlbmV3aW5nIHRoZSB0b2tlbi5cblxuICAgICAgLy8gVE9ETzogV2Ugc2hvdWxkIHVzZSBhIHB1YmxpYyBpbXBsZW1lbnRhdGlvbiBpZiBTcGVlY2ggU0RLIGhhcyBvbmUgcmVsYXRlZCB0byBcInByaXZJc0Rpc3Bvc2VkXCIuXG4gICAgICBpZiAoZGlhbG9nU2VydmljZUNvbm5lY3Rvci5wcml2SXNEaXNwb3NlZCkge1xuICAgICAgICBjbGVhckludGVydmFsKGludGVydmFsKTtcbiAgICAgIH1cbiAgICAgIFxuICAgICAgY29uc3QgcmVmcmVzaGVkRGlyZWN0TGluZVRva2VuID0gYXdhaXQgcmVmcmVzaERpcmVjdExpbmVUb2tlbihkaXJlY3RMaW5lVG9rZW4pO1xuICAgICAgXG4gICAgICBpZiAoIXJlZnJlc2hlZERpcmVjdExpbmVUb2tlbikge1xuICAgICAgICByZXR1cm4gY29uc29sZS53YXJuKFxuICAgICAgICAgICdib3RmcmFtZXdvcmstZGlyZWN0bGluZXNwZWVjaC1zZGs6IFJlbmV3IHRva2VuIGZhaWxlZCBiZWNhdXNlIGNhbGwgdG8gcmVmcmVzaCB0b2tlbiBEaXJlY3QgTGluZSBBUEkgZGlkIG5vdCByZXR1cm4gYSBuZXcgdG9rZW4uJ1xuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICBjb25maWcuc2V0UHJvcGVydHkoUHJvcGVydHlJZC5Db252ZXJzYXRpb25fQXBwbGljYXRpb25JZCwgcmVmcmVzaGVkRGlyZWN0TGluZVRva2VuKTtcbiAgICAgIFxuICAgICAgZGlhbG9nU2VydmljZUNvbm5lY3Rvci5wcm9wZXJ0aWVzLnNldFByb3BlcnR5KFByb3BlcnR5SWQuQ29udmVyc2F0aW9uX0FwcGxpY2F0aW9uSWQsIHJlZnJlc2hlZERpcmVjdExpbmVUb2tlbilcbiAgICAgIGRpYWxvZ1NlcnZpY2VDb25uZWN0b3IuY29ubmVjdCgpO1xuICAgIH0sIERJUkVDVF9MSU5FX1RPS0VOX1JFTkVXQUxfSU5URVJWQUwpO1xuICB9XG5cbiAgY29uc3QgZGlyZWN0TGluZSA9IG5ldyBEaXJlY3RMaW5lU3BlZWNoKHsgZGlhbG9nU2VydmljZUNvbm5lY3RvciB9KTtcblxuICBjb25zdCB3ZWJTcGVlY2hQb255ZmlsbEZhY3RvcnkgPSBjcmVhdGVXZWJTcGVlY2hQb255ZmlsbEZhY3Rvcnkoe1xuICAgIGF1ZGlvQ29udGV4dCxcbiAgICBlbmFibGVUZWxlbWV0cnksXG4gICAgcmVjb2duaXplcjogZGlhbG9nU2VydmljZUNvbm5lY3RvcixcbiAgICB0ZXh0Tm9ybWFsaXphdGlvblxuICB9KTtcblxuICByZXR1cm4ge1xuICAgIGRpcmVjdExpbmUsXG4gICAgd2ViU3BlZWNoUG9ueWZpbGxGYWN0b3J5XG4gIH07XG59XG4iXX0=