"use strict";

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = _default;

var _regenerator = _interopRequireDefault(require("@babel/runtime/regenerator"));

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

var _inherits2 = _interopRequireDefault(require("@babel/runtime/helpers/inherits"));

var _possibleConstructorReturn2 = _interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn"));

var _getPrototypeOf2 = _interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf"));

var _SpeechToText = require("web-speech-cognitive-services/lib/SpeechServices/SpeechToText");

var _abortControllerEs = _interopRequireDefault(require("abort-controller-es5"));

var _createCustomEvent = _interopRequireDefault(require("./createCustomEvent"));

var _createErrorEvent = _interopRequireDefault(require("./createErrorEvent"));

var _createTaskQueue2 = _interopRequireDefault(require("./createTaskQueue"));

var _eventTargetShimEs = _interopRequireWildcard(require("event-target-shim-es5"));

var _playCognitiveServicesStream = _interopRequireDefault(require("./playCognitiveServicesStream"));

var _playWhiteNoise = _interopRequireDefault(require("./playWhiteNoise"));

var _SpeechSynthesisAudioStreamUtterance = _interopRequireDefault(require("./SpeechSynthesisAudioStreamUtterance"));

function _createSuper(Derived) { var hasNativeReflectConstruct = _isNativeReflectConstruct(); return function _createSuperInternal() { var Super = (0, _getPrototypeOf2.default)(Derived), result; if (hasNativeReflectConstruct) { var NewTarget = (0, _getPrototypeOf2.default)(this).constructor; result = Reflect.construct(Super, arguments, NewTarget); } else { result = Super.apply(this, arguments); } return (0, _possibleConstructorReturn2.default)(this, result); }; }

function _isNativeReflectConstruct() { if (typeof Reflect === "undefined" || !Reflect.construct) return false; if (Reflect.construct.sham) return false; if (typeof Proxy === "function") return true; try { Date.prototype.toString.call(Reflect.construct(Date, [], function () {})); return true; } catch (e) { return false; } }

function _default(_ref) {
  var audioContext = _ref.audioContext,
      enableTelemetry = _ref.enableTelemetry,
      _ref$ponyfill = _ref.ponyfill,
      ponyfill = _ref$ponyfill === void 0 ? {
    AudioContext: window.AudioContext || window.webkitAudioContext
  } : _ref$ponyfill,
      recognizer = _ref.recognizer,
      textNormalization = _ref.textNormalization;

  if (!ponyfill.AudioContext) {
    console.warn('botframework-directlinespeech-sdk: This browser does not support Web Audio API. Speech support is disabled.');
    return function () {
      return {};
    };
  }

  return function () {
    var _createSpeechRecognit = (0, _SpeechToText.createSpeechRecognitionPonyfillFromRecognizer)({
      createRecognizer: function createRecognizer() {
        return recognizer;
      },
      enableTelemetry: enableTelemetry,
      looseEvents: true,
      textNormalization: textNormalization
    }),
        SpeechGrammarList = _createSpeechRecognit.SpeechGrammarList,
        SpeechRecognition = _createSpeechRecognit.SpeechRecognition;

    if (!audioContext) {
      audioContext = new ponyfill.AudioContext();
    }

    var _createTaskQueue = (0, _createTaskQueue2.default)(),
        cancelAll = _createTaskQueue.cancelAll,
        push = _createTaskQueue.push;

    var SpeechSynthesis = /*#__PURE__*/function (_EventTargetShim) {
      (0, _inherits2.default)(SpeechSynthesis, _EventTargetShim);

      var _super = _createSuper(SpeechSynthesis);

      function SpeechSynthesis() {
        (0, _classCallCheck2.default)(this, SpeechSynthesis);
        return _super.apply(this, arguments);
      }

      (0, _createClass2.default)(SpeechSynthesis, [{
        key: "cancel",
        value: function cancel() {
          cancelAll();
        } // Returns an empty array.
        // Synthesis is done on the bot side, the content of the voice list is not meaningful on the client side.

      }, {
        key: "getVoices",
        value: function getVoices() {
          return [];
        }
      }, {
        key: "speak",
        value: function speak(utterance) {
          var _push = push(function () {
            var controller = new _abortControllerEs.default();
            var signal = controller.signal;
            return {
              abort: controller.abort.bind(controller),
              result: (0, _asyncToGenerator2.default)( /*#__PURE__*/_regenerator.default.mark(function _callee() {
                var _utterance$audioStrea, format, streamReader;

                return _regenerator.default.wrap(function _callee$(_context) {
                  while (1) {
                    switch (_context.prev = _context.next) {
                      case 0:
                        utterance.dispatchEvent((0, _createCustomEvent.default)('start'));
                        _context.prev = 1;

                        if (!utterance.audioStream) {
                          _context.next = 8;
                          break;
                        }

                        _utterance$audioStrea = utterance.audioStream, format = _utterance$audioStrea.format, streamReader = _utterance$audioStrea.streamReader;
                        _context.next = 6;
                        return (0, _playCognitiveServicesStream.default)(audioContext, format, streamReader, {
                          signal: signal
                        });

                      case 6:
                        _context.next = 10;
                        break;

                      case 8:
                        _context.next = 10;
                        return (0, _playWhiteNoise.default)(audioContext);

                      case 10:
                        _context.next = 16;
                        break;

                      case 12:
                        _context.prev = 12;
                        _context.t0 = _context["catch"](1);

                        if (!(_context.t0.message !== 'aborted')) {
                          _context.next = 16;
                          break;
                        }

                        return _context.abrupt("return", utterance.dispatchEvent((0, _createErrorEvent.default)(_context.t0)));

                      case 16:
                        utterance.dispatchEvent((0, _createCustomEvent.default)('end'));

                      case 17:
                      case "end":
                        return _context.stop();
                    }
                  }
                }, _callee, null, [[1, 12]]);
              }))()
            };
          }),
              result = _push.result; // Catching the error to prevent uncaught promise error due to cancellation.


          result.catch(function (error) {
            if (!/^cancelled/i.test(error.message)) {
              throw error;
            }
          });
        }
      }]);
      return SpeechSynthesis;
    }(_eventTargetShimEs.default);

    (0, _eventTargetShimEs.defineEventAttribute)(SpeechSynthesis, 'voiceschanged');
    return {
      SpeechGrammarList: SpeechGrammarList,
      SpeechRecognition: SpeechRecognition,
      speechSynthesis: new SpeechSynthesis(),
      SpeechSynthesisUtterance: _SpeechSynthesisAudioStreamUtterance.default
    };
  };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9jcmVhdGVXZWJTcGVlY2hQb255ZmlsbEZhY3RvcnkuanMiXSwibmFtZXMiOlsiYXVkaW9Db250ZXh0IiwiZW5hYmxlVGVsZW1ldHJ5IiwicG9ueWZpbGwiLCJBdWRpb0NvbnRleHQiLCJ3aW5kb3ciLCJ3ZWJraXRBdWRpb0NvbnRleHQiLCJyZWNvZ25pemVyIiwidGV4dE5vcm1hbGl6YXRpb24iLCJjb25zb2xlIiwid2FybiIsImNyZWF0ZVJlY29nbml6ZXIiLCJsb29zZUV2ZW50cyIsIlNwZWVjaEdyYW1tYXJMaXN0IiwiU3BlZWNoUmVjb2duaXRpb24iLCJjYW5jZWxBbGwiLCJwdXNoIiwiU3BlZWNoU3ludGhlc2lzIiwidXR0ZXJhbmNlIiwiY29udHJvbGxlciIsIkFib3J0Q29udHJvbGxlciIsInNpZ25hbCIsImFib3J0IiwiYmluZCIsInJlc3VsdCIsImRpc3BhdGNoRXZlbnQiLCJhdWRpb1N0cmVhbSIsImZvcm1hdCIsInN0cmVhbVJlYWRlciIsIm1lc3NhZ2UiLCJjYXRjaCIsImVycm9yIiwidGVzdCIsIkV2ZW50VGFyZ2V0U2hpbSIsInNwZWVjaFN5bnRoZXNpcyIsIlNwZWVjaFN5bnRoZXNpc1V0dGVyYW5jZSIsIlNwZWVjaFN5bnRoZXNpc0F1ZGlvU3RyZWFtVXR0ZXJhbmNlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBRUE7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7OztBQUVlLHdCQVFaO0FBQUEsTUFQREEsWUFPQyxRQVBEQSxZQU9DO0FBQUEsTUFOREMsZUFNQyxRQU5EQSxlQU1DO0FBQUEsMkJBTERDLFFBS0M7QUFBQSxNQUxEQSxRQUtDLDhCQUxVO0FBQ1RDLElBQUFBLFlBQVksRUFBRUMsTUFBTSxDQUFDRCxZQUFQLElBQXVCQyxNQUFNLENBQUNDO0FBRG5DLEdBS1Y7QUFBQSxNQUZEQyxVQUVDLFFBRkRBLFVBRUM7QUFBQSxNQUREQyxpQkFD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bkI7O0FBZ0VYLGlEQUFxQmhCLGVBQXJCLEVBQXNDLGVBQXRDO0FBRUEsV0FBTztBQUNMSixNQUFBQSxpQkFBaUIsRUFBakJBLGlCQURLO0FBRUxDLE1BQUFBLGlCQUFpQixFQUFqQkEsaUJBRks7QUFHTG9CLE1BQUFBLGVBQWUsRUFBRSxJQUFJakIsZUFBSixFQUhaO0FBSUxrQixNQUFBQSx3QkFBd0IsRUFBRUM7QUFKckIsS0FBUDtBQU1ELEdBeEVEO0FBeUVEIiwic291cmNlUm9vdCI6ImRpcmVjdGxpbmVzcGVlY2g6Ly8vIiwic291cmNlc0NvbnRlbnQiOlsiLyogZXNsaW50IGNsYXNzLW1ldGhvZHMtdXNlLXRoaXM6IFtcImVycm9yXCIsIHsgXCJleGNlcHRNZXRob2RzXCI6IFtcImNhbmNlbFwiLCBcImdldFZvaWNlc1wiLCBcInNwZWFrXCJdIH1dICovXG5cbmltcG9ydCB7IGNyZWF0ZVNwZWVjaFJlY29nbml0aW9uUG9ueWZpbGxGcm9tUmVjb2duaXplciB9IGZyb20gJ3dlYi1zcGVlY2gtY29nbml0aXZlLXNlcnZpY2VzL2xpYi9TcGVlY2hTZXJ2aWNlcy9TcGVlY2hUb1RleHQnO1xuXG5pbXBvcnQgQWJvcnRDb250cm9sbGVyIGZyb20gJ2Fib3J0LWNvbnRyb2xsZXItZXM1JztcbmltcG9ydCBjcmVhdGVDdXN0b21FdmVudCBmcm9tICcuL2NyZWF0ZUN1c3RvbUV2ZW50JztcbmltcG9ydCBjcmVhdGVFcnJvckV2ZW50IGZyb20gJy4vY3JlYXRlRXJyb3JFdmVudCc7XG5pbXBvcnQgY3JlYXRlVGFza1F1ZXVlIGZyb20gJy4vY3JlYXRlVGFza1F1ZXVlJztcbmltcG9ydCBFdmVudFRhcmdldFNoaW0sIHsgZGVmaW5lRXZlbnRBdHRyaWJ1dGUgfSBmcm9tICdldmVudC10YXJnZXQtc2hpbS1lczUnO1xuaW1wb3J0IHBsYXlDb2duaXRpdmVTZXJ2aWNlc1N0cmVhbSBmcm9tICcuL3BsYXlDb2duaXRpdmVTZXJ2aWNlc1N0cmVhbSc7XG5pbXBvcnQgcGxheVdoaXRlTm9pc2UgZnJvbSAnLi9wbGF5V2hpdGVOb2lzZSc7XG5pbXBvcnQgU3BlZWNoU3ludGhlc2lzQXVkaW9TdHJlYW1VdHRlcmFuY2UgZnJvbSAnLi9TcGVlY2hTeW50aGVzaXNBdWRpb1N0cmVhbVV0dGVyYW5jZSc7XG5cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uKHtcbiAgYXVkaW9Db250ZXh0LFxuICBlbmFibGVUZWxlbWV0cnksXG4gIHBvbnlmaWxsID0ge1xuICAgIEF1ZGlvQ29udGV4dDogd2luZG93LkF1ZGlvQ29udGV4dCB8fCB3aW5kb3cud2Via2l0QXVkaW9Db250ZXh0XG4gIH0sXG4gIHJlY29nbml6ZXIsXG4gIHRleHROb3JtYWxpemF0aW9uXG59KSB7XG4gIGlmICghcG9ueWZpbGwuQXVkaW9Db250ZXh0KSB7XG4gICAgY29uc29sZS53YXJuKFxuICAgICAgJ2JvdGZyYW1ld29yay1kaXJlY3RsaW5lc3BlZWNoLXNkazogVGhpcyBicm93c2VyIGRvZXMgbm90IHN1cHBvcnQgV2ViIEF1ZGlvIEFQSS4gU3BlZWNoIHN1cHBvcnQgaXMgZGlzYWJsZWQuJ1xuICAgICk7XG5cbiAgICByZXR1cm4gKCkgPT4gKHt9KTtcbiAgfVxuXG4gIHJldHVybiAoKSA9PiB7XG4gICAgY29uc3QgeyBTcGVlY2hHcmFtbWFyTGlzdCwgU3BlZWNoUmVjb2duaXRpb24gfSA9IGNyZWF0ZVNwZWVjaFJlY29nbml0aW9uUG9ueWZpbGxGcm9tUmVjb2duaXplcih7XG4gICAgICBjcmVhdGVSZWNvZ25pemVyOiAoKSA9PiByZWNvZ25pemVyLFxuICAgICAgZW5hYmxlVGVsZW1ldHJ5LFxuICAgICAgbG9vc2VFdmVudHM6IHRydWUsXG4gICAgICB0ZXh0Tm9ybWFsaXphdGlvblxuICAgIH0pO1xuXG4gICAgaWYgKCFhdWRpb0NvbnRleHQpIHtcbiAgICAgIGF1ZGlvQ29udGV4dCA9IG5ldyBwb255ZmlsbC5BdWRpb0NvbnRleHQoKTtcbiAgICB9XG5cbiAgICBjb25zdCB7IGNhbmNlbEFsbCwgcHVzaCB9ID0gY3JlYXRlVGFza1F1ZXVlKCk7XG5cbiAgICBjbGFzcyBTcGVlY2hTeW50aGVzaXMgZXh0ZW5kcyBFdmVudFRhcmdldFNoaW0ge1xuICAgICAgY2FuY2VsKCkge1xuICAgICAgICBjYW5jZWxBbGwoKTtcbiAgICAgIH1cblxuICAgICAgLy8gUmV0dXJucyBhbiBlbXB0eSBhcnJheS5cbiAgICAgIC8vIFN5bnRoZXNpcyBpcyBkb25lIG9uIHRoZSBib3Qgc2lkZSwgdGhlIGNvbnRlbnQgb2YgdGhlIHZvaWNlIGxpc3QgaXMgbm90IG1lYW5pbmdmdWwgb24gdGhlIGNsaWVudCBzaWRlLlxuICAgICAgZ2V0Vm9pY2VzKCkge1xuICAgICAgICByZXR1cm4gW107XG4gICAgICB9XG5cbiAgICAgIHNwZWFrKHV0dGVyYW5jZSkge1xuICAgICAgICBjb25zdCB7IHJlc3VsdCB9ID0gcHVzaCgoKSA9PiB7XG4gICAgICAgICAgY29uc3QgY29udHJvbGxlciA9IG5ldyBBYm9ydENvbnRyb2xsZXIoKTtcbiAgICAgICAgICBjb25zdCB7IHNpZ25hbCB9ID0gY29udHJvbGxlcjtcblxuICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBhYm9ydDogY29udHJvbGxlci5hYm9ydC5iaW5kKGNvbnRyb2xsZXIpLFxuICAgICAgICAgICAgcmVzdWx0OiAoYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgICB1dHRlcmFuY2UuZGlzcGF0Y2hFdmVudChjcmVhdGVDdXN0b21FdmVudCgnc3RhcnQnKSk7XG5cbiAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICBpZiAodXR0ZXJhbmNlLmF1ZGlvU3RyZWFtKSB7XG4gICAgICAgICAgICAgICAgICBjb25zdCB7IGZvcm1hdCwgc3RyZWFtUmVhZGVyIH0gPSB1dHRlcmFuY2UuYXVkaW9TdHJlYW07XG5cbiAgICAgICAgICAgICAgICAgIGF3YWl0IHBsYXlDb2duaXRpdmVTZXJ2aWNlc1N0cmVhbShhdWRpb0NvbnRleHQsIGZvcm1hdCwgc3RyZWFtUmVhZGVyLCB7IHNpZ25hbCB9KTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgYXdhaXQgcGxheVdoaXRlTm9pc2UoYXVkaW9Db250ZXh0KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICAgICAgLy8gRWl0aGVyIGRpc3BhdGNoIFwiZW5kXCIgb3IgXCJlcnJvclwiIGV2ZW50LCBidXQgbm90IGJvdGhcbiAgICAgICAgICAgICAgICBpZiAoZXJyb3IubWVzc2FnZSAhPT0gJ2Fib3J0ZWQnKSB7XG4gICAgICAgICAgICAgICAgICByZXR1cm4gdXR0ZXJhbmNlLmRpc3BhdGNoRXZlbnQoY3JlYXRlRXJyb3JFdmVudChlcnJvcikpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgIHV0dGVyYW5jZS5kaXNwYXRjaEV2ZW50KGNyZWF0ZUN1c3RvbUV2ZW50KCdlbmQnKSk7XG4gICAgICAgICAgICB9KSgpXG4gICAgICAgICAgfTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gQ2F0Y2hpbmcgdGhlIGVycm9yIHRvIHByZXZlbnQgdW5jYXVnaHQgcHJvbWlzZSBlcnJvciBkdWUgdG8gY2FuY2VsbGF0aW9uLlxuICAgICAgICByZXN1bHQuY2F0Y2goZXJyb3IgPT4ge1xuICAgICAgICAgIGlmICghL15jYW5jZWxsZWQvaXUudGVzdChlcnJvci5tZXNzYWdlKSkge1xuICAgICAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBkZWZpbmVFdmVudEF0dHJpYnV0ZShTcGVlY2hTeW50aGVzaXMsICd2b2ljZXNjaGFuZ2VkJyk7XG5cbiAgICByZXR1cm4ge1xuICAgICAgU3BlZWNoR3JhbW1hckxpc3QsXG4gICAgICBTcGVlY2hSZWNvZ25pdGlvbixcbiAgICAgIHNwZWVjaFN5bnRoZXNpczogbmV3IFNwZWVjaFN5bnRoZXNpcygpLFxuICAgICAgU3BlZWNoU3ludGhlc2lzVXR0ZXJhbmNlOiBTcGVlY2hTeW50aGVzaXNBdWRpb1N0cmVhbVV0dGVyYW5jZVxuICAgIH07XG4gIH07XG59XG4iXX0=