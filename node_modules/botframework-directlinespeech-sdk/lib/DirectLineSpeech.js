"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

var _observable = _interopRequireDefault(require("core-js/features/observable"));

var _mathRandom = _interopRequireDefault(require("math-random"));

var _shareObservable = _interopRequireDefault(require("./shareObservable"));

var _SpeechSynthesisAudioStreamUtterance = _interopRequireDefault(require("./SpeechSynthesisAudioStreamUtterance"));

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { (0, _defineProperty2.default)(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

function randomActivityId() {
  return (0, _mathRandom.default)().toString(36).substr(2);
}

var DirectLineSpeech = /*#__PURE__*/function () {
  function DirectLineSpeech(_ref) {
    var _this = this;

    var dialogServiceConnector = _ref.dialogServiceConnector;
    (0, _classCallCheck2.default)(this, DirectLineSpeech);
    var connectionStatusObserver;
    this.dialogServiceConnector = dialogServiceConnector;
    this.activity$ = (0, _shareObservable.default)(new _observable.default(function (observer) {
      _this._activityObserver = observer;
      connectionStatusObserver.next(0);
      connectionStatusObserver.next(1);
      connectionStatusObserver.next(2);
    }));
    this.connectionStatus$ = (0, _shareObservable.default)(new _observable.default(function (observer) {
      connectionStatusObserver = observer;
    }));

    dialogServiceConnector.activityReceived = function (_, _ref2) {
      var activity = _ref2.activity,
          audioStream = _ref2.audioStream;

      try {
        _this._activityObserver && _this._activityObserver.next(_objectSpread(_objectSpread({}, activity), {}, {
          channelData: _objectSpread(_objectSpread({}, activity.channelData), {}, {
            speechSynthesisUtterance: new _SpeechSynthesisAudioStreamUtterance.default(audioStream)
          }),
          from: _objectSpread(_objectSpread({}, activity.from), {}, {
            // Since DLSpeech service never ACK our outgoing activity, this activity must be from bot.
            role: 'bot'
          }),
          // Direct Line Speech server currently do not timestamp outgoing activities.
          // Thus, it will be easier to just re-timestamp every incoming/outgoing activities using local time.
          timestamp: new Date().toISOString()
        }));
      } catch (error) {
        console.error(error);
      }
    };
  }

  (0, _createClass2.default)(DirectLineSpeech, [{
    key: "end",
    value: function end() {
      try {
        this.dialogServiceConnector.close();
      } catch (err) {
        if (!~err.message.indexOf('already disposed')) {
          throw err;
        }
      }
    }
  }, {
    key: "postActivity",
    value: function postActivity(activity) {
      // Currently, Web Chat set user ID on all outgoing activities.
      // As Direct Line Speech maintains its own user ID, Web Chat should not set the user ID.
      // TODO: [P2] We should move user ID into options of DirectLineJS, instead of Web Chat.
      activity = _objectSpread(_objectSpread({}, activity), {}, {
        from: {
          role: 'user'
        }
      });

      try {
        // TODO: [P1] Direct Line Speech server currently do not ack the outgoing activities with any activity ID or timestamp.
        var pseudoActivityId = randomActivityId();
        var isSpeech = !!(activity.channelData && activity.channelData.speech); // Do not send the activity if it was from speech.

        if (!isSpeech) {
          this.dialogServiceConnector.sendActivityAsync(activity);
        }

        this._activityObserver && this._activityObserver.next(_objectSpread(_objectSpread({}, activity), {}, {
          id: pseudoActivityId,
          timestamp: new Date().toISOString()
        }));
        return _observable.default.of(pseudoActivityId);
      } catch (err) {
        return new _observable.default(function (observer) {
          return observer.error(err);
        });
      }
    }
  }]);
  return DirectLineSpeech;
}(); // Interfaces not yet implemented in Web Chat:
// referenceGrammarId?: string,
// getSessionId? : () => Observable<string>


exports.default = DirectLineSpeech;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9EaXJlY3RMaW5lU3BlZWNoLmpzIl0sIm5hbWVzIjpbInJhbmRvbUFjdGl2aXR5SWQiLCJ0b1N0cmluZyIsInN1YnN0ciIsIkRpcmVjdExpbmVTcGVlY2giLCJkaWFsb2dTZXJ2aWNlQ29ubmVjdG9yIiwiY29ubmVjdGlvblN0YXR1c09ic2VydmVyIiwiYWN0aXZpdHkkIiwiT2JzZXJ2YWJsZSIsIm9ic2VydmVyIiwiX2FjdGl2aXR5T2JzZXJ2ZXIiLCJuZXh0IiwiY29ubmVjdGlvblN0YXR1cyQiLCJhY3Rpdml0eVJlY2VpdmVkIiwiXyIsImFjdGl2aXR5IiwiYXVkaW9TdHJlYW0iLCJjaGFubmVsRGF0YSIsInNwZWVjaFN5bnRoZXNpc1V0dGVyYW5jZSIsIlNwZWVjaFN5bnRoZXNpc0F1ZGlvU3RyZWFtVXR0ZXJhbmNlIiwiZnJvbSIsInJvbGUiLCJ0aW1lc3RhbXAiLCJEYXRlIiwidG9JU09TdHJpbmciLCJlcnJvciIsImNvbnNvbGUiLCJjbG9zZSIsImVyciIsIm1lc3NhZ2UiLCJpbmRleE9mIiwicHNldWRvQWN0aXZpdHlJZCIsImlzU3BlZWNoIiwic3BlZWNoIiwic2VuZEFjdGl2aXR5QXN5bmMiLCJpZCIsIm9mIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7QUFFQTs7QUFDQTs7QUFFQTs7QUFDQTs7Ozs7O0FBRUEsU0FBU0EsZ0JBQVQsR0FBNEI7QUFDMUIsU0FBTywyQkFDSkMsUUFESSxDQUNLLEVBREwsRUFFSkMsTUFGSSxDQUVHLENBRkgsQ0FBUDtBQUdEOztJQUVvQkMsZ0I7QUFDbkIsa0NBQXdDO0FBQUE7O0FBQUEsUUFBMUJDLHNCQUEwQixRQUExQkEsc0JBQTBCO0FBQUE7QUFDdEMsUUFBSUMsd0JBQUo7QUFFQSxTQUFLRCxzQkFBTCxHQUE4QkEsc0JBQTlCO0FBRUEsU0FBS0UsU0FBTCxHQUFpQiw4QkFDZixJQUFJQyxtQkFBSixDQUFlLFVBQUFDLFFBQVEsRUFBSTtBQUN6QixNQUFBLEtBQUksQ0FBQ0MsaUJBQUwsR0FBeUJELFFBQXpCO0FBRUFILE1BQUFBLHdCQUF3QixDQUFDSyxJQUF6QixDQUE4QixDQUE5QjtBQUNBTCxNQUFBQSx3QkFBd0IsQ0FBQ0ssSUFBekIsQ0FBOEIsQ0FBOUI7QUFDQUwsTUFBQUEsd0JBQXdCLENBQUNLLElBQXpCLENBQThCLENBQTlCO0FBQ0QsS0FORCxDQURlLENBQWpCO0FBVUEsU0FBS0MsaUJBQUwsR0FBeUIsOEJBQ3ZCLElBQUlKLG1CQUFKLENBQWUsVUFBQUMsUUFBUSxFQUFJO0FBQ3pCSCxNQUFBQSx3QkFBd0IsR0FBR0csUUFBM0I7QUFDRCxLQUZELENBRHVCLENBQXpCOztBQU1BSixJQUFBQSxzQkFBc0IsQ0FBQ1EsZ0JBQXZCLEdBQTBDLFVBQUNDLENBQUQsU0FBa0M7QUFBQSxVQUE1QkMsUUFBNEIsU0FBNUJBLFFBQTRCO0FBQUEsVUFBbEJDLFdBQWtCLFNBQWxCQSxXQUFrQjs7QUFDMUUsVUFBSTtBQUNGLFFBQUEsS0FBSSxDQUFDTixpQkFBTCxJQUNFLEtBQUksQ0FBQ0EsaUJBQUwsQ0FBdUJDLElBQXZCLGlDQUNLSSxRQURMO0FBRUVFLFVBQUFBLFdBQVcsa0NBQ05GLFFBQVEsQ0FBQ0UsV0FESDtBQUVUQyxZQUFBQSx3QkFBd0IsRUFBRSxJQUFJQyw0Q0FBSixDQUF3Q0gsV0FBeEM7QUFGakIsWUFGYjtBQU1FSSxVQUFBQSxJQUFJLGtDQUNDTCxRQUFRLENBQUNLLElBRFY7QUFFRjtBQUNBQyxZQUFBQSxJQUFJLEVBQUU7QUFISixZQU5OO0FBV0U7QUFDQTtBQUNBQyxVQUFBQSxTQUFTLEVBQUUsSUFBSUMsSUFBSixHQUFXQyxXQUFYO0FBYmIsV0FERjtBQWdCRCxPQWpCRCxDQWlCRSxPQUFPQyxLQUFQLEVBQWM7QUFDZEMsUUFBQUEsT0FBTyxDQUFDRCxLQUFSLENBQWNBLEtBQWQ7QUFDRDtBQUNGLEtBckJEO0FBc0JEOzs7OzBCQUVLO0FBQ0osVUFBSTtBQUNGLGFBQUtwQixzQkFBTCxDQUE0QnNCLEtBQTVCO0FBQ0QsT0FGRCxDQUVFLE9BQU9DLEdBQVAsRUFBWTtBQUNaLFlBQUksQ0FBQyxDQUFDQSxHQUFHLENBQUNDLE9BQUosQ0FBWUMsT0FBWixDQUFvQixrQkFBcEIsQ0FBTixFQUErQztBQUM3QyxnQkFBTUYsR0FBTjtBQUNEO0FBQ0Y7QUFDRjs7O2lDQUVZYixRLEVBQVU7QUFDckI7QUFDQTtBQUNBO0FBQ0FBLE1BQUFBLFFBQVEsbUNBQ0hBLFFBREc7QUFFTkssUUFBQUEsSUFBSSxFQUFFO0FBQUVDLFVBQUFBLElBQUksRUFBRTtBQUFSO0FBRkEsUUFBUjs7QUFLQSxVQUFJO0FBQ0Y7QUFDQSxZQUFNVSxnQkFBZ0IsR0FBRzlCLGdCQUFnQixFQUF6QztBQUNBLFlBQU0rQixRQUFRLEdBQUcsQ0FBQyxFQUFFakIsUUFBUSxDQUFDRSxXQUFULElBQXdCRixRQUFRLENBQUNFLFdBQVQsQ0FBcUJnQixNQUEvQyxDQUFsQixDQUhFLENBS0Y7O0FBQ0EsWUFBSSxDQUFDRCxRQUFMLEVBQWU7QUFDYixlQUFLM0Isc0JBQUwsQ0FBNEI2QixpQkFBNUIsQ0FBOENuQixRQUE5QztBQUNEOztBQUVELGFBQUtMLGlCQUFMLElBQ0UsS0FBS0EsaUJBQUwsQ0FBdUJDLElBQXZCLGlDQUNLSSxRQURMO0FBRUVvQixVQUFBQSxFQUFFLEVBQUVKLGdCQUZOO0FBR0VULFVBQUFBLFNBQVMsRUFBRSxJQUFJQyxJQUFKLEdBQVdDLFdBQVg7QUFIYixXQURGO0FBT0EsZUFBT2hCLG9CQUFXNEIsRUFBWCxDQUFjTCxnQkFBZCxDQUFQO0FBQ0QsT0FsQkQsQ0FrQkUsT0FBT0gsR0FBUCxFQUFZO0FBQ1osZUFBTyxJQUFJcEIsbUJBQUosQ0FBZSxVQUFBQyxRQUFRO0FBQUEsaUJBQUlBLFFBQVEsQ0FBQ2dCLEtBQVQsQ0FBZUcsR0FBZixDQUFKO0FBQUEsU0FBdkIsQ0FBUDtBQUNEO0FBQ0Y7OztLQUdIO0FBQ0E7QUFDQSIsInNvdXJjZVJvb3QiOiJkaXJlY3RsaW5lc3BlZWNoOi8vLyIsInNvdXJjZXNDb250ZW50IjpbIi8qIGVzbGludCBuby1tYWdpYy1udW1iZXJzOiBbXCJlcnJvclwiLCB7IFwiaWdub3JlXCI6IFswLCAxLCAyLCAzNl0gfV0gKi9cblxuaW1wb3J0IE9ic2VydmFibGUgZnJvbSAnY29yZS1qcy9mZWF0dXJlcy9vYnNlcnZhYmxlJztcbmltcG9ydCByYW5kb20gZnJvbSAnbWF0aC1yYW5kb20nO1xuXG5pbXBvcnQgc2hhcmVPYnNlcnZhYmxlIGZyb20gJy4vc2hhcmVPYnNlcnZhYmxlJztcbmltcG9ydCBTcGVlY2hTeW50aGVzaXNBdWRpb1N0cmVhbVV0dGVyYW5jZSBmcm9tICcuL1NwZWVjaFN5bnRoZXNpc0F1ZGlvU3RyZWFtVXR0ZXJhbmNlJztcblxuZnVuY3Rpb24gcmFuZG9tQWN0aXZpdHlJZCgpIHtcbiAgcmV0dXJuIHJhbmRvbSgpXG4gICAgLnRvU3RyaW5nKDM2KVxuICAgIC5zdWJzdHIoMik7XG59XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIERpcmVjdExpbmVTcGVlY2gge1xuICBjb25zdHJ1Y3Rvcih7IGRpYWxvZ1NlcnZpY2VDb25uZWN0b3IgfSkge1xuICAgIGxldCBjb25uZWN0aW9uU3RhdHVzT2JzZXJ2ZXI7XG5cbiAgICB0aGlzLmRpYWxvZ1NlcnZpY2VDb25uZWN0b3IgPSBkaWFsb2dTZXJ2aWNlQ29ubmVjdG9yO1xuXG4gICAgdGhpcy5hY3Rpdml0eSQgPSBzaGFyZU9ic2VydmFibGUoXG4gICAgICBuZXcgT2JzZXJ2YWJsZShvYnNlcnZlciA9PiB7XG4gICAgICAgIHRoaXMuX2FjdGl2aXR5T2JzZXJ2ZXIgPSBvYnNlcnZlcjtcblxuICAgICAgICBjb25uZWN0aW9uU3RhdHVzT2JzZXJ2ZXIubmV4dCgwKTtcbiAgICAgICAgY29ubmVjdGlvblN0YXR1c09ic2VydmVyLm5leHQoMSk7XG4gICAgICAgIGNvbm5lY3Rpb25TdGF0dXNPYnNlcnZlci5uZXh0KDIpO1xuICAgICAgfSlcbiAgICApO1xuXG4gICAgdGhpcy5jb25uZWN0aW9uU3RhdHVzJCA9IHNoYXJlT2JzZXJ2YWJsZShcbiAgICAgIG5ldyBPYnNlcnZhYmxlKG9ic2VydmVyID0+IHtcbiAgICAgICAgY29ubmVjdGlvblN0YXR1c09ic2VydmVyID0gb2JzZXJ2ZXI7XG4gICAgICB9KVxuICAgICk7XG5cbiAgICBkaWFsb2dTZXJ2aWNlQ29ubmVjdG9yLmFjdGl2aXR5UmVjZWl2ZWQgPSAoXywgeyBhY3Rpdml0eSwgYXVkaW9TdHJlYW0gfSkgPT4ge1xuICAgICAgdHJ5IHtcbiAgICAgICAgdGhpcy5fYWN0aXZpdHlPYnNlcnZlciAmJlxuICAgICAgICAgIHRoaXMuX2FjdGl2aXR5T2JzZXJ2ZXIubmV4dCh7XG4gICAgICAgICAgICAuLi5hY3Rpdml0eSxcbiAgICAgICAgICAgIGNoYW5uZWxEYXRhOiB7XG4gICAgICAgICAgICAgIC4uLmFjdGl2aXR5LmNoYW5uZWxEYXRhLFxuICAgICAgICAgICAgICBzcGVlY2hTeW50aGVzaXNVdHRlcmFuY2U6IG5ldyBTcGVlY2hTeW50aGVzaXNBdWRpb1N0cmVhbVV0dGVyYW5jZShhdWRpb1N0cmVhbSlcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBmcm9tOiB7XG4gICAgICAgICAgICAgIC4uLmFjdGl2aXR5LmZyb20sXG4gICAgICAgICAgICAgIC8vIFNpbmNlIERMU3BlZWNoIHNlcnZpY2UgbmV2ZXIgQUNLIG91ciBvdXRnb2luZyBhY3Rpdml0eSwgdGhpcyBhY3Rpdml0eSBtdXN0IGJlIGZyb20gYm90LlxuICAgICAgICAgICAgICByb2xlOiAnYm90J1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIC8vIERpcmVjdCBMaW5lIFNwZWVjaCBzZXJ2ZXIgY3VycmVudGx5IGRvIG5vdCB0aW1lc3RhbXAgb3V0Z29pbmcgYWN0aXZpdGllcy5cbiAgICAgICAgICAgIC8vIFRodXMsIGl0IHdpbGwgYmUgZWFzaWVyIHRvIGp1c3QgcmUtdGltZXN0YW1wIGV2ZXJ5IGluY29taW5nL291dGdvaW5nIGFjdGl2aXRpZXMgdXNpbmcgbG9jYWwgdGltZS5cbiAgICAgICAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpXG4gICAgICAgICAgfSk7XG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICBjb25zb2xlLmVycm9yKGVycm9yKTtcbiAgICAgIH1cbiAgICB9O1xuICB9XG5cbiAgZW5kKCkge1xuICAgIHRyeSB7XG4gICAgICB0aGlzLmRpYWxvZ1NlcnZpY2VDb25uZWN0b3IuY2xvc2UoKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGlmICghfmVyci5tZXNzYWdlLmluZGV4T2YoJ2FscmVhZHkgZGlzcG9zZWQnKSkge1xuICAgICAgICB0aHJvdyBlcnI7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcG9zdEFjdGl2aXR5KGFjdGl2aXR5KSB7XG4gICAgLy8gQ3VycmVudGx5LCBXZWIgQ2hhdCBzZXQgdXNlciBJRCBvbiBhbGwgb3V0Z29pbmcgYWN0aXZpdGllcy5cbiAgICAvLyBBcyBEaXJlY3QgTGluZSBTcGVlY2ggbWFpbnRhaW5zIGl0cyBvd24gdXNlciBJRCwgV2ViIENoYXQgc2hvdWxkIG5vdCBzZXQgdGhlIHVzZXIgSUQuXG4gICAgLy8gVE9ETzogW1AyXSBXZSBzaG91bGQgbW92ZSB1c2VyIElEIGludG8gb3B0aW9ucyBvZiBEaXJlY3RMaW5lSlMsIGluc3RlYWQgb2YgV2ViIENoYXQuXG4gICAgYWN0aXZpdHkgPSB7XG4gICAgICAuLi5hY3Rpdml0eSxcbiAgICAgIGZyb206IHsgcm9sZTogJ3VzZXInIH1cbiAgICB9O1xuXG4gICAgdHJ5IHtcbiAgICAgIC8vIFRPRE86IFtQMV0gRGlyZWN0IExpbmUgU3BlZWNoIHNlcnZlciBjdXJyZW50bHkgZG8gbm90IGFjayB0aGUgb3V0Z29pbmcgYWN0aXZpdGllcyB3aXRoIGFueSBhY3Rpdml0eSBJRCBvciB0aW1lc3RhbXAuXG4gICAgICBjb25zdCBwc2V1ZG9BY3Rpdml0eUlkID0gcmFuZG9tQWN0aXZpdHlJZCgpO1xuICAgICAgY29uc3QgaXNTcGVlY2ggPSAhIShhY3Rpdml0eS5jaGFubmVsRGF0YSAmJiBhY3Rpdml0eS5jaGFubmVsRGF0YS5zcGVlY2gpO1xuXG4gICAgICAvLyBEbyBub3Qgc2VuZCB0aGUgYWN0aXZpdHkgaWYgaXQgd2FzIGZyb20gc3BlZWNoLlxuICAgICAgaWYgKCFpc1NwZWVjaCkge1xuICAgICAgICB0aGlzLmRpYWxvZ1NlcnZpY2VDb25uZWN0b3Iuc2VuZEFjdGl2aXR5QXN5bmMoYWN0aXZpdHkpO1xuICAgICAgfVxuXG4gICAgICB0aGlzLl9hY3Rpdml0eU9ic2VydmVyICYmXG4gICAgICAgIHRoaXMuX2FjdGl2aXR5T2JzZXJ2ZXIubmV4dCh7XG4gICAgICAgICAgLi4uYWN0aXZpdHksXG4gICAgICAgICAgaWQ6IHBzZXVkb0FjdGl2aXR5SWQsXG4gICAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKClcbiAgICAgICAgfSk7XG5cbiAgICAgIHJldHVybiBPYnNlcnZhYmxlLm9mKHBzZXVkb0FjdGl2aXR5SWQpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgcmV0dXJuIG5ldyBPYnNlcnZhYmxlKG9ic2VydmVyID0+IG9ic2VydmVyLmVycm9yKGVycikpO1xuICAgIH1cbiAgfVxufVxuXG4vLyBJbnRlcmZhY2VzIG5vdCB5ZXQgaW1wbGVtZW50ZWQgaW4gV2ViIENoYXQ6XG4vLyByZWZlcmVuY2VHcmFtbWFySWQ/OiBzdHJpbmcsXG4vLyBnZXRTZXNzaW9uSWQ/IDogKCkgPT4gT2JzZXJ2YWJsZTxzdHJpbmc+XG4iXX0=