"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = createMultiBufferingPlayer;
// Currently, Web Chat uses a triple-buffer approach.
var NUM_BUFFER = 3;

function zeroBuffer(buffer) {
  var channels = buffer.numberOfChannels;

  for (var channel = 0; channel < channels; channel++) {
    var audioData = buffer.getChannelData(channel);
    [].fill.call(audioData, 0);
  }
}

function copyBuffer(buffer, multiChannelArray) {
  var channels = buffer.numberOfChannels;

  for (var channel = 0; channel < channels; channel++) {
    var float32Array = multiChannelArray[channel]; // Note that Safari does not support AudioBuffer.copyToChannel yet.

    if (buffer.copyToChannel) {
      buffer.copyToChannel(float32Array, channel);
    } else {
      var float32ArrayLength = float32Array.length;
      var perChannelBuffer = buffer.getChannelData(channel);

      for (var offset = 0; offset < float32ArrayLength; offset++) {
        perChannelBuffer[offset] = float32Array[offset];
      }
    }
  }
} // This is a multi-buffering player. Users can keep pushing buffer to Web Chat.
// The buffer, realized as BufferSource, is queued to AudioContext.
// Data will be queued as quickly and frequently as possible.
// Web Chat does not support progressive buffering (pushing a partial buffer) and there are currently no plans to implement.


function createMultiBufferingPlayer(audioContext, _ref, numSamplePerBuffer) {
  var channels = _ref.channels,
      samplesPerSec = _ref.samplesPerSec;
  var freeBuffers = new Array(NUM_BUFFER).fill().map(function () {
    return audioContext.createBuffer(channels, numSamplePerBuffer, samplesPerSec);
  });
  var queuedBufferSources = [];
  var nextSchedule;
  var queue = [];

  var playNext = function playNext() {
    if (typeof nextSchedule !== 'number') {
      nextSchedule = audioContext.currentTime;
    }

    var bufferSource = audioContext.createBufferSource();
    var multiChannelArray = queue.shift();

    if (typeof multiChannelArray === 'function') {
      // If the queued item is a function, it is because the user called "flush".
      // The "flush" function will callback when all queued buffers before the "flush" call have played.
      multiChannelArray();
    } else if (multiChannelArray) {
      var nextBuffer = freeBuffers.shift(); // If all buffers are currently occupied, prepend the data back to the queue.
      // When one of the buffers finish, it will call playNext() again to pick up items from the queue.

      if (!nextBuffer) {
        queue.unshift(multiChannelArray);
        return;
      }

      zeroBuffer(nextBuffer);
      copyBuffer(nextBuffer, multiChannelArray);
      bufferSource.buffer = nextBuffer;
      bufferSource.connect(audioContext.destination);
      bufferSource.start(nextSchedule); // All BufferSource data that is currently queued will be stored at the AudioContext, via bufferSource.start().
      // This is for cancelAll() to effectively cancel all BufferSource queued at the AudioContext.

      queuedBufferSources.push(bufferSource);
      nextSchedule += nextBuffer.duration;
      bufferSource.addEventListener('ended', function () {
        queuedBufferSources = queuedBufferSources.filter(function (target) {
          return target !== bufferSource;
        }); // Declare the buffer is free to pick up on the next iteration.

        freeBuffers.push(nextBuffer);
        playNext();
      });
    }
  };

  return {
    cancelAll: function cancelAll() {
      queue.splice(0); // Although all buffers are cleared, there are still some BufferSources queued at the AudioContext that need to be stopped.

      queuedBufferSources.forEach(function (bufferSource) {
        return bufferSource.stop();
      });
    },
    flush: function flush() {
      return new Promise(function (resolve) {
        return queue.push(resolve);
      });
    },
    push: function push(multiChannelArray) {
      if (!multiChannelArray) {
        throw new Error('multiChannelArray must not be falsy.');
      }

      queue.push(multiChannelArray);
      playNext();
    }
  };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9jcmVhdGVNdWx0aUJ1ZmZlcmluZ1BsYXllci5qcyJdLCJuYW1lcyI6WyJOVU1fQlVGRkVSIiwiemVyb0J1ZmZlciIsImJ1ZmZlciIsImNoYW5uZWxzIiwibnVtYmVyT2ZDaGFubmVscyIsImNoYW5uZWwiLCJhdWRpb0RhdGEiLCJnZXRDaGFubmVsRGF0YSIsImZpbGwiLCJjYWxsIiwiY29weUJ1ZmZlciIsIm11bHRpQ2hhbm5lbEFycmF5IiwiZmxvYXQzMkFycmF5IiwiY29weVRvQ2hhbm5lbCIsImZsb2F0MzJBcnJheUxlbmd0aCIsImxlbmd0aCIsInBlckNoYW5uZWxCdWZmZXIiLCJvZmZzZXQiLCJjcmVhdGVNdWx0aUJ1ZmZlcmluZ1BsYXllciIsImF1ZGlvQ29udGV4dCIsIm51bVNhbXBsZVBlckJ1ZmZlciIsInNhbXBsZXNQZXJTZWMiLCJmcmVlQnVmZmVycyIsIkFycmF5IiwibWFwIiwiY3JlYXRlQnVmZmVyIiwicXVldWVkQnVmZmVyU291cmNlcyIsIm5leHRTY2hlZHVsZSIsInF1ZXVlIiwicGxheU5leHQiLCJjdXJyZW50VGltZSIsImJ1ZmZlclNvdXJjZSIsImNyZWF0ZUJ1ZmZlclNvdXJjZSIsInNoaWZ0IiwibmV4dEJ1ZmZlciIsInVuc2hpZnQiLCJjb25uZWN0IiwiZGVzdGluYXRpb24iLCJzdGFydCIsInB1c2giLCJkdXJhdGlvbiIsImFkZEV2ZW50TGlzdGVuZXIiLCJmaWx0ZXIiLCJ0YXJnZXQiLCJjYW5jZWxBbGwiLCJzcGxpY2UiLCJmb3JFYWNoIiwic3RvcCIsImZsdXNoIiwiUHJvbWlzZSIsInJlc29sdmUiLCJFcnJvciJdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUE7QUFDQSxJQUFNQSxVQUFVLEdBQUcsQ0FBbkI7O0FBRUEsU0FBU0MsVUFBVCxDQUFvQkMsTUFBcEIsRUFBNEI7QUFDMUIsTUFBTUMsUUFBUSxHQUFHRCxNQUFNLENBQUNFLGdCQUF4Qjs7QUFFQSxPQUFLLElBQUlDLE9BQU8sR0FBRyxDQUFuQixFQUFz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LEdBQVA7QUFrQkQiLCJzb3VyY2VSb290IjoiZGlyZWN0bGluZXNwZWVjaDovLy8iLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDdXJyZW50bHksIFdlYiBDaGF0IHVzZXMgYSB0cmlwbGUtYnVmZmVyIGFwcHJvYWNoLlxuY29uc3QgTlVNX0JVRkZFUiA9IDM7XG5cbmZ1bmN0aW9uIHplcm9CdWZmZXIoYnVmZmVyKSB7XG4gIGNvbnN0IGNoYW5uZWxzID0gYnVmZmVyLm51bWJlck9mQ2hhbm5lbHM7XG5cbiAgZm9yIChsZXQgY2hhbm5lbCA9IDA7IGNoYW5uZWwgPCBjaGFubmVsczsgY2hhbm5lbCsrKSB7XG4gICAgY29uc3QgYXVkaW9EYXRhID0gYnVmZmVyLmdldENoYW5uZWxEYXRhKGNoYW5uZWwpO1xuXG4gICAgW10uZmlsbC5jYWxsKGF1ZGlvRGF0YSwgMCk7XG4gIH1cbn1cblxuZnVuY3Rpb24gY29weUJ1ZmZlcihidWZmZXIsIG11bHRpQ2hhbm5lbEFycmF5KSB7XG4gIGNvbnN0IGNoYW5uZWxzID0gYnVmZmVyLm51bWJlck9mQ2hhbm5lbHM7XG5cbiAgZm9yIChsZXQgY2hhbm5lbCA9IDA7IGNoYW5uZWwgPCBjaGFubmVsczsgY2hhbm5lbCsrKSB7XG4gICAgY29uc3QgZmxvYXQzMkFycmF5ID0gbXVsdGlDaGFubmVsQXJyYXlbY2hhbm5lbF07XG5cbiAgICAvLyBOb3RlIHRoYXQgU2FmYXJpIGRvZXMgbm90IHN1cHBvcnQgQXVkaW9CdWZmZXIuY29weVRvQ2hhbm5lbCB5ZXQuXG4gICAgaWYgKGJ1ZmZlci5jb3B5VG9DaGFubmVsKSB7XG4gICAgICBidWZmZXIuY29weVRvQ2hhbm5lbChmbG9hdDMyQXJyYXksIGNoYW5uZWwpO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCB7IGxlbmd0aDogZmxvYXQzMkFycmF5TGVuZ3RoIH0gPSBmbG9hdDMyQXJyYXk7XG4gICAgICBjb25zdCBwZXJDaGFubmVsQnVmZmVyID0gYnVmZmVyLmdldENoYW5uZWxEYXRhKGNoYW5uZWwpO1xuXG4gICAgICBmb3IgKGxldCBvZmZzZXQgPSAwOyBvZmZzZXQgPCBmbG9hdDMyQXJyYXlMZW5ndGg7IG9mZnNldCsrKSB7XG4gICAgICAgIHBlckNoYW5uZWxCdWZmZXJbb2Zmc2V0XSA9IGZsb2F0MzJBcnJheVtvZmZzZXRdO1xuICAgICAgfVxuICAgIH1cbiAgfVxufVxuXG4vLyBUaGlzIGlzIGEgbXVsdGktYnVmZmVyaW5nIHBsYXllci4gVXNlcnMgY2FuIGtlZXAgcHVzaGluZyBidWZmZXIgdG8gV2ViIENoYXQuXG4vLyBUaGUgYnVmZmVyLCByZWFsaXplZCBhcyBCdWZmZXJTb3VyY2UsIGlzIHF1ZXVlZCB0byBBdWRpb0NvbnRleHQuXG4vLyBEYXRhIHdpbGwgYmUgcXVldWVkIGFzIHF1aWNrbHkgYW5kIGZyZXF1ZW50bHkgYXMgcG9zc2libGUuXG4vLyBXZWIgQ2hhdCBkb2VzIG5vdCBzdXBwb3J0IHByb2dyZXNzaXZlIGJ1ZmZlcmluZyAocHVzaGluZyBhIHBhcnRpYWwgYnVmZmVyKSBhbmQgdGhlcmUgYXJlIGN1cnJlbnRseSBubyBwbGFucyB0byBpbXBsZW1lbnQuXG5cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIGNyZWF0ZU11bHRpQnVmZmVyaW5nUGxheWVyKGF1ZGlvQ29udGV4dCwgeyBjaGFubmVscywgc2FtcGxlc1BlclNlYyB9LCBudW1TYW1wbGVQZXJCdWZmZXIpIHtcbiAgY29uc3QgZnJlZUJ1ZmZlcnMgPSBuZXcgQXJyYXkoTlVNX0JVRkZFUilcbiAgICAuZmlsbCgpXG4gICAgLm1hcCgoKSA9PiBhdWRpb0NvbnRleHQuY3JlYXRlQnVmZmVyKGNoYW5uZWxzLCBudW1TYW1wbGVQZXJCdWZmZXIsIHNhbXBsZXNQZXJTZWMpKTtcbiAgbGV0IHF1ZXVlZEJ1ZmZlclNvdXJjZXMgPSBbXTtcbiAgbGV0IG5leHRTY2hlZHVsZTtcblxuICBjb25zdCBxdWV1ZSA9IFtdO1xuXG4gIGNvbnN0IHBsYXlOZXh0ID0gKCkgPT4ge1xuICAgIGlmICh0eXBlb2YgbmV4dFNjaGVkdWxlICE9PSAnbnVtYmVyJykge1xuICAgICAgbmV4dFNjaGVkdWxlID0gYXVkaW9Db250ZXh0LmN1cnJlbnRUaW1lO1xuICAgIH1cblxuICAgIGNvbnN0IGJ1ZmZlclNvdXJjZSA9IGF1ZGlvQ29udGV4dC5jcmVhdGVCdWZmZXJTb3VyY2UoKTtcbiAgICBjb25zdCBtdWx0aUNoYW5uZWxBcnJheSA9IHF1ZXVlLnNoaWZ0KCk7XG5cbiAgICBpZiAodHlwZW9mIG11bHRpQ2hhbm5lbEFycmF5ID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAvLyBJZiB0aGUgcXVldWVkIGl0ZW0gaXMgYSBmdW5jdGlvbiwgaXQgaXMgYmVjYXVzZSB0aGUgdXNlciBjYWxsZWQgXCJmbHVzaFwiLlxuICAgICAgLy8gVGhlIFwiZmx1c2hcIiBmdW5jdGlvbiB3aWxsIGNhbGxiYWNrIHdoZW4gYWxsIHF1ZXVlZCBidWZmZXJzIGJlZm9yZSB0aGUgXCJmbHVzaFwiIGNhbGwgaGF2ZSBwbGF5ZWQuXG4gICAgICBtdWx0aUNoYW5uZWxBcnJheSgpO1xuICAgIH0gZWxzZSBpZiAobXVsdGlDaGFubmVsQXJyYXkpIHtcbiAgICAgIGNvbnN0IG5leHRCdWZmZXIgPSBmcmVlQnVmZmVycy5zaGlmdCgpO1xuXG4gICAgICAvLyBJZiBhbGwgYnVmZmVycyBhcmUgY3VycmVudGx5IG9jY3VwaWVkLCBwcmVwZW5kIHRoZSBkYXRhIGJhY2sgdG8gdGhlIHF1ZXVlLlxuICAgICAgLy8gV2hlbiBvbmUgb2YgdGhlIGJ1ZmZlcnMgZmluaXNoLCBpdCB3aWxsIGNhbGwgcGxheU5leHQoKSBhZ2FpbiB0byBwaWNrIHVwIGl0ZW1zIGZyb20gdGhlIHF1ZXVlLlxuICAgICAgaWYgKCFuZXh0QnVmZmVyKSB7XG4gICAgICAgIHF1ZXVlLnVuc2hpZnQobXVsdGlDaGFubmVsQXJyYXkpO1xuXG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgemVyb0J1ZmZlcihuZXh0QnVmZmVyKTtcbiAgICAgIGNvcHlCdWZmZXIobmV4dEJ1ZmZlciwgbXVsdGlDaGFubmVsQXJyYXkpO1xuXG4gICAgICBidWZmZXJTb3VyY2UuYnVmZmVyID0gbmV4dEJ1ZmZlcjtcbiAgICAgIGJ1ZmZlclNvdXJjZS5jb25uZWN0KGF1ZGlvQ29udGV4dC5kZXN0aW5hdGlvbik7XG4gICAgICBidWZmZXJTb3VyY2Uuc3RhcnQobmV4dFNjaGVkdWxlKTtcblxuICAgICAgLy8gQWxsIEJ1ZmZlclNvdXJjZSBkYXRhIHRoYXQgaXMgY3VycmVudGx5IHF1ZXVlZCB3aWxsIGJlIHN0b3JlZCBhdCB0aGUgQXVkaW9Db250ZXh0LCB2aWEgYnVmZmVyU291cmNlLnN0YXJ0KCkuXG4gICAgICAvLyBUaGlzIGlzIGZvciBjYW5jZWxBbGwoKSB0byBlZmZlY3RpdmVseSBjYW5jZWwgYWxsIEJ1ZmZlclNvdXJjZSBxdWV1ZWQgYXQgdGhlIEF1ZGlvQ29udGV4dC5cbiAgICAgIHF1ZXVlZEJ1ZmZlclNvdXJjZXMucHVzaChidWZmZXJTb3VyY2UpO1xuXG4gICAgICBuZXh0U2NoZWR1bGUgKz0gbmV4dEJ1ZmZlci5kdXJhdGlvbjtcblxuICAgICAgYnVmZmVyU291cmNlLmFkZEV2ZW50TGlzdGVuZXIoJ2VuZGVkJywgKCkgPT4ge1xuICAgICAgICBxdWV1ZWRCdWZmZXJTb3VyY2VzID0gcXVldWVkQnVmZmVyU291cmNlcy5maWx0ZXIodGFyZ2V0ID0+IHRhcmdldCAhPT0gYnVmZmVyU291cmNlKTtcblxuICAgICAgICAvLyBEZWNsYXJlIHRoZSBidWZmZXIgaXMgZnJlZSB0byBwaWNrIHVwIG9uIHRoZSBuZXh0IGl0ZXJhdGlvbi5cbiAgICAgICAgZnJlZUJ1ZmZlcnMucHVzaChuZXh0QnVmZmVyKTtcbiAgICAgICAgcGxheU5leHQoKTtcbiAgICAgIH0pO1xuICAgIH1cbiAgfTtcblxuICByZXR1cm4ge1xuICAgIGNhbmNlbEFsbDogKCkgPT4ge1xuICAgICAgcXVldWUuc3BsaWNlKDApO1xuXG4gICAgICAvLyBBbHRob3VnaCBhbGwgYnVmZmVycyBhcmUgY2xlYXJlZCwgdGhlcmUgYXJlIHN0aWxsIHNvbWUgQnVmZmVyU291cmNlcyBxdWV1ZWQgYXQgdGhlIEF1ZGlvQ29udGV4dCB0aGF0IG5lZWQgdG8gYmUgc3RvcHBlZC5cbiAgICAgIHF1ZXVlZEJ1ZmZlclNvdXJjZXMuZm9yRWFjaChidWZmZXJTb3VyY2UgPT4gYnVmZmVyU291cmNlLnN0b3AoKSk7XG4gICAgfSxcbiAgICBmbHVzaDogKCkgPT4gbmV3IFByb21pc2UocmVzb2x2ZSA9PiBxdWV1ZS5wdXNoKHJlc29sdmUpKSxcbiAgICBwdXNoOiBtdWx0aUNoYW5uZWxBcnJheSA9PiB7XG4gICAgICBpZiAoIW11bHRpQ2hhbm5lbEFycmF5KSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignbXVsdGlDaGFubmVsQXJyYXkgbXVzdCBub3QgYmUgZmFsc3kuJyk7XG4gICAgICB9XG5cbiAgICAgIHF1ZXVlLnB1c2gobXVsdGlDaGFubmVsQXJyYXkpO1xuXG4gICAgICBwbGF5TmV4dCgpO1xuICAgIH1cbiAgfTtcbn1cbiJdfQ==