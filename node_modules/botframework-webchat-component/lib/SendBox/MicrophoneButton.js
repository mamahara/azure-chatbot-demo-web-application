"use strict";

function _typeof(obj) { "@babel/helpers - typeof"; if (typeof Symbol === "function" && typeof Symbol.iterator === "symbol") { _typeof = function _typeof(obj) { return typeof obj; }; } else { _typeof = function _typeof(obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; }; } return _typeof(obj); }

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.useMicrophoneButtonDisabled = useMicrophoneButtonDisabled;
exports.useMicrophoneButtonClick = exports.connectMicrophoneButton = exports.default = void 0;

var _botframeworkWebchatCore = require("botframework-webchat-core");

var _glamor = require("glamor");

var _classnames = _interopRequireDefault(require("classnames"));

var _memoizeOne = _interopRequireDefault(require("memoize-one"));

var _propTypes = _interopRequireDefault(require("prop-types"));

var _react = _interopRequireWildcard(require("react"));

var _connectToWebChat = _interopRequireDefault(require("../connectToWebChat"));

var _IconButton = _interopRequireDefault(require("./IconButton"));

var _MicrophoneIcon = _interopRequireDefault(require("./Assets/MicrophoneIcon"));

var _useDictateAbortable3 = _interopRequireDefault(require("../hooks/useDictateAbortable"));

var _useDictateInterims3 = _interopRequireDefault(require("../hooks/useDictateInterims"));

var _useDictateState7 = _interopRequireDefault(require("../hooks/useDictateState"));

var _useDisabled3 = _interopRequireDefault(require("../hooks/useDisabled"));

var _useLocalizer = _interopRequireDefault(require("../hooks/useLocalizer"));

var _useSendBoxValue3 = _interopRequireDefault(require("../hooks/useSendBoxValue"));

var _useShouldSpeakIncomingActivity = _interopRequireDefault(require("../hooks/useShouldSpeakIncomingActivity"));

var _useStartDictate = _interopRequireDefault(require("../hooks/useStartDictate"));

var _useStopDictate = _interopRequireDefault(require("../hooks/useStopDictate"));

var _useStyleSet3 = _interopRequireDefault(require("../hooks/useStyleSet"));

var _useWebSpeechPonyfill4 = _interopRequireDefault(require("../hooks/useWebSpeechPonyfill"));

function _getRequireWildcardCache() { if (typeof WeakMap !== "function") return null; var cache = new WeakMap(); _getRequireWildcardCache = function _getRequireWildcardCache() { return cache; }; return cache; }

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } if (obj === null || _typeof(obj) !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _slicedToArray(arr, i) { return _arrayWithHoles(arr) || _iterableToArrayLimit(arr, i) || _unsupportedIterableToArray(arr, i) || _nonIterableRest(); }

function _nonIterableRest() { throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method."); }

function _unsupportedIterableToArray(o, minLen) { if (!o) return; if (typeof o === "string") return _arrayLikeToArray(o, minLen); var n = Object.prototype.toString.call(o).slice(8, -1); if (n === "Object" && o.constructor) n = o.constructor.name; if (n === "Map" || n === "Set") return Array.from(o); if (n === "Arguments" || /^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)) return _arrayLikeToArray(o, minLen); }

function _arrayLikeToArray(arr, len) { if (len == null || len > arr.length) len = arr.length; for (var i = 0, arr2 = new Array(len); i < len; i++) { arr2[i] = arr[i]; } return arr2; }

function _iterableToArrayLimit(arr, i) { if (typeof Symbol === "undefined" || !(Symbol.iterator in Object(arr))) return; var _arr = []; var _n = true; var _d = false; var _e = undefined; try { for (var _i = arr[Symbol.iterator](), _s; !(_n = (_s = _i.next()).done); _n = true) { _arr.push(_s.value); if (i && _arr.length === i) break; } } catch (err) { _d = true; _e = err; } finally { try { if (!_n && _i["return"] != null) _i["return"](); } finally { if (_d) throw _e; } } return _arr; }

function _arrayWithHoles(arr) { if (Array.isArray(arr)) return arr; }

var DictateState = _botframeworkWebchatCore.Constants.DictateState;
var ROOT_CSS = (0, _glamor.css)({
  display: 'flex',
  height: '100%',
  // .sr-only - This component is intended to be invisible to the visual Web Chat user, but read by the AT when using a screen reader
  '& > .sr-only': {
    color: 'transparent',
    height: 1,
    left: -10000,
    overflow: 'hidden',
    position: 'absolute',
    top: 0,
    whiteSpace: 'nowrap',
    width: 1
  }
});

var connectMicrophoneButton = function connectMicrophoneButton() {
  var primeSpeechSynthesis = (0, _memoizeOne.default)(function (speechSynthesis, SpeechSynthesisUtterance) {
    if (speechSynthesis && SpeechSynthesisUtterance) {
      var utterance = new SpeechSynthesisUtterance('');

      var _speechSynthesis$getV = speechSynthesis.getVoices();

      var _speechSynthesis$getV2 = _slicedToArray(_speechSynthesis$getV, 1);

      utterance.voice = _speechSynthesis$getV2[0];
      speechSynthesis.speak(utterance);
    }
  });

  for (var _len = arguments.length, selectors = new Array(_len), _key = 0; _key < _len; _key++) {
    selectors[_key] = arguments[_key];
  }

  return _connectToWebChat.default.apply(void 0, [function (_ref) {
    var disabled = _ref.disabled,
        dictateInterims = _ref.dictateInterims,
        dictateState = _ref.dictateState,
        language = _ref.language,
        setSendBox = _ref.setSendBox,
        startDictate = _ref.startDictate,
        stopDictate = _ref.stopDictate,
        stopSpeakingActivity = _ref.stopSpeakingActivity,
        _ref$webSpeechPonyfil = _ref.webSpeechPonyfill;
    _ref$webSpeechPonyfil = _ref$webSpeechPonyfil === void 0 ? {} : _ref$webSpeechPonyfil;
    var speechSynthesis = _ref$webSpeechPonyfil.speechSynthesis,
        SpeechSynthesisUtterance = _ref$webSpeechPonyfil.SpeechSynthesisUtterance;
    return {
      click: function click() {
        if (dictateState === DictateState.WILL_START) {
          stopSpeakingActivity();
        } else if (dictateState === DictateState.DICTATING) {
          stopDictate();
          setSendBox(dictateInterims.join(' '));
        } else {
          stopSpeakingActivity();
          startDictate();
        }

        primeSpeechSynthesis(speechSynthesis, SpeechSynthesisUtterance);
      },
      dictating: dictateState === DictateState.DICTATING,
      disabled: disabled || dictateState === DictateState.STARTING && dictateState === DictateState.STOPPING,
      language: language
    };
  }].concat(selectors));
};

exports.connectMicrophoneButton = connectMicrophoneButton;

var useMicrophoneButtonClick = function useMicrophoneButtonClick() {
  var _useSendBoxValue = (0, _useSendBoxValue3.default)(),
      _useSendBoxValue2 = _slicedToArray(_useSendBoxValue, 2),
      setSendBox = _useSendBoxValue2[1];

  var _useShouldSpeakIncomi = (0, _useShouldSpeakIncomingActivity.default)(),
      _useShouldSpeakIncomi2 = _slicedToArray(_useShouldSpeakIncomi, 2),
      setShouldSpeakIncomingActivity = _useShouldSpeakIncomi2[1];

  var _useWebSpeechPonyfill = (0, _useWebSpeechPonyfill4.default)(),
      _useWebSpeechPonyfill2 = _slicedToArray(_useWebSpeechPonyfill, 1),
      _useWebSpeechPonyfill3 = _useWebSpeechPonyfill2[0];

  _useWebSpeechPonyfill3 = _useWebSpeechPonyfill3 === void 0 ? {} : _useWebSpeechPonyfill3;
  var speechSynthesis = _useWebSpeechPonyfill3.speechSynthesis,
      SpeechSynthesisUtterance = _useWebSpeechPonyfill3.SpeechSynthesisUtterance;

  var _useDictateInterims = (0, _useDictateInterims3.default)(),
      _useDictateInterims2 = _slicedToArray(_useDictateInterims, 1),
      dictateInterims = _useDictateInterims2[0];

  var _useDictateState = (0, _useDictateState7.default)(),
      _useDictateState2 = _slicedToArray(_useDictateState, 1),
      dictateState = _useDictateState2[0];

  var startDictate = (0, _useStartDictate.default)();
  var stopDictate = (0, _useStopDictate.default)();

  var _useState = (0, _react.useState)(function () {
    return (0, _memoizeOne.default)(function (speechSynthesis, SpeechSynthesisUtterance) {
      if (speechSynthesis && SpeechSynthesisUtterance) {
        var utterance = new SpeechSynthesisUtterance('');

        var _speechSynthesis$getV3 = speechSynthesis.getVoices();

        var _speechSynthesis$getV4 = _slicedToArray(_speechSynthesis$getV3, 1);

        utterance.voice = _speechSynthesis$getV4[0];
        speechSynthesis.speak(utterance);
      }
    });
  }),
      _useState2 = _slicedToArray(_useState, 1),
      primeSpeechSynthesis = _useState2[0]; // TODO: [P2] We should revisit this function later
  //       The click() logic seems local to the component, but may not be generalized across all implementations.


  return (0, _react.useCallback)(function () {
    if (dictateState === DictateState.WILL_START) {
      setShouldSpeakIncomingActivity(false);
    } else if (dictateState === DictateState.DICTATING) {
      stopDictate();
      setSendBox(dictateInterims.join(' '));
    } else {
      setShouldSpeakIncomingActivity(false);
      startDictate();
    }

    primeSpeechSynthesis(speechSynthesis, SpeechSynthesisUtterance);
  }, [dictateInterims, dictateState, primeSpeechSynthesis, setSendBox, setShouldSpeakIncomingActivity, speechSynthesis, SpeechSynthesisUtterance, startDictate, stopDictate]);
};

exports.useMicrophoneButtonClick = useMicrophoneButtonClick;

function useMicrophoneButtonDisabled() {
  var _useDictateAbortable = (0, _useDictateAbortable3.default)(),
      _useDictateAbortable2 = _slicedToArray(_useDictateAbortable, 1),
      abortable = _useDictateAbortable2[0];

  var _useDictateState3 = (0, _useDictateState7.default)(),
      _useDictateState4 = _slicedToArray(_useDictateState3, 1),
      dictateState = _useDictateState4[0];

  var _useDisabled = (0, _useDisabled3.default)(),
      _useDisabled2 = _slicedToArray(_useDisabled, 1),
      disabled = _useDisabled2[0];

  return [disabled || dictateState === DictateState.STARTING || dictateState === DictateState.STOPPING || dictateState === DictateState.DICTATING && !abortable];
}

var MicrophoneButton = function MicrophoneButton(_ref2) {
  var className = _ref2.className;

  var _useStyleSet = (0, _useStyleSet3.default)(),
      _useStyleSet2 = _slicedToArray(_useStyleSet, 1),
      microphoneButtonStyleSet = _useStyleSet2[0].microphoneButton;

  var _useDictateState5 = (0, _useDictateState7.default)(),
      _useDictateState6 = _slicedToArray(_useDictateState5, 1),
      dictateState = _useDictateState6[0];

  var _useMicrophoneButtonD = useMicrophoneButtonDisabled(),
      _useMicrophoneButtonD2 = _slicedToArray(_useMicrophoneButtonD, 1),
      disabled = _useMicrophoneButtonD2[0];

  var click = useMicrophoneButtonClick();
  var localize = (0, _useLocalizer.default)();
  var dictating = dictateState === DictateState.DICTATING;
  return /*#__PURE__*/_react.default.createElement("div", {
    "aria-controls": "webchatSendBoxMicrophoneButton",
    className: (0, _classnames.default)(microphoneButtonStyleSet + '', ROOT_CSS + '', className + '', {
      dictating: dictating
    })
  }, /*#__PURE__*/_react.default.createElement(_IconButton.default, {
    alt: localize('TEXT_INPUT_SPEAK_BUTTON_ALT'),
    disabled: disabled,
    onClick: click
  }, /*#__PURE__*/_react.default.createElement(_MicrophoneIcon.default, null)), /*#__PURE__*/_react.default.createElement("div", {
    "aria-live": "polite",
    className: "sr-only",
    id: "webchatSendBoxMicrophoneButton",
    role: "status"
  }, localize(dictating ? 'SPEECH_INPUT_MICROPHONE_BUTTON_OPEN_ALT' : 'SPEECH_INPUT_MICROPHONE_BUTTON_CLOSE_ALT')));
};

MicrophoneButton.defaultProps = {
  className: ''
};
MicrophoneButton.propTypes = {
  className: _propTypes.default.string
};
var _default = MicrophoneButton;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9TZW5kQm94L01pY3JvcGhvbmVCdXR0b24uanMiXSwibmFtZXMiOlsiRGljdGF0ZVN0YXRlIiwiQ29uc3RhbnRzIiwiUk9PVF9DU1MiLCJkaXNwbGF5IiwiaGVpZ2h0IiwiY29sb3IiLCJsZWZ0Iiwib3ZlcmZsb3ciLCJwb3NpdGlvbiIsInRvcCIsIndoaXRlU3BhY2UiLCJ3aWR0aCIsImNvbm5lY3RNaWNyb3Bob25lQnV0dG9uIiwicHJpbWVTcGVlY2hTeW50aGVzaXMiLCJzcGVlY2hTeW50aGVzaXMiLCJTcGVlY2hTeW50aGVzaXNVdHRlcmFuY2UiLCJ1dHRlcmFuY2UiLCJnZXRWb2ljZXMiLCJ2b2ljZSIsInNwZWFrIiwic2VsZWN0b3JzIiwiY29ubmVjdFRvV2ViQ2hhdCIsImRpc2FibGVkIiwiZGljdGF0ZUludGVyaW1zIiwiZGljdGF0ZVN0YXRlIiwibGFuZ3VhZ2UiLCJzZXRTZW5kQm94Iiwic3RhcnREaWN0YXRlIiwic3RvcERpY3RhdGUiLCJzdG9wU3BlYWtpbmdBY3Rpdml0eSIsIndlYlNwZWVjaFBvbnlmaWxsIiwiY2xpY2siLCJXSUxMX1NUQVJUIiwiRElDVEFUSU5HIiwiam9pbiIsImRpY3RhdGluZyIsIlNUQVJUSU5HIiwiU1RPUFBJTkciLCJ1c2VNaWNyb3Bob25lQnV0dG9uQ2xpY2siLCJzZXRTaG91bGRTcGVha0luY29taW5nQWN0aXZpdHkiLCJ1c2VNaWNyb3Bob25lQnV0dG9uRGlzYWJsZWQiLCJhYm9ydGFibGUiLCJNaWNyb3Bob25lQnV0dG9uIiwiY2xhc3NOYW1lIiwibWljcm9waG9uZUJ1dHRvblN0eWxlU2V0IiwibWljcm9waG9uZUJ1dHRvbiIsImxvY2FsaXplIiwiZGVmYXVsdFByb3BzIiwicHJvcFR5cGVzIiwiUHJvcFR5cGVzIiwic3RyaW5nIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7O0FBR0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7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QUdYLFlBQVksS0FBS3hCLFlBQVksQ0FBQ2lDLFNBQWhEO0FBRUEsc0JBQ0U7QUFDRSxxQkFBYyxnQ0FEaEI7QUFFRSxJQUFBLFNBQVMsRUFBRSx5QkFBV1csd0JBQXdCLEdBQUcsRUFBdEMsRUFBMEMxQyxRQUFRLEdBQUcsRUFBckQsRUFBeUR5QyxTQUFTLEdBQUcsRUFBckUsRUFBeUU7QUFBRVIsTUFBQUEsU0FBUyxFQUFUQTtBQUFGLEtBQXpFO0FBRmIsa0JBSUUsNkJBQUMsbUJBQUQ7QUFBWSxJQUFBLEdBQUcsRUFBRVcsUUFBUSxDQUFDLDZCQUFELENBQXpCO0FBQTBELElBQUEsUUFBUSxFQUFFeEIsUUFBcEU7QUFBOEUsSUFBQSxPQUFPLEVBQUVTO0FBQXZGLGtCQUNFLDZCQUFDLHVCQUFELE9BREYsQ0FKRixlQU9FO0FBQUssaUJBQVUsUUFBZjtBQUF3QixJQUFBLFNBQVMsRUFBQyxTQUFsQztBQUE0QyxJQUFBLEVBQUUsRUFBQyxnQ0FBL0M7QUFBZ0YsSUFBQSxJQUFJLEVBQUM7QUFBckYsS0FDR2UsUUFBUSxDQUFDWCxTQUFTLEdBQUcseUNBQUgsR0FBK0MsMENBQXpELENBRFgsQ0FQRixDQURGO0FBYUQsQ0F0QkQ7O0FBd0JBTyxnQkFBZ0IsQ0FBQ0ssWUFBakIsR0FBZ0M7QUFDOUJKLEVBQUFBLFNBQVMsRUFBRTtBQURtQixDQUFoQztBQUlBRCxnQkFBZ0IsQ0FBQ00sU0FBakIsR0FBNkI7QUFDM0JMLEVBQUFBLFNBQVMsRUFBRU0sbUJBQVVDO0FBRE0sQ0FBN0I7ZUFJZVIsZ0IiLCJzb3VyY2VSb290IjoiY29tcG9uZW50Oi8vLyIsInNvdXJjZXNDb250ZW50IjpbIi8vIFRoaXMgaXMgcmVxdWlyZWQgZm9yIGFyaWEtY29udHJvbHMuXG4vKiBlc2xpbnQgcmVhY3QvZm9yYmlkLWRvbS1wcm9wczogXCJvZmZcIiAqL1xuXG5pbXBvcnQgeyBDb25zdGFudHMgfSBmcm9tICdib3RmcmFtZXdvcmstd2ViY2hhdC1jb3JlJztcbmltcG9ydCB7IGNzcyB9IGZyb20gJ2dsYW1vcic7XG5pbXBvcnQgY2xhc3NOYW1lcyBmcm9tICdjbGFzc25hbWVzJztcbmltcG9ydCBtZW1vaXplIGZyb20gJ21lbW9pemUtb25lJztcbmltcG9ydCBQcm9wVHlwZXMgZnJvbSAncHJvcC10eXBlcyc7XG5pbXBvcnQgUmVhY3QsIHsgdXNlQ2FsbGJhY2ssIHVzZVN0YXRlIH0gZnJvbSAncmVhY3QnO1xuXG5pbXBvcnQgY29ubmVjdFRvV2ViQ2hhdCBmcm9tICcuLi9jb25uZWN0VG9XZWJDaGF0JztcbmltcG9ydCBJY29uQnV0dG9uIGZyb20gJy4vSWNvbkJ1dHRvbic7XG5pbXBvcnQgTWljcm9waG9uZUljb24gZnJvbSAnLi9Bc3NldHMvTWljcm9waG9uZUljb24nO1xuaW1wb3J0IHVzZURpY3RhdGVBYm9ydGFibGUgZnJvbSAnLi4vaG9va3MvdXNlRGljdGF0ZUFib3J0YWJsZSc7XG5pbXBvcnQgdXNlRGljdGF0ZUludGVyaW1zIGZyb20gJy4uL2hvb2tzL3VzZURpY3RhdGVJbnRlcmltcyc7XG5pbXBvcnQgdXNlRGljdGF0ZVN0YXRlIGZyb20gJy4uL2hvb2tzL3VzZURpY3RhdGVTdGF0ZSc7XG5pbXBvcnQgdXNlRGlzYWJsZWQgZnJvbSAnLi4vaG9va3MvdXNlRGlzYWJsZWQnO1xuaW1wb3J0IHVzZUxvY2FsaXplciBmcm9tICcuLi9ob29rcy91c2VMb2NhbGl6ZXInO1xuaW1wb3J0IHVzZVNlbmRCb3hWYWx1ZSBmcm9tICcuLi9ob29rcy91c2VTZW5kQm94VmFsdWUnO1xuaW1wb3J0IHVzZVNob3VsZFNwZWFrSW5jb21pbmdBY3Rpdml0eSBmcm9tICcuLi9ob29rcy91c2VTaG91bGRTcGVha0luY29taW5nQWN0aXZpdHknO1xuaW1wb3J0IHVzZVN0YXJ0RGljdGF0ZSBmcm9tICcuLi9ob29rcy91c2VTdGFydERpY3RhdGUnO1xuaW1wb3J0IHVzZVN0b3BEaWN0YXRlIGZyb20gJy4uL2hvb2tzL3VzZVN0b3BEaWN0YXRlJztcbmltcG9ydCB1c2VTdHlsZVNldCBmcm9tICcuLi9ob29rcy91c2VTdHlsZVNldCc7XG5pbXBvcnQgdXNlV2ViU3BlZWNoUG9ueWZpbGwgZnJvbSAnLi4vaG9va3MvdXNlV2ViU3BlZWNoUG9ueWZpbGwnO1xuXG5jb25zdCB7IERpY3RhdGVTdGF0ZSB9ID0gQ29uc3RhbnRzO1xuXG5jb25zdCBST09UX0NTUyA9IGNzcyh7XG4gIGRpc3BsYXk6ICdmbGV4JyxcbiAgaGVpZ2h0OiAnMTAwJScsXG5cbiAgLy8gLnNyLW9ubHkgLSBUaGlzIGNvbXBvbmVudCBpcyBpbnRlbmRlZCB0byBiZSBpbnZpc2libGUgdG8gdGhlIHZpc3VhbCBXZWIgQ2hhdCB1c2VyLCBidXQgcmVhZCBieSB0aGUgQVQgd2hlbiB1c2luZyBhIHNjcmVlbiByZWFkZXJcblxuICAnJiA+IC5zci1vbmx5Jzoge1xuICAgIGNvbG9yOiAndHJhbnNwYXJlbnQnLFxuICAgIGhlaWdodDogMSxcbiAgICBsZWZ0OiAtMTAwMDAsXG4gICAgb3ZlcmZsb3c6ICdoaWRkZW4nLFxuICAgIHBvc2l0aW9uOiAnYWJzb2x1dGUnLFxuICAgIHRvcDogMCxcbiAgICB3aGl0ZVNwYWNlOiAnbm93cmFwJyxcbiAgICB3aWR0aDogMVxuICB9XG59KTtcblxuY29uc3QgY29ubmVjdE1pY3JvcGhvbmVCdXR0b24gPSAoLi4uc2VsZWN0b3JzKSA9PiB7XG4gIGNvbnN0IHByaW1lU3BlZWNoU3ludGhlc2lzID0gbWVtb2l6ZSgoc3BlZWNoU3ludGhlc2lzLCBTcGVlY2hTeW50aGVzaXNVdHRlcmFuY2UpID0+IHtcbiAgICBpZiAoc3BlZWNoU3ludGhlc2lzICYmIFNwZWVjaFN5bnRoZXNpc1V0dGVyYW5jZSkge1xuICAgICAgY29uc3QgdXR0ZXJhbmNlID0gbmV3IFNwZWVjaFN5bnRoZXNpc1V0dGVyYW5jZSgnJyk7XG5cbiAgICAgIFt1dHRlcmFuY2Uudm9pY2VdID0gc3BlZWNoU3ludGhlc2lzLmdldFZvaWNlcygpO1xuICAgICAgc3BlZWNoU3ludGhlc2lzLnNwZWFrKHV0dGVyYW5jZSk7XG4gICAgfVxuICB9KTtcblxuICByZXR1cm4gY29ubmVjdFRvV2ViQ2hhdChcbiAgICAoe1xuICAgICAgZGlzYWJsZWQsXG4gICAgICBkaWN0YXRlSW50ZXJpbXMsXG4gICAgICBkaWN0YXRlU3RhdGUsXG4gICAgICBsYW5ndWFnZSxcbiAgICAgIHNldFNlbmRCb3gsXG4gICAgICBzdGFydERpY3RhdGUsXG4gICAgICBzdG9wRGljdGF0ZSxcbiAgICAgIHN0b3BTcGVha2luZ0FjdGl2aXR5LFxuICAgICAgd2ViU3BlZWNoUG9ueWZpbGw6IHsgc3BlZWNoU3ludGhlc2lzLCBTcGVlY2hTeW50aGVzaXNVdHRlcmFuY2UgfSA9IHt9XG4gICAgfSkgPT4gKHtcbiAgICAgIGNsaWNrOiAoKSA9PiB7XG4gICAgICAgIGlmIChkaWN0YXRlU3RhdGUgPT09IERpY3RhdGVTdGF0ZS5XSUxMX1NUQVJUKSB7XG4gICAgICAgICAgc3RvcFNwZWFraW5nQWN0aXZpdHkoKTtcbiAgICAgICAgfSBlbHNlIGlmIChkaWN0YXRlU3RhdGUgPT09IERpY3RhdGVTdGF0ZS5ESUNUQVRJTkcpIHtcbiAgICAgICAgICBzdG9wRGljdGF0ZSgpO1xuICAgICAgICAgIHNldFNlbmRCb3goZGljdGF0ZUludGVyaW1zLmpvaW4oJyAnKSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgc3RvcFNwZWFraW5nQWN0aXZpdHkoKTtcbiAgICAgICAgICBzdGFydERpY3RhdGUoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHByaW1lU3BlZWNoU3ludGhlc2lzKHNwZWVjaFN5bnRoZXNpcywgU3BlZWNoU3ludGhlc2lzVXR0ZXJhbmNlKTtcbiAgICAgIH0sXG4gICAgICBkaWN0YXRpbmc6IGRpY3RhdGVTdGF0ZSA9PT0gRGljdGF0ZVN0YXRlLkRJQ1RBVElORyxcbiAgICAgIGRpc2FibGVkOiBkaXNhYmxlZCB8fCAoZGljdGF0ZVN0YXRlID09PSBEaWN0YXRlU3RhdGUuU1RBUlRJTkcgJiYgZGljdGF0ZVN0YXRlID09PSBEaWN0YXRlU3RhdGUuU1RPUFBJTkcpLFxuICAgICAgbGFuZ3VhZ2VcbiAgICB9KSxcbiAgICAuLi5zZWxlY3RvcnNcbiAgKTtcbn07XG5cbmNvbnN0IHVzZU1pY3JvcGhvbmVCdXR0b25DbGljayA9ICgpID0+IHtcbiAgY29uc3QgWywgc2V0U2VuZEJveF0gPSB1c2VTZW5kQm94VmFsdWUoKTtcbiAgY29uc3QgWywgc2V0U2hvdWxkU3BlYWtJbmNvbWluZ0FjdGl2aXR5XSA9IHVzZVNob3VsZFNwZWFrSW5jb21pbmdBY3Rpdml0eSgpO1xuICBjb25zdCBbeyBzcGVlY2hTeW50aGVzaXMsIFNwZWVjaFN5bnRoZXNpc1V0dGVyYW5jZSB9ID0ge31dID0gdXNlV2ViU3BlZWNoUG9ueWZpbGwoKTtcbiAgY29uc3QgW2RpY3RhdGVJbnRlcmltc10gPSB1c2VEaWN0YXRlSW50ZXJpbXMoKTtcbiAgY29uc3QgW2RpY3RhdGVTdGF0ZV0gPSB1c2VEaWN0YXRlU3RhdGUoKTtcbiAgY29uc3Qgc3RhcnREaWN0YXRlID0gdXNlU3RhcnREaWN0YXRlKCk7XG4gIGNvbnN0IHN0b3BEaWN0YXRlID0gdXNlU3RvcERpY3RhdGUoKTtcblxuICBjb25zdCBbcHJpbWVTcGVlY2hTeW50aGVzaXNdID0gdXNlU3RhdGUoKCkgPT5cbiAgICBtZW1vaXplKChzcGVlY2hTeW50aGVzaXMsIFNwZWVjaFN5bnRoZXNpc1V0dGVyYW5jZSkgPT4ge1xuICAgICAgaWYgKHNwZWVjaFN5bnRoZXNpcyAmJiBTcGVlY2hTeW50aGVzaXNVdHRlcmFuY2UpIHtcbiAgICAgICAgY29uc3QgdXR0ZXJhbmNlID0gbmV3IFNwZWVjaFN5bnRoZXNpc1V0dGVyYW5jZSgnJyk7XG5cbiAgICAgICAgW3V0dGVyYW5jZS52b2ljZV0gPSBzcGVlY2hTeW50aGVzaXMuZ2V0Vm9pY2VzKCk7XG4gICAgICAgIHNwZWVjaFN5bnRoZXNpcy5zcGVhayh1dHRlcmFuY2UpO1xuICAgICAgfVxuICAgIH0pXG4gICk7XG5cbiAgLy8gVE9ETzogW1AyXSBXZSBzaG91bGQgcmV2aXNpdCB0aGlzIGZ1bmN0aW9uIGxhdGVyXG4gIC8vICAgICAgIFRoZSBjbGljaygpIGxvZ2ljIHNlZW1zIGxvY2FsIHRvIHRoZSBjb21wb25lbnQsIGJ1dCBtYXkgbm90IGJlIGdlbmVyYWxpemVkIGFjcm9zcyBhbGwgaW1wbGVtZW50YXRpb25zLlxuICByZXR1cm4gdXNlQ2FsbGJhY2soKCkgPT4ge1xuICAgIGlmIChkaWN0YXRlU3RhdGUgPT09IERpY3RhdGVTdGF0ZS5XSUxMX1NUQVJUKSB7XG4gICAgICBzZXRTaG91bGRTcGVha0luY29taW5nQWN0aXZpdHkoZmFsc2UpO1xuICAgIH0gZWxzZSBpZiAoZGljdGF0ZVN0YXRlID09PSBEaWN0YXRlU3RhdGUuRElDVEFUSU5HKSB7XG4gICAgICBzdG9wRGljdGF0ZSgpO1xuICAgICAgc2V0U2VuZEJveChkaWN0YXRlSW50ZXJpbXMuam9pbignICcpKTtcbiAgICB9IGVsc2Uge1xuICAgICAgc2V0U2hvdWxkU3BlYWtJbmNvbWluZ0FjdGl2aXR5KGZhbHNlKTtcbiAgICAgIHN0YXJ0RGljdGF0ZSgpO1xuICAgIH1cblxuICAgIHByaW1lU3BlZWNoU3ludGhlc2lzKHNwZWVjaFN5bnRoZXNpcywgU3BlZWNoU3ludGhlc2lzVXR0ZXJhbmNlKTtcbiAgfSwgW1xuICAgIGRpY3RhdGVJbnRlcmltcyxcbiAgICBkaWN0YXRlU3RhdGUsXG4gICAgcHJpbWVTcGVlY2hTeW50aGVzaXMsXG4gICAgc2V0U2VuZEJveCxcbiAgICBzZXRTaG91bGRTcGVha0luY29taW5nQWN0aXZpdHksXG4gICAgc3BlZWNoU3ludGhlc2lzLFxuICAgIFNwZWVjaFN5bnRoZXNpc1V0dGVyYW5jZSxcbiAgICBzdGFydERpY3RhdGUsXG4gICAgc3RvcERpY3RhdGVcbiAgXSk7XG59O1xuXG5mdW5jdGlvbiB1c2VNaWNyb3Bob25lQnV0dG9uRGlzYWJsZWQoKSB7XG4gIGNvbnN0IFthYm9ydGFibGVdID0gdXNlRGljdGF0ZUFib3J0YWJsZSgpO1xuICBjb25zdCBbZGljdGF0ZVN0YXRlXSA9IHVzZURpY3RhdGVTdGF0ZSgpO1xuICBjb25zdCBbZGlzYWJsZWRdID0gdXNlRGlzYWJsZWQoKTtcblxuICByZXR1cm4gW1xuICAgIGRpc2FibGVkIHx8XG4gICAgICBkaWN0YXRlU3RhdGUgPT09IERpY3RhdGVTdGF0ZS5TVEFSVElORyB8fFxuICAgICAgZGljdGF0ZVN0YXRlID09PSBEaWN0YXRlU3RhdGUuU1RPUFBJTkcgfHxcbiAgICAgIChkaWN0YXRlU3RhdGUgPT09IERpY3RhdGVTdGF0ZS5ESUNUQVRJTkcgJiYgIWFib3J0YWJsZSlcbiAgXTtcbn1cblxuY29uc3QgTWljcm9waG9uZUJ1dHRvbiA9ICh7IGNsYXNzTmFtZSB9KSA9PiB7XG4gIGNvbnN0IFt7IG1pY3JvcGhvbmVCdXR0b246IG1pY3JvcGhvbmVCdXR0b25TdHlsZVNldCB9XSA9IHVzZVN0eWxlU2V0KCk7XG4gIGNvbnN0IFtkaWN0YXRlU3RhdGVdID0gdXNlRGljdGF0ZVN0YXRlKCk7XG4gIGNvbnN0IFtkaXNhYmxlZF0gPSB1c2VNaWNyb3Bob25lQnV0dG9uRGlzYWJsZWQoKTtcbiAgY29uc3QgY2xpY2sgPSB1c2VNaWNyb3Bob25lQnV0dG9uQ2xpY2soKTtcbiAgY29uc3QgbG9jYWxpemUgPSB1c2VMb2NhbGl6ZXIoKTtcblxuICBjb25zdCBkaWN0YXRpbmcgPSBkaWN0YXRlU3RhdGUgPT09IERpY3RhdGVTdGF0ZS5ESUNUQVRJTkc7XG5cbiAgcmV0dXJuIChcbiAgICA8ZGl2XG4gICAgICBhcmlhLWNvbnRyb2xzPVwid2ViY2hhdFNlbmRCb3hNaWNyb3Bob25lQnV0dG9uXCJcbiAgICAgIGNsYXNzTmFtZT17Y2xhc3NOYW1lcyhtaWNyb3Bob25lQnV0dG9uU3R5bGVTZXQgKyAnJywgUk9PVF9DU1MgKyAnJywgY2xhc3NOYW1lICsgJycsIHsgZGljdGF0aW5nIH0pfVxuICAgID5cbiAgICAgIDxJY29uQnV0dG9uIGFsdD17bG9jYWxpemUoJ1RFWFRfSU5QVVRfU1BFQUtfQlVUVE9OX0FMVCcpfSBkaXNhYmxlZD17ZGlzYWJsZWR9IG9uQ2xpY2s9e2NsaWNrfT5cbiAgICAgICAgPE1pY3JvcGhvbmVJY29uIC8+XG4gICAgICA8L0ljb25CdXR0b24+XG4gICAgICA8ZGl2IGFyaWEtbGl2ZT1cInBvbGl0ZVwiIGNsYXNzTmFtZT1cInNyLW9ubHlcIiBpZD1cIndlYmNoYXRTZW5kQm94TWljcm9waG9uZUJ1dHRvblwiIHJvbGU9XCJzdGF0dXNcIj5cbiAgICAgICAge2xvY2FsaXplKGRpY3RhdGluZyA/ICdTUEVFQ0hfSU5QVVRfTUlDUk9QSE9ORV9CVVRUT05fT1BFTl9BTFQnIDogJ1NQRUVDSF9JTlBVVF9NSUNST1BIT05FX0JVVFRPTl9DTE9TRV9BTFQnKX1cbiAgICAgIDwvZGl2PlxuICAgIDwvZGl2PlxuICApO1xufTtcblxuTWljcm9waG9uZUJ1dHRvbi5kZWZhdWx0UHJvcHMgPSB7XG4gIGNsYXNzTmFtZTogJydcbn07XG5cbk1pY3JvcGhvbmVCdXR0b24ucHJvcFR5cGVzID0ge1xuICBjbGFzc05hbWU6IFByb3BUeXBlcy5zdHJpbmdcbn07XG5cbmV4cG9ydCBkZWZhdWx0IE1pY3JvcGhvbmVCdXR0b247XG5cbmV4cG9ydCB7IGNvbm5lY3RNaWNyb3Bob25lQnV0dG9uLCB1c2VNaWNyb3Bob25lQnV0dG9uQ2xpY2ssIHVzZU1pY3JvcGhvbmVCdXR0b25EaXNhYmxlZCB9O1xuIl19