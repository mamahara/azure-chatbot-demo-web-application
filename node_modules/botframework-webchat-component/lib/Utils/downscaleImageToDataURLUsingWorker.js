"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = downscaleImageToDataURLUsingWorker;
exports.checkSupport = void 0;

var _blobToArrayBuffer = _interopRequireDefault(require("./blobToArrayBuffer"));

var _memoizeOne = _interopRequireDefault(require("memoize-one"));

var _downscaleImageToDataURLUsingWorker = _interopRequireDefault(require("./downscaleImageToDataURLUsingWorker.worker"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _slicedToArray(arr, i) { return _arrayWithHoles(arr) || _iterableToArrayLimit(arr, i) || _unsupportedIterableToArray(arr, i) || _nonIterableRest(); }

function _nonIterableRest() { throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method."); }

function _unsupportedIterableToArray(o, minLen) { if (!o) return; if (typeof o === "string") return _arrayLikeToArray(o, minLen); var n = Object.prototype.toString.call(o).slice(8, -1); if (n === "Object" && o.constructor) n = o.constructor.name; if (n === "Map" || n === "Set") return Array.from(o); if (n === "Arguments" || /^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)) return _arrayLikeToArray(o, minLen); }

function _arrayLikeToArray(arr, len) { if (len == null || len > arr.length) len = arr.length; for (var i = 0, arr2 = new Array(len); i < len; i++) { arr2[i] = arr[i]; } return arr2; }

function _iterableToArrayLimit(arr, i) { if (typeof Symbol === "undefined" || !(Symbol.iterator in Object(arr))) return; var _arr = []; var _n = true; var _d = false; var _e = undefined; try { for (var _i = arr[Symbol.iterator](), _s; !(_n = (_s = _i.next()).done); _n = true) { _arr.push(_s.value); if (i && _arr.length === i) break; } } catch (err) { _d = true; _e = err; } finally { try { if (!_n && _i["return"] != null) _i["return"](); } finally { if (_d) throw _e; } } return _arr; }

function _arrayWithHoles(arr) { if (Array.isArray(arr)) return arr; }

function asyncGeneratorStep(gen, resolve, reject, _next, _throw, key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { Promise.resolve(value).then(_next, _throw); } }

function _asyncToGenerator(fn) { return function () { var self = this, args = arguments; return new Promise(function (resolve, reject) { var gen = fn.apply(self, args); function _next(value) { asyncGeneratorStep(gen, resolve, reject, _next, _throw, "next", value); } function _throw(err) { asyncGeneratorStep(gen, resolve, reject, _next, _throw, "throw", err); } _next(undefined); }); }; }

function createWorker() {
  var blob = new Blob(["(".concat(_downscaleImageToDataURLUsingWorker.default, ")()")], {
    type: 'text/javascript'
  });
  var url = window.URL.createObjectURL(blob);
  return new Promise(function (resolve, reject) {
    var worker = new Worker(url);

    worker.onerror = function (_ref) {
      var error = _ref.error,
          message = _ref.message;
      return reject(error || new Error(message));
    };

    worker.onmessage = function (_ref2) {
      var data = _ref2.data;
      return data === 'ready' && resolve(worker);
    };
  }).finally(function () {
    window.URL.revokeObjectURL(url);
  });
}

var workerPromise;

function getWorker() {
  return _getWorker.apply(this, arguments);
} // We are using a lazy-check because:
// 1. OffscreenCanvas.getContext has a toll
// 2. Developers could bring polyfills


function _getWorker() {
  _getWorker = _asyncToGenerator( /*#__PURE__*/regeneratorRuntime.mark(function _callee() {
    var worker;
    return regeneratorRuntime.wrap(function _callee$(_context) {
      while (1) {
        switch (_context.prev = _context.next) {
          case 0:
            if (!workerPromise) {
              _context.next = 6;
              break;
            }

            _context.next = 3;
            return workerPromise;

          case 3:
            worker = _context.sent;
            _context.next = 11;
            break;

          case 6:
            workerPromise = createWorker();
            _context.next = 9;
            return workerPromise;

          case 9:
            worker = _context.sent;
            worker.addEventListener('error', function () {
              // Current worker errored out, will create a new worker next time.
              workerPromise = null;
              worker.terminate();
            });

          case 11:
            return _context.abrupt("return", worker);

          case 12:
          case "end":
            return _context.stop();
        }
      }
    }, _callee);
  }));
  return _getWorker.apply(this, arguments);
}

var checkSupport = (0, _memoizeOne.default)(function () {
  var hasOffscreenCanvas = typeof window.OffscreenCanvas !== 'undefined' && (typeof window.OffscreenCanvas.prototype.convertToBlob !== 'undefined' || typeof window.OffscreenCanvas.prototype.toBlob !== 'undefined');
  var isOffscreenCanvasSupportGetContext2D;

  if (hasOffscreenCanvas) {
    try {
      new OffscreenCanvas(1, 1).getContext('2d');
      isOffscreenCanvasSupportGetContext2D = true;
    } catch (err) {
      isOffscreenCanvasSupportGetContext2D = false;
    }
  }

  return typeof window.createImageBitmap !== 'undefined' && typeof window.MessageChannel !== 'undefined' && hasOffscreenCanvas && isOffscreenCanvasSupportGetContext2D && typeof window.Worker !== 'undefined';
});
exports.checkSupport = checkSupport;

function downscaleImageToDataURLUsingWorker(blob, maxWidth, maxHeight, type, quality) {
  return new Promise(function (resolve, reject) {
    var _MessageChannel = new MessageChannel(),
        port1 = _MessageChannel.port1,
        port2 = _MessageChannel.port2;

    port1.onmessage = function (_ref3) {
      var _ref3$data = _ref3.data,
          error = _ref3$data.error,
          result = _ref3$data.result;

      if (error) {
        var err = new Error(error.message);
        err.stack = error.stack;
        reject(err);
      } else {
        resolve(result);
      }

      port1.close();
      port2.close();
    };

    Promise.all([(0, _blobToArrayBuffer.default)(blob), getWorker()]).then(function (_ref4) {
      var _ref5 = _slicedToArray(_ref4, 2),
          arrayBuffer = _ref5[0],
          worker = _ref5[1];

      return worker.postMessage({
        arrayBuffer: arrayBuffer,
        maxHeight: maxHeight,
        maxWidth: maxWidth,
        quality: quality,
        type: type
      }, [arrayBuffer, port2]);
    });
  });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9VdGlscy9kb3duc2NhbGVJbWFnZVRvRGF0YVVSTFVzaW5nV29ya2VyLmpzIl0sIm5hbWVzIjpbImNyZWF0ZVdvcmtlciIsImJsb2IiLCJCbG9iIiwid29ya2VyIiwidHlwZSIsInVybCIsIndpbmRvdyIsIlVSTCIsImNyZWF0ZU9iamVjdFVSTCIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0IiwiV29ya2VyIiwib25lcnJvciIsImVycm9yIiwibWVzc2FnZSIsIkVycm9yIiwib25tZXNzYWdlIiwiZGF0YSIsImZpbmFsbHkiLCJyZXZva2VPYmplY3RVUkwiLCJ3b3JrZXJQcm9taXNlIiwiZ2V0V29ya2VyIiwiYWRkRXZlbnRMaXN0ZW5lciIsInRlcm1pbmF0ZSIsImNoZWNrU3VwcG9ydCIsImhhc09mZnNjcmVlbkNhbnZhcyIsIk9mZnNjcmVlbkNhbnZhcyIsInByb3RvdHlwZSIsImNvbnZlcnRUb0Jsb2IiLCJ0b0Jsb2IiLCJpc09mZnNjcmVlbkNhbnZhc1N1cHBvcnRHZXRDb250ZXh0MkQiLCJnZXRDb250ZXh0IiwiZXJyIiwiY3JlYXRlSW1hZ2VCaXRtYXAiLCJNZXNzYWdlQ2hhbm5lbCIsImRvd25zY2FsZUltYWdlVG9EYXRhVVJMVXNpbmdXb3JrZXIiLCJtYXhXaWR0aCIsIm1heEhlaWdodCIsInF1YWxpdHkiLCJwb3J0MSIsInBvcnQyIiwicmVzdWx0Iiwic3RhY2siLCJjbG9zZSIsImFsbCIsInRoZW4iLCJhcnJheUJ1ZmZlciIsInBvc3RNZXNzYWdlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7OztBQUFBOztBQUNBOztBQUNBOzs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUVBLFNBQVNBLFlBQVQsR0FBd0I7QUFDdEIsTUFBTUMsSUFBSSxHQUFHLElBQUlDLElBQUosQ0FBUyxZQUFLQywyQ0FBTCxTQUFULEVBQTRCO0FBQUVDLElBQUFBLElBQUksRUFBRTtBQUFSLEdBQTVCLENBQWI7QUFDQSxNQUFNQyxHQUFHLEdBQUdDLE1BQU0sQ0FB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Y29tcG9uZW50Oi8vLyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBibG9iVG9BcnJheUJ1ZmZlciBmcm9tICcuL2Jsb2JUb0FycmF5QnVmZmVyJztcbmltcG9ydCBtZW1vaXplT25lIGZyb20gJ21lbW9pemUtb25lJztcbmltcG9ydCB3b3JrZXIgZnJvbSAnLi9kb3duc2NhbGVJbWFnZVRvRGF0YVVSTFVzaW5nV29ya2VyLndvcmtlcic7XG5cbmZ1bmN0aW9uIGNyZWF0ZVdvcmtlcigpIHtcbiAgY29uc3QgYmxvYiA9IG5ldyBCbG9iKFtgKCR7d29ya2VyfSkoKWBdLCB7IHR5cGU6ICd0ZXh0L2phdmFzY3JpcHQnIH0pO1xuICBjb25zdCB1cmwgPSB3aW5kb3cuVVJMLmNyZWF0ZU9iamVjdFVSTChibG9iKTtcblxuICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgIGNvbnN0IHdvcmtlciA9IG5ldyBXb3JrZXIodXJsKTtcblxuICAgIHdvcmtlci5vbmVycm9yID0gKHsgZXJyb3IsIG1lc3NhZ2UgfSkgPT4gcmVqZWN0KGVycm9yIHx8IG5ldyBFcnJvcihtZXNzYWdlKSk7XG4gICAgd29ya2VyLm9ubWVzc2FnZSA9ICh7IGRhdGEgfSkgPT4gZGF0YSA9PT0gJ3JlYWR5JyAmJiByZXNvbHZlKHdvcmtlcik7XG4gIH0pLmZpbmFsbHkoKCkgPT4ge1xuICAgIHdpbmRvdy5VUkwucmV2b2tlT2JqZWN0VVJMKHVybCk7XG4gIH0pO1xufVxuXG5sZXQgd29ya2VyUHJvbWlzZTtcblxuYXN5bmMgZnVuY3Rpb24gZ2V0V29ya2VyKCkge1xuICBsZXQgd29ya2VyO1xuXG4gIGlmICh3b3JrZXJQcm9taXNlKSB7XG4gICAgd29ya2VyID0gYXdhaXQgd29ya2VyUHJvbWlzZTtcbiAgfSBlbHNlIHtcbiAgICB3b3JrZXJQcm9taXNlID0gY3JlYXRlV29ya2VyKCk7XG5cbiAgICB3b3JrZXIgPSBhd2FpdCB3b3JrZXJQcm9taXNlO1xuICAgIHdvcmtlci5hZGRFdmVudExpc3RlbmVyKCdlcnJvcicsICgpID0+IHtcbiAgICAgIC8vIEN1cnJlbnQgd29ya2VyIGVycm9yZWQgb3V0LCB3aWxsIGNyZWF0ZSBhIG5ldyB3b3JrZXIgbmV4dCB0aW1lLlxuICAgICAgd29ya2VyUHJvbWlzZSA9IG51bGw7XG4gICAgICB3b3JrZXIudGVybWluYXRlKCk7XG4gICAgfSk7XG4gIH1cblxuICByZXR1cm4gd29ya2VyO1xufVxuXG4vLyBXZSBhcmUgdXNpbmcgYSBsYXp5LWNoZWNrIGJlY2F1c2U6XG4vLyAxLiBPZmZzY3JlZW5DYW52YXMuZ2V0Q29udGV4dCBoYXMgYSB0b2xsXG4vLyAyLiBEZXZlbG9wZXJzIGNvdWxkIGJyaW5nIHBvbHlmaWxsc1xuXG5jb25zdCBjaGVja1N1cHBvcnQgPSBtZW1vaXplT25lKCgpID0+IHtcbiAgY29uc3QgaGFzT2Zmc2NyZWVuQ2FudmFzID1cbiAgICB0eXBlb2Ygd2luZG93Lk9mZnNjcmVlbkNhbnZhcyAhPT0gJ3VuZGVmaW5lZCcgJiZcbiAgICAodHlwZW9mIHdpbmRvdy5PZmZzY3JlZW5DYW52YXMucHJvdG90eXBlLmNvbnZlcnRUb0Jsb2IgIT09ICd1bmRlZmluZWQnIHx8XG4gICAgICB0eXBlb2Ygd2luZG93Lk9mZnNjcmVlbkNhbnZhcy5wcm90b3R5cGUudG9CbG9iICE9PSAndW5kZWZpbmVkJyk7XG4gIGxldCBpc09mZnNjcmVlbkNhbnZhc1N1cHBvcnRHZXRDb250ZXh0MkQ7XG5cbiAgaWYgKGhhc09mZnNjcmVlbkNhbnZhcykge1xuICAgIHRyeSB7XG4gICAgICBuZXcgT2Zmc2NyZWVuQ2FudmFzKDEsIDEpLmdldENvbnRleHQoJzJkJyk7XG4gICAgICBpc09mZnNjcmVlbkNhbnZhc1N1cHBvcnRHZXRDb250ZXh0MkQgPSB0cnVlO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgaXNPZmZzY3JlZW5DYW52YXNTdXBwb3J0R2V0Q29udGV4dDJEID0gZmFsc2U7XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIChcbiAgICB0eXBlb2Ygd2luZG93LmNyZWF0ZUltYWdlQml0bWFwICE9PSAndW5kZWZpbmVkJyAmJlxuICAgIHR5cGVvZiB3aW5kb3cuTWVzc2FnZUNoYW5uZWwgIT09ICd1bmRlZmluZWQnICYmXG4gICAgaGFzT2Zmc2NyZWVuQ2FudmFzICYmXG4gICAgaXNPZmZzY3JlZW5DYW52YXNTdXBwb3J0R2V0Q29udGV4dDJEICYmXG4gICAgdHlwZW9mIHdpbmRvdy5Xb3JrZXIgIT09ICd1bmRlZmluZWQnXG4gICk7XG59KTtcblxuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gZG93bnNjYWxlSW1hZ2VUb0RhdGFVUkxVc2luZ1dvcmtlcihibG9iLCBtYXhXaWR0aCwgbWF4SGVpZ2h0LCB0eXBlLCBxdWFsaXR5KSB7XG4gIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgY29uc3QgeyBwb3J0MSwgcG9ydDIgfSA9IG5ldyBNZXNzYWdlQ2hhbm5lbCgpO1xuXG4gICAgcG9ydDEub25tZXNzYWdlID0gKHsgZGF0YTogeyBlcnJvciwgcmVzdWx0IH0gfSkgPT4ge1xuICAgICAgaWYgKGVycm9yKSB7XG4gICAgICAgIGNvbnN0IGVyciA9IG5ldyBFcnJvcihlcnJvci5tZXNzYWdlKTtcblxuICAgICAgICBlcnIuc3RhY2sgPSBlcnJvci5zdGFjaztcblxuICAgICAgICByZWplY3QoZXJyKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJlc29sdmUocmVzdWx0KTtcbiAgICAgIH1cblxuICAgICAgcG9ydDEuY2xvc2UoKTtcbiAgICAgIHBvcnQyLmNsb3NlKCk7XG4gICAgfTtcblxuICAgIFByb21pc2UuYWxsKFtibG9iVG9BcnJheUJ1ZmZlcihibG9iKSwgZ2V0V29ya2VyKCldKS50aGVuKChbYXJyYXlCdWZmZXIsIHdvcmtlcl0pID0+XG4gICAgICB3b3JrZXIucG9zdE1lc3NhZ2UoeyBhcnJheUJ1ZmZlciwgbWF4SGVpZ2h0LCBtYXhXaWR0aCwgcXVhbGl0eSwgdHlwZSB9LCBbYXJyYXlCdWZmZXIsIHBvcnQyXSlcbiAgICApO1xuICB9KTtcbn1cblxuZXhwb3J0IHsgY2hlY2tTdXBwb3J0IH07XG4iXX0=