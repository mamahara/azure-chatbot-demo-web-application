"use strict";

function _typeof(obj) { "@babel/helpers - typeof"; if (typeof Symbol === "function" && typeof Symbol.iterator === "symbol") { _typeof = function _typeof(obj) { return typeof obj; }; } else { _typeof = function _typeof(obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; }; } return _typeof(obj); }

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _reactDictateButton = require("react-dictate-button");

var _botframeworkWebchatCore = require("botframework-webchat-core");

var _propTypes = _interopRequireDefault(require("prop-types"));

var _react = _interopRequireWildcard(require("react"));

var _useActivities3 = _interopRequireDefault(require("./hooks/useActivities"));

var _useDictateInterims3 = _interopRequireDefault(require("./hooks/useDictateInterims"));

var _useDictateState3 = _interopRequireDefault(require("./hooks/useDictateState"));

var _useDisabled3 = _interopRequireDefault(require("./hooks/useDisabled"));

var _useEmitTypingIndicator = _interopRequireDefault(require("./hooks/useEmitTypingIndicator"));

var _useLanguage3 = _interopRequireDefault(require("./hooks/useLanguage"));

var _useSendBoxValue3 = _interopRequireDefault(require("./hooks/useSendBoxValue"));

var _useSendTypingIndicator = _interopRequireDefault(require("./hooks/useSendTypingIndicator"));

var _useSetDictateState = _interopRequireDefault(require("./hooks/internal/useSetDictateState"));

var _useSettableDictateAbortable = _interopRequireDefault(require("./hooks/internal/useSettableDictateAbortable"));

var _useShouldSpeakIncomingActivity = _interopRequireDefault(require("./hooks/useShouldSpeakIncomingActivity"));

var _useStopDictate = _interopRequireDefault(require("./hooks/useStopDictate"));

var _useSubmitSendBox = _interopRequireDefault(require("./hooks/useSubmitSendBox"));

var _useWebSpeechPonyfill4 = _interopRequireDefault(require("./hooks/useWebSpeechPonyfill"));

function _getRequireWildcardCache() { if (typeof WeakMap !== "function") return null; var cache = new WeakMap(); _getRequireWildcardCache = function _getRequireWildcardCache() { return cache; }; return cache; }

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } if (obj === null || _typeof(obj) !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _slicedToArray(arr, i) { return _arrayWithHoles(arr) || _iterableToArrayLimit(arr, i) || _unsupportedIterableToArray(arr, i) || _nonIterableRest(); }

function _nonIterableRest() { throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method."); }

function _unsupportedIterableToArray(o, minLen) { if (!o) return; if (typeof o === "string") return _arrayLikeToArray(o, minLen); var n = Object.prototype.toString.call(o).slice(8, -1); if (n === "Object" && o.constructor) n = o.constructor.name; if (n === "Map" || n === "Set") return Array.from(o); if (n === "Arguments" || /^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)) return _arrayLikeToArray(o, minLen); }

function _arrayLikeToArray(arr, len) { if (len == null || len > arr.length) len = arr.length; for (var i = 0, arr2 = new Array(len); i < len; i++) { arr2[i] = arr[i]; } return arr2; }

function _iterableToArrayLimit(arr, i) { if (typeof Symbol === "undefined" || !(Symbol.iterator in Object(arr))) return; var _arr = []; var _n = true; var _d = false; var _e = undefined; try { for (var _i = arr[Symbol.iterator](), _s; !(_n = (_s = _i.next()).done); _n = true) { _arr.push(_s.value); if (i && _arr.length === i) break; } } catch (err) { _d = true; _e = err; } finally { try { if (!_n && _i["return"] != null) _i["return"](); } finally { if (_d) throw _e; } } return _arr; }

function _arrayWithHoles(arr) { if (Array.isArray(arr)) return arr; }

var _Constants$DictateSta = _botframeworkWebchatCore.Constants.DictateState,
    DICTATING = _Constants$DictateSta.DICTATING,
    IDLE = _Constants$DictateSta.IDLE,
    STARTING = _Constants$DictateSta.STARTING;

var Dictation = function Dictation(_ref) {
  var onError = _ref.onError;

  var _useSettableDictateAb = (0, _useSettableDictateAbortable.default)(),
      _useSettableDictateAb2 = _slicedToArray(_useSettableDictateAb, 2),
      setDictateAbortable = _useSettableDictateAb2[1];

  var _useDictateInterims = (0, _useDictateInterims3.default)(),
      _useDictateInterims2 = _slicedToArray(_useDictateInterims, 2),
      setDictateInterims = _useDictateInterims2[1];

  var _useSendBoxValue = (0, _useSendBoxValue3.default)(),
      _useSendBoxValue2 = _slicedToArray(_useSendBoxValue, 2),
      setSendBox = _useSendBoxValue2[1];

  var _useShouldSpeakIncomi = (0, _useShouldSpeakIncomingActivity.default)(),
      _useShouldSpeakIncomi2 = _slicedToArray(_useShouldSpeakIncomi, 2),
      setShouldSpeakIncomingActivity = _useShouldSpeakIncomi2[1];

  var _useWebSpeechPonyfill = (0, _useWebSpeechPonyfill4.default)(),
      _useWebSpeechPonyfill2 = _slicedToArray(_useWebSpeechPonyfill, 1),
      _useWebSpeechPonyfill3 = _useWebSpeechPonyfill2[0];

  _useWebSpeechPonyfill3 = _useWebSpeechPonyfill3 === void 0 ? {} : _useWebSpeechPonyfill3;
  var SpeechGrammarList = _useWebSpeechPonyfill3.SpeechGrammarList,
      SpeechRecognition = _useWebSpeechPonyfill3.SpeechRecognition;

  var _useActivities = (0, _useActivities3.default)(),
      _useActivities2 = _slicedToArray(_useActivities, 1),
      activities = _useActivities2[0];

  var _useDictateState = (0, _useDictateState3.default)(),
      _useDictateState2 = _slicedToArray(_useDictateState, 1),
      dictateState = _useDictateState2[0];

  var _useDisabled = (0, _useDisabled3.default)(),
      _useDisabled2 = _slicedToArray(_useDisabled, 1),
      disabled = _useDisabled2[0];

  var _useSendTypingIndicat = (0, _useSendTypingIndicator.default)(),
      _useSendTypingIndicat2 = _slicedToArray(_useSendTypingIndicat, 1),
      sendTypingIndicator = _useSendTypingIndicat2[0];

  var _useLanguage = (0, _useLanguage3.default)('speech'),
      _useLanguage2 = _slicedToArray(_useLanguage, 1),
      speechLanguage = _useLanguage2[0];

  var emitTypingIndicator = (0, _useEmitTypingIndicator.default)();
  var setDictateState = (0, _useSetDictateState.default)();
  var stopDictate = (0, _useStopDictate.default)();
  var submitSendBox = (0, _useSubmitSendBox.default)();
  var numSpeakingActivities = (0, _react.useMemo)(function () {
    return activities.filter(function (_ref2) {
      var _ref2$channelData = _ref2.channelData;
      _ref2$channelData = _ref2$channelData === void 0 ? {} : _ref2$channelData;
      var speak = _ref2$channelData.speak;
      return speak;
    }).length;
  }, [activities]);
  var handleDictate = (0, _react.useCallback)(function (_ref3) {
    var _ref3$result = _ref3.result;
    _ref3$result = _ref3$result === void 0 ? {} : _ref3$result;
    var confidence = _ref3$result.confidence,
        transcript = _ref3$result.transcript;

    if (dictateState === DICTATING || dictateState === STARTING) {
      setDictateInterims([]);
      setDictateState(IDLE);
      stopDictate();

      if (transcript) {
        setSendBox(transcript);
        submitSendBox('speech', {
          channelData: {
            speech: {
              alternatives: [{
                confidence: confidence,
                transcript: transcript
              }]
            }
          }
        });
        setShouldSpeakIncomingActivity(true);
      }
    }
  }, [dictateState, setDictateInterims, setDictateState, stopDictate, setSendBox, submitSendBox, setShouldSpeakIncomingActivity]);
  var handleDictating = (0, _react.useCallback)(function (_ref4) {
    var abortable = _ref4.abortable,
        _ref4$results = _ref4.results,
        results = _ref4$results === void 0 ? [] : _ref4$results;

    if (dictateState === DICTATING || dictateState === STARTING) {
      var interims = results.map(function (_ref5) {
        var transcript = _ref5.transcript;
        return transcript;
      });
      setDictateAbortable(abortable);
      setDictateInterims(interims);
      setDictateState(DICTATING);
      sendTypingIndicator && emitTypingIndicator();
    }
  }, [dictateState, emitTypingIndicator, sendTypingIndicator, setDictateAbortable, setDictateInterims, setDictateState]);
  var handleError = (0, _react.useCallback)(function (event) {
    dictateState !== IDLE && setDictateState(IDLE);
    (dictateState === DICTATING || dictateState === STARTING) && stopDictate();
    onError && onError(event);
  }, [dictateState, onError, setDictateState, stopDictate]);
  return /*#__PURE__*/_react.default.createElement(_reactDictateButton.Composer, {
    lang: speechLanguage,
    onDictate: handleDictate,
    onError: handleError,
    onProgress: handleDictating,
    speechGrammarList: SpeechGrammarList,
    speechRecognition: SpeechRecognition,
    started: !disabled && (dictateState === STARTING || dictateState === DICTATING) && !numSpeakingActivities
  });
};

Dictation.defaultProps = {
  onError: undefined
};
Dictation.propTypes = {
  onError: _propTypes.default.func
};
var _default = Dictation;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9EaWN0YXRpb24uanMiXSwibmFtZXMiOlsiQ29uc3RhbnRzIiwiRGljdGF0ZVN0YXRlIiwiRElDVEFUSU5HIiwiSURMRSIsIlNUQVJUSU5HIiwiRGljdGF0aW9uIiwib25FcnJvciIsInNldERpY3RhdGVBYm9ydGFibGUiLCJzZXREaWN0YXRlSW50ZXJpbXMiLCJzZXRTZW5kQm94Iiwic2V0U2hvdWxkU3BlYWtJbmNvbWluZ0FjdGl2aXR5IiwiU3BlZWNoR3JhbW1hckxpc3QiLCJTcGVlY2hSZWNvZ25pdGlvbiIsImFjdGl2aXRpZXMiLCJkaWN0YXRlU3RhdGUiLCJkaXNhYmxlZCIsInNlbmRUeXBpbmdJbmRpY2F0b3IiLCJzcGVlY2hMYW5ndWFnZSIsImVtaXRUeXBpbmdJbmRpY2F0b3IiLCJzZXREaWN0YXRlU3RhdGUiLCJzdG9wRGljdGF0ZSIsInN1Ym1pdFNlbmRCb3giLCJudW1TcGVha2luZ0FjdGl2aXRpZXMiLCJmaWx0ZXIiLCJjaGFubmVsRGF0YSIsInNwZWFrIiwibGVuZ3RoIiwiaGFuZGxlRGljdGF0ZSIsInJlc3VsdCIsImNvbmZpZGVuY2UiLCJ0cmFuc2NyaXB0Iiwic3BlZWNoIiwiYWx0ZXJuYXRpdmVzIiwiaGFuZGxlRGljdGF0aW5nIiwiYWJvcnRhYmxlIiwicmVzdWx0cyIsImludGVyaW1zIiwibWFwIiwiaGFuZGxlRXJyb3IiLCJldmVudCIsImRlZmF1bHRQcm9wcyIsInVuZGVmaW5lZCIsInByb3BUeXBlcyIsIlByb3BUeXBlcyIsImZ1bmMiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUVBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs0QkFJSUEsa0MsQ0FERkMsWTtJQUFnQkMsUyx5QkFBQUEsUztJQUFXQyxJLHlCQUFBQSxJO0lBQU1DLFEseUJBQUFBLFE7O0FBR25DLElBQU1DLFNBQVMsR0FBRyxTQUFaQSxTQUFZLE9BQWlCO0FBQUEsTUFBZEMsT0FBYyxRQUFkQSxPQUFjOztBQUFBLDhCQUNELDJDQURDO0FBQUE7QUFBQSxNQUN4QkMsbUJBRHdCOztBQUFBLDRCQUVGLG1DQUZFO0FBQUE7QUFBQSxNQUV4QkMsa0JBRndCOztBQUFBLHlCQUdWLGdDQUhVO0FBQUE7QUFBQSxNQUd4QkMsVUFId0I7O0FBQUEsOEJBSVUsOENBSlY7QUFBQTtBQUFBLE1BSXhCQyw4QkFKd0I7O0FBQUEsOEJBS3VCLHFDQUx2QjtBQUFBO0FBQUE7O0FBQUEsK0RBS2lCLEVBTGpCO0FBQUEsTUFLeEJDLGlCQUx3QiwwQkFLeEJBLGlCQUx3QjtBQUFBLE1BS0xDLGlCQUxLLDBCQUtMQSxpQkFMSzs7QUFBQSx1QkFNWiw4QkFOWTtBQUFBO0FBQUEsTUFNMUJDLFVBTjBCOztBQUFBLHlCQU9WLGdDQVBVO0FBQUE7QUFBQSxNQU8xQkMsWUFQMEI7O0FBQUEscUJBUWQsNEJBUmM7QUFBQTtBQUFBLE1BUTFCQyxRQVIwQjs7QUFBQSw4QkFTSCxzQ0FURztBQUFBO0FBQUEsTUFTMUJDLG1CQVQwQjs7QUFBQSxxQkFVUiwyQkFBWSxRQUFaLENBVlE7QUFBQTtBQUFBLE1BVTFCQyxjQVYwQjs7QUFXakMsTUFBTUMsbUJBQW1CLEdBQUcsc0NBQTVCO0FBQ0EsTUFBTUMsZUFBZSxHQUFHLGtDQUF4QjtBQUNBLE1BQU1DLFdBQVcsR0FBRyw4QkFBcEI7QUFDQSxNQUFNQyxhQUFhLEdBQUcsZ0NBQXRCO0FBRUEsTUFBTUMscUJBQXFCLEdBQUcsb0JBQVE7QUFBQSxXQUFNVCxVQUFVLENBQUNVLE1BQVgsQ0FBa0I7QUFBQSxvQ0FBR0MsV0FBSDtBQUFBLHlEQUE0QixFQUE1QjtBQUFBLFVBQWtCQyxLQUFsQixxQkFBa0JBLEtBQWxCO0FBQUEsYUFBcUNBLEtBQXJDO0FBQUEsS0FBbEIsRUFBOERDLE1BQXBFO0FBQUEsR0FBUixFQUFvRixDQUNoSGIsVUFEZ0gsQ0FBcEYsQ0FBOUI7QUFJQSxNQUFNYyxhQUFhLEdBQUcsd0JBQ3BCLGlCQUFpRDtBQUFBLDZCQUE5Q0MsTUFBOEM7QUFBQSw2Q0FBVCxFQUFTO0FBQUEsUUFBcENDLFVBQW9DLGdCQUFwQ0EsVUFBb0M7QUFBQSxRQUF4QkMsVUFBd0IsZ0JBQXhCQSxVQUF3Qjs7QUFDL0MsUUFBSWhCLFlBQVksS0FBS1osU0FBakIsSUFBOEJZLFlBQVksS0FBS1YsUUFBbkQsRUFBNkQ7QUFDM0RJLE1BQUFBLGtCQUFrQixDQUFDLEVBQUQsQ0FBbEI7QUFDQVcsTUFBQUEsZUFBZSxDQUFDaEIsSUFBRCxDQUFmO0FBQ0FpQixNQUFBQSxXQUFXOztBQUVYLFVBQUlVLFVBQUosRUFBZ0I7QUFDZHJCLFFBQUFBLFVBQVUsQ0FBQ3FCLFVBQUQsQ0FBVjtBQUNBVCxRQUFBQSxhQUFhLENBQUMsUUFBRCxFQUFXO0FBQUVHLFVBQUFBLFdBQVcsRUFBRTtBQUFFTyxZQUFBQSxNQUFNLEVBQUU7QUFBRUMsY0FBQUEsWUFBWSxFQUFFLENBQUM7QUFBRUgsZ0JBQUFBLFVBQVUsRUFBVkEsVUFBRjtBQUFjQyxnQkFBQUEsVUFBVSxFQUFWQTtBQUFkLGVBQUQ7QUFBaEI7QUFBVjtBQUFmLFNBQVgsQ0FBYjtBQUNBcEIsUUFBQUEsOEJBQThCLENBQUMsSUFBRCxDQUE5QjtBQUNEO0FBQ0Y7QUFDRixHQWJtQixFQWNwQixDQUNFSSxZQURGLEVBRUVOLGtCQUZGLEVBR0VXLGVBSEYsRUFJRUMsV0FKRixFQUtFWCxVQUxGLEVBTUVZLGFBTkYsRUFPRVgsOEJBUEYsQ0Fkb0IsQ0FBdEI7QUF5QkEsTUFBTXVCLGVBQWUsR0FBRyx3QkFDdEIsaUJBQWlDO0FBQUEsUUFBOUJDLFNBQThCLFNBQTlCQSxTQUE4QjtBQUFBLDhCQUFuQkMsT0FBbUI7QUFBQSxRQUFuQkEsT0FBbUIsOEJBQVQsRUFBUzs7QUFDL0IsUUFBSXJCLFlBQVksS0FBS1osU0FBakIsSUFBOEJZLFlBQVksS0FBS1YsUUFBbkQsRUFBNkQ7QUFDM0QsVUFBTWdDLFFBQVEsR0FBR0QsT0FBTyxDQUFDRSxHQUFSLENBQVk7QUFBQSxZQUFHUCxVQUFILFNBQUdBLFVBQUg7QUFBQSxlQUFvQkEsVUFBcEI7QUFBQSxPQUFaLENBQWpCO0FBRUF2QixNQUFBQSxtQkFBbUIsQ0FBQzJCLFNBQUQsQ0FBbkI7QUFDQTFCLE1BQUFBLGtCQUFrQixDQUFDNEIsUUFBRCxDQUFsQjtBQUNBakIsTUFBQUEsZUFBZSxDQUFDakIsU0FBRCxDQUFmO0FBQ0FjLE1BQUFBLG1CQUFtQixJQUFJRSxtQkFBbUIsRUFBMUM7QUFDRDtBQUNGLEdBVnFCLEVBV3RCLENBQUNKLFlBQUQsRUFBZUksbUJBQWYsRUFBb0NGLG1CQUFwQyxFQUF5RFQsbUJBQXpELEVBQThFQyxrQkFBOUUsRUFBa0dXLGVBQWxHLENBWHNCLENBQXhCO0FBY0EsTUFBTW1CLFdBQVcsR0FBRyx3QkFDbEIsVUFBQUMsS0FBSyxFQUFJO0FBQ1B6QixJQUFBQSxZQUFZLEtBQUtYLElBQWpCLElBQXlCZ0IsZUFBZSxDQUFDaEIsSUFBRCxDQUF4QztBQUNBLEtBQUNXLFlBQVksS0FBS1osU0FBakIsSUFBOEJZLFlBQVksS0FBS1YsUUFBaEQsS0FBNkRnQixXQUFXLEVBQXhFO0FBRUFkLElBQUFBLE9BQU8sSUFBSUEsT0FBTyxDQUFDaUMsS0FBRCxDQUFsQjtBQUNELEdBTmlCLEVBT2xCLENBQUN6QixZQUFELEVBQWVSLE9BQWYsRUFBd0JhLGVBQXhCLEVBQXlDQyxXQUF6QyxDQVBrQixDQUFwQjtBQVVBLHNCQUNFLDZCQUFDLDRCQUFEO0FBQ0UsSUFBQSxJQUFJLEVBQUVILGNBRFI7QUFFRSxJQUFBLFNBQVMsRUFBRVUsYUFGYjtBQUdFLElBQUEsT0FBTyxFQUFFVyxXQUhYO0FBSUUsSUFBQSxVQUFVLEVBQUVMLGVBSmQ7QUFLRSxJQUFBLGlCQUFpQixFQUFFdEIsaUJBTHJCO0FBTUUsSUFBQSxpQkFBaUIsRUFBRUMsaUJBTnJCO0FBT0UsSUFBQSxPQUFPLEVBQUUsQ0FBQ0csUUFBRCxLQUFjRCxZQUFZLEtBQUtWLFFBQWpCLElBQTZCVSxZQUFZLEtBQUtaLFNBQTVELEtBQTBFLENBQUNvQjtBQVB0RixJQURGO0FBV0QsQ0FoRkQ7O0FBa0ZBakIsU0FBUyxDQUFDbUMsWUFBVixHQUF5QjtBQUN2QmxDLEVBQUFBLE9BQU8sRUFBRW1DO0FBRGMsQ0FBekI7QUFJQXBDLFNBQVMsQ0FBQ3FDLFNBQVYsR0FBc0I7QUFDcEJwQyxFQUFBQSxPQUFPLEVBQUVxQyxtQkFBVUM7QUFEQyxDQUF0QjtlQUlldkMsUyIsInNvdXJjZVJvb3QiOiJjb21wb25lbnQ6Ly8vIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9zZXIgYXMgRGljdGF0ZUNvbXBvc2VyIH0gZnJvbSAncmVhY3QtZGljdGF0ZS1idXR0b24nO1xuaW1wb3J0IHsgQ29uc3RhbnRzIH0gZnJvbSAnYm90ZnJhbWV3b3JrLXdlYmNoYXQtY29yZSc7XG5pbXBvcnQgUHJvcFR5cGVzIGZyb20gJ3Byb3AtdHlwZXMnO1xuaW1wb3J0IFJlYWN0LCB7IHVzZUNhbGxiYWNrLCB1c2VNZW1vIH0gZnJvbSAncmVhY3QnO1xuXG5pbXBvcnQgdXNlQWN0aXZpdGllcyBmcm9tICcuL2hvb2tzL3VzZUFjdGl2aXRpZXMnO1xuaW1wb3J0IHVzZURpY3RhdGVJbnRlcmltcyBmcm9tICcuL2hvb2tzL3VzZURpY3RhdGVJbnRlcmltcyc7XG5pbXBvcnQgdXNlRGljdGF0ZVN0YXRlIGZyb20gJy4vaG9va3MvdXNlRGljdGF0ZVN0YXRlJztcbmltcG9ydCB1c2VEaXNhYmxlZCBmcm9tICcuL2hvb2tzL3VzZURpc2FibGVkJztcbmltcG9ydCB1c2VFbWl0VHlwaW5nSW5kaWNhdG9yIGZyb20gJy4vaG9va3MvdXNlRW1pdFR5cGluZ0luZGljYXRvcic7XG5pbXBvcnQgdXNlTGFuZ3VhZ2UgZnJvbSAnLi9ob29rcy91c2VMYW5ndWFnZSc7XG5pbXBvcnQgdXNlU2VuZEJveFZhbHVlIGZyb20gJy4vaG9va3MvdXNlU2VuZEJveFZhbHVlJztcbmltcG9ydCB1c2VTZW5kVHlwaW5nSW5kaWNhdG9yIGZyb20gJy4vaG9va3MvdXNlU2VuZFR5cGluZ0luZGljYXRvcic7XG5pbXBvcnQgdXNlU2V0RGljdGF0ZVN0YXRlIGZyb20gJy4vaG9va3MvaW50ZXJuYWwvdXNlU2V0RGljdGF0ZVN0YXRlJztcbmltcG9ydCB1c2VTZXR0YWJsZURpY3RhdGVBYm9ydGFibGUgZnJvbSAnLi9ob29rcy9pbnRlcm5hbC91c2VTZXR0YWJsZURpY3RhdGVBYm9ydGFibGUnO1xuaW1wb3J0IHVzZVNob3VsZFNwZWFrSW5jb21pbmdBY3Rpdml0eSBmcm9tICcuL2hvb2tzL3VzZVNob3VsZFNwZWFrSW5jb21pbmdBY3Rpdml0eSc7XG5pbXBvcnQgdXNlU3RvcERpY3RhdGUgZnJvbSAnLi9ob29rcy91c2VTdG9wRGljdGF0ZSc7XG5pbXBvcnQgdXNlU3VibWl0U2VuZEJveCBmcm9tICcuL2hvb2tzL3VzZVN1Ym1pdFNlbmRCb3gnO1xuaW1wb3J0IHVzZVdlYlNwZWVjaFBvbnlmaWxsIGZyb20gJy4vaG9va3MvdXNlV2ViU3BlZWNoUG9ueWZpbGwnO1xuXG5jb25zdCB7XG4gIERpY3RhdGVTdGF0ZTogeyBESUNUQVRJTkcsIElETEUsIFNUQVJUSU5HIH1cbn0gPSBDb25zdGFudHM7XG5cbmNvbnN0IERpY3RhdGlvbiA9ICh7IG9uRXJyb3IgfSkgPT4ge1xuICBjb25zdCBbLCBzZXREaWN0YXRlQWJvcnRhYmxlXSA9IHVzZVNldHRhYmxlRGljdGF0ZUFib3J0YWJsZSgpO1xuICBjb25zdCBbLCBzZXREaWN0YXRlSW50ZXJpbXNdID0gdXNlRGljdGF0ZUludGVyaW1zKCk7XG4gIGNvbnN0IFssIHNldFNlbmRCb3hdID0gdXNlU2VuZEJveFZhbHVlKCk7XG4gIGNvbnN0IFssIHNldFNob3VsZFNwZWFrSW5jb21pbmdBY3Rpdml0eV0gPSB1c2VTaG91bGRTcGVha0luY29taW5nQWN0aXZpdHkoKTtcbiAgY29uc3QgW3sgU3BlZWNoR3JhbW1hckxpc3QsIFNwZWVjaFJlY29nbml0aW9uIH0gPSB7fV0gPSB1c2VXZWJTcGVlY2hQb255ZmlsbCgpO1xuICBjb25zdCBbYWN0aXZpdGllc10gPSB1c2VBY3Rpdml0aWVzKCk7XG4gIGNvbnN0IFtkaWN0YXRlU3RhdGVdID0gdXNlRGljdGF0ZVN0YXRlKCk7XG4gIGNvbnN0IFtkaXNhYmxlZF0gPSB1c2VEaXNhYmxlZCgpO1xuICBjb25zdCBbc2VuZFR5cGluZ0luZGljYXRvcl0gPSB1c2VTZW5kVHlwaW5nSW5kaWNhdG9yKCk7XG4gIGNvbnN0IFtzcGVlY2hMYW5ndWFnZV0gPSB1c2VMYW5ndWFnZSgnc3BlZWNoJyk7XG4gIGNvbnN0IGVtaXRUeXBpbmdJbmRpY2F0b3IgPSB1c2VFbWl0VHlwaW5nSW5kaWNhdG9yKCk7XG4gIGNvbnN0IHNldERpY3RhdGVTdGF0ZSA9IHVzZVNldERpY3RhdGVTdGF0ZSgpO1xuICBjb25zdCBzdG9wRGljdGF0ZSA9IHVzZVN0b3BEaWN0YXRlKCk7XG4gIGNvbnN0IHN1Ym1pdFNlbmRCb3ggPSB1c2VTdWJtaXRTZW5kQm94KCk7XG5cbiAgY29uc3QgbnVtU3BlYWtpbmdBY3Rpdml0aWVzID0gdXNlTWVtbygoKSA9PiBhY3Rpdml0aWVzLmZpbHRlcigoeyBjaGFubmVsRGF0YTogeyBzcGVhayB9ID0ge30gfSkgPT4gc3BlYWspLmxlbmd0aCwgW1xuICAgIGFjdGl2aXRpZXNcbiAgXSk7XG5cbiAgY29uc3QgaGFuZGxlRGljdGF0ZSA9IHVzZUNhbGxiYWNrKFxuICAgICh7IHJlc3VsdDogeyBjb25maWRlbmNlLCB0cmFuc2NyaXB0IH0gPSB7fSB9KSA9PiB7XG4gICAgICBpZiAoZGljdGF0ZVN0YXRlID09PSBESUNUQVRJTkcgfHwgZGljdGF0ZVN0YXRlID09PSBTVEFSVElORykge1xuICAgICAgICBzZXREaWN0YXRlSW50ZXJpbXMoW10pO1xuICAgICAgICBzZXREaWN0YXRlU3RhdGUoSURMRSk7XG4gICAgICAgIHN0b3BEaWN0YXRlKCk7XG5cbiAgICAgICAgaWYgKHRyYW5zY3JpcHQpIHtcbiAgICAgICAgICBzZXRTZW5kQm94KHRyYW5zY3JpcHQpO1xuICAgICAgICAgIHN1Ym1pdFNlbmRCb3goJ3NwZWVjaCcsIHsgY2hhbm5lbERhdGE6IHsgc3BlZWNoOiB7IGFsdGVybmF0aXZlczogW3sgY29uZmlkZW5jZSwgdHJhbnNjcmlwdCB9XSB9IH0gfSk7XG4gICAgICAgICAgc2V0U2hvdWxkU3BlYWtJbmNvbWluZ0FjdGl2aXR5KHRydWUpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSxcbiAgICBbXG4gICAgICBkaWN0YXRlU3RhdGUsXG4gICAgICBzZXREaWN0YXRlSW50ZXJpbXMsXG4gICAgICBzZXREaWN0YXRlU3RhdGUsXG4gICAgICBzdG9wRGljdGF0ZSxcbiAgICAgIHNldFNlbmRCb3gsXG4gICAgICBzdWJtaXRTZW5kQm94LFxuICAgICAgc2V0U2hvdWxkU3BlYWtJbmNvbWluZ0FjdGl2aXR5XG4gICAgXVxuICApO1xuXG4gIGNvbnN0IGhhbmRsZURpY3RhdGluZyA9IHVzZUNhbGxiYWNrKFxuICAgICh7IGFib3J0YWJsZSwgcmVzdWx0cyA9IFtdIH0pID0+IHtcbiAgICAgIGlmIChkaWN0YXRlU3RhdGUgPT09IERJQ1RBVElORyB8fCBkaWN0YXRlU3RhdGUgPT09IFNUQVJUSU5HKSB7XG4gICAgICAgIGNvbnN0IGludGVyaW1zID0gcmVzdWx0cy5tYXAoKHsgdHJhbnNjcmlwdCB9KSA9PiB0cmFuc2NyaXB0KTtcblxuICAgICAgICBzZXREaWN0YXRlQWJvcnRhYmxlKGFib3J0YWJsZSk7XG4gICAgICAgIHNldERpY3RhdGVJbnRlcmltcyhpbnRlcmltcyk7XG4gICAgICAgIHNldERpY3RhdGVTdGF0ZShESUNUQVRJTkcpO1xuICAgICAgICBzZW5kVHlwaW5nSW5kaWNhdG9yICYmIGVtaXRUeXBpbmdJbmRpY2F0b3IoKTtcbiAgICAgIH1cbiAgICB9LFxuICAgIFtkaWN0YXRlU3RhdGUsIGVtaXRUeXBpbmdJbmRpY2F0b3IsIHNlbmRUeXBpbmdJbmRpY2F0b3IsIHNldERpY3RhdGVBYm9ydGFibGUsIHNldERpY3RhdGVJbnRlcmltcywgc2V0RGljdGF0ZVN0YXRlXVxuICApO1xuXG4gIGNvbnN0IGhhbmRsZUVycm9yID0gdXNlQ2FsbGJhY2soXG4gICAgZXZlbnQgPT4ge1xuICAgICAgZGljdGF0ZVN0YXRlICE9PSBJRExFICYmIHNldERpY3RhdGVTdGF0ZShJRExFKTtcbiAgICAgIChkaWN0YXRlU3RhdGUgPT09IERJQ1RBVElORyB8fCBkaWN0YXRlU3RhdGUgPT09IFNUQVJUSU5HKSAmJiBzdG9wRGljdGF0ZSgpO1xuXG4gICAgICBvbkVycm9yICYmIG9uRXJyb3IoZXZlbnQpO1xuICAgIH0sXG4gICAgW2RpY3RhdGVTdGF0ZSwgb25FcnJvciwgc2V0RGljdGF0ZVN0YXRlLCBzdG9wRGljdGF0ZV1cbiAgKTtcblxuICByZXR1cm4gKFxuICAgIDxEaWN0YXRlQ29tcG9zZXJcbiAgICAgIGxhbmc9e3NwZWVjaExhbmd1YWdlfVxuICAgICAgb25EaWN0YXRlPXtoYW5kbGVEaWN0YXRlfVxuICAgICAgb25FcnJvcj17aGFuZGxlRXJyb3J9XG4gICAgICBvblByb2dyZXNzPXtoYW5kbGVEaWN0YXRpbmd9XG4gICAgICBzcGVlY2hHcmFtbWFyTGlzdD17U3BlZWNoR3JhbW1hckxpc3R9XG4gICAgICBzcGVlY2hSZWNvZ25pdGlvbj17U3BlZWNoUmVjb2duaXRpb259XG4gICAgICBzdGFydGVkPXshZGlzYWJsZWQgJiYgKGRpY3RhdGVTdGF0ZSA9PT0gU1RBUlRJTkcgfHwgZGljdGF0ZVN0YXRlID09PSBESUNUQVRJTkcpICYmICFudW1TcGVha2luZ0FjdGl2aXRpZXN9XG4gICAgLz5cbiAgKTtcbn07XG5cbkRpY3RhdGlvbi5kZWZhdWx0UHJvcHMgPSB7XG4gIG9uRXJyb3I6IHVuZGVmaW5lZFxufTtcblxuRGljdGF0aW9uLnByb3BUeXBlcyA9IHtcbiAgb25FcnJvcjogUHJvcFR5cGVzLmZ1bmNcbn07XG5cbmV4cG9ydCBkZWZhdWx0IERpY3RhdGlvbjtcbiJdfQ==