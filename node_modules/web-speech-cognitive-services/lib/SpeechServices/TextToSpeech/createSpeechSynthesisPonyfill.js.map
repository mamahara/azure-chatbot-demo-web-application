{"version":3,"sources":["../../../src/SpeechServices/TextToSpeech/createSpeechSynthesisPonyfill.js"],"names":["DEFAULT_OUTPUT_FORMAT","EMPTY_ARRAY","options","audioContext","fetchCredentials","ponyfill","AudioContext","window","webkitAudioContext","speechSynthesisDeploymentId","speechSynthesisOutputFormat","console","warn","SpeechSynthesis","queue","AudioContextQueue","updateVoices","stop","pause","resume","utterance","SpeechSynthesisUtterance","Error","reject","resolve","promise","handleError","errorCode","error","message","stack","addEventListener","preload","deploymentId","outputFormat","push","finally","removeEventListener","customVoiceHostname","region","speechSynthesisHostname","subscriptionKey","voices","getVoices","fetchVoices","dispatchEvent","SpeechSynthesisEvent","speaking","EventTarget","prototype","speechSynthesis"],"mappings":"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","sourcesContent":["/* eslint class-methods-use-this: 0 */\n\nimport { defineEventAttribute, EventTarget } from 'event-target-shim-es5';\nimport createDeferred from 'p-defer-es5';\nimport onErrorResumeNext from 'on-error-resume-next';\n\nimport AudioContextQueue from './AudioContextQueue';\nimport fetchCustomVoices from './fetchCustomVoices';\nimport fetchVoices from './fetchVoices';\nimport patchOptions from '../patchOptions';\nimport SpeechSynthesisEvent from './SpeechSynthesisEvent';\nimport SpeechSynthesisUtterance from './SpeechSynthesisUtterance';\n\n// Supported output format can be found at https://docs.microsoft.com/en-us/azure/cognitive-services/speech-service/rest-text-to-speech#audio-outputs\nconst DEFAULT_OUTPUT_FORMAT = 'audio-24khz-160kbitrate-mono-mp3';\nconst EMPTY_ARRAY = [];\n\nexport default options => {\n  const {\n    audioContext,\n    fetchCredentials,\n    ponyfill = {\n      AudioContext: window.AudioContext || window.webkitAudioContext\n    },\n    speechSynthesisDeploymentId,\n    speechSynthesisOutputFormat = DEFAULT_OUTPUT_FORMAT\n  } = patchOptions(options);\n\n  if (!audioContext && !ponyfill.AudioContext) {\n    console.warn(\n      'web-speech-cognitive-services: This browser does not support Web Audio and it will not work with Cognitive Services Speech Services.'\n    );\n\n    return {};\n  }\n\n  class SpeechSynthesis extends EventTarget {\n    constructor() {\n      super();\n\n      this.queue = new AudioContextQueue({ audioContext, ponyfill });\n\n      this.updateVoices();\n    }\n\n    cancel() {\n      this.queue.stop();\n    }\n\n    getVoices() {\n      return EMPTY_ARRAY;\n    }\n\n    pause() {\n      this.queue.pause();\n    }\n\n    resume() {\n      this.queue.resume();\n    }\n\n    speak(utterance) {\n      if (!(utterance instanceof SpeechSynthesisUtterance)) {\n        throw new Error('invalid utterance');\n      }\n\n      const { reject, resolve, promise } = createDeferred();\n      const handleError = ({ error: errorCode, message }) => {\n        const error = new Error(errorCode);\n\n        error.stack = message;\n\n        reject(error);\n      };\n\n      utterance.addEventListener('end', resolve);\n      utterance.addEventListener('error', handleError);\n\n      utterance.preload({\n        deploymentId: speechSynthesisDeploymentId,\n        fetchCredentials,\n        outputFormat: speechSynthesisOutputFormat\n      });\n\n      this.queue.push(utterance);\n\n      return promise.finally(() => {\n        utterance.removeEventListener('end', resolve);\n        utterance.removeEventListener('error', handleError);\n      });\n    }\n\n    get speaking() {\n      return this.queue.speaking;\n    }\n\n    async updateVoices() {\n      const { customVoiceHostname, region, speechSynthesisHostname, subscriptionKey } = await fetchCredentials();\n\n      if (speechSynthesisDeploymentId) {\n        if (subscriptionKey) {\n          console.warn(\n            'web-speech-cognitive-services: Listing of custom voice models are only available when using subscription key.'\n          );\n\n          await onErrorResumeNext(async () => {\n            const voices = await fetchCustomVoices({\n              customVoiceHostname,\n              deploymentId: speechSynthesisDeploymentId,\n              region,\n              speechSynthesisHostname,\n              subscriptionKey\n            });\n\n            this.getVoices = () => voices;\n          });\n        }\n      } else {\n        // If fetch voice list failed, we will not emit \"voiceschanged\" event.\n        // In the spec, there is no \"error\" event.\n\n        await onErrorResumeNext(async () => {\n          const voices = await fetchVoices(await fetchCredentials());\n\n          this.getVoices = () => voices;\n        });\n      }\n\n      this.dispatchEvent(new SpeechSynthesisEvent('voiceschanged'));\n    }\n  }\n\n  defineEventAttribute(SpeechSynthesis.prototype, 'voiceschanged');\n\n  return {\n    speechSynthesis: new SpeechSynthesis(),\n    SpeechSynthesisEvent,\n    SpeechSynthesisUtterance\n  };\n};\n"],"file":"createSpeechSynthesisPonyfill.js"}